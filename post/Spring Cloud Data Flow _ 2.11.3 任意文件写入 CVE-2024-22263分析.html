<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Spring Cloud Skipper _ 2.11.3 任意文件写入 CVE-2024-22263分析 | stoocea's blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"复制"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('/img/pc-bg.jpg');
 --light-background: url('/img/bk.jpg');
 --theme-encrypt-confirm: '确认'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>Spring Cloud Skipper _ 2.11.3 任意文件写入 CVE-2024-22263分析</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2024-08-06T07:41:00.000Z" id="date"> 2024-08-06</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2024-08-26T11:38:10.254Z" id="updated"> 2024-08-26</time></div></span></div></div><hr><div id="post-content"><h1 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h1><p>Spring Cloud Data Flow（SCDF）是一个基于微服务的工具包，用于在 Cloud Foundry 和 Kubernetes 中构建流式和批量数据处理管道。SCDF中一个核心组件Spring Cloud Skipper负责处理应用程序的部署、升级和回滚等操作。<br>在受影响版本中，Skipper Server在接收上传请求时对zip文件中的路径校验不严，具有 Skipper Server API 访问权限的攻击者可以通过上传请求将任意文件写入文件系统中的任意位置，从而获得服务器权限。</p>
<h1 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h1><p>org.springframework.cloud:spring-cloud-skipper-server-core@[2.10.0, 2.11.3)</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>沟槽的环境搭建，沟槽的 docker。最近国内的 docker 被墙了，之前一直都用的是 linux 系统下的 docker 搭建，这次试试 windows 的直接来<br>总共 3 个镜像，其实漏洞点是在 springcloud-skiperserver，所以注意 skiper 的版本就行，dataflow 版本我们为了不出啥差错也选择 2.11.2 版本，从其他师傅手里拿到了一份 yaml 文件，应该是官方上的 yaml 文件？</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">dataflow-server:</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">springcloud/spring-cloud-dataflow-server:$&#123;DATAFLOW_VERSION:-2.11.2-SNAPSHOT&#125;$&#123;BP_JVM_VERSION:-&#125;</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">dataflow-server</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9393:9393&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">LANG=en_US.utf8</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">LC_ALL=en_US.utf8</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">JDK_JAVA_OPTIONS=-Dfile.encoding=UTF-8</span> <span class="hljs-string">-Dsun.jnu.encoding=UTF-8</span><br>      <span class="hljs-comment"># Set CLOSECONTEXTENABLED=true to ensure that the CRT launcher is closed.</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_CLOUD_DATAFLOW_APPLICATIONPROPERTIES_TASK_SPRING_CLOUD_TASK_CLOSECONTEXTENABLED=true</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_CLOUD_SKIPPER_CLIENT_SERVER_URI=$&#123;SKIPPER_URI:-http://skipper-server:7577&#125;/api</span><br>      <span class="hljs-comment"># (Optionally) authenticate the default Docker Hub access for the App Metadata access.</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_CLOUD_DATAFLOW_CONTAINER_REGISTRY_CONFIGURATIONS_DEFAULT_USER=$&#123;METADATA_DEFAULT_DOCKERHUB_USER&#125;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_CLOUD_DATAFLOW_CONTAINER_REGISTRY_CONFIGURATIONS_DEFAULT_SECRET=$&#123;METADATA_DEFAULT_DOCKERHUB_PASSWORD&#125;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_CLOUD_DATAFLOW_CONTAINER_REGISTRYCONFIGURATIONS_DEFAULT_USER=$&#123;METADATA_DEFAULT_DOCKERHUB_USER&#125;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_CLOUD_DATAFLOW_CONTAINER_REGISTRYCONFIGURATIONS_DEFAULT_SECRET=$&#123;METADATA_DEFAULT_DOCKERHUB_PASSWORD&#125;</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">skipper-server</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">$&#123;HOST_MOUNT_PATH:-.&#125;:$&#123;DOCKER_MOUNT_PATH:-/home/cnb/scdf&#125;</span><br><br>  <span class="hljs-attr">app-import-stream:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">springcloud/baseimage:1.0.4</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">dataflow-app-import-stream</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">dataflow-server</span><br><br>  <span class="hljs-attr">app-import-task:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">springcloud/baseimage:1.0.4</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">dataflow-app-import-task</span><br>    <span class="hljs-attr">depends_on:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">dataflow-server</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">&gt;</span><br><span class="hljs-string">      /bin/sh -c &quot;</span><br><span class="hljs-string">        ./wait-for-it.sh -t 360 dataflow-server:9393;</span><br><span class="hljs-string">        wget -qO- &#x27;$&#123;DATAFLOW_URI:-http://dataflow-server:9393&#125;/apps&#x27; --no-check-certificate --post-data=&#x27;uri=$&#123;TASK_APPS_URI:-https://dataflow.spring.io/task-maven-latest&amp;force=true&#125;&#x27;;</span><br><span class="hljs-string">        wget -qO- &#x27;$&#123;DATAFLOW_URI:-http://dataflow-server:9393&#125;/apps/timestamp3&#x27; --no-check-certificate --post-data=&#x27;bootVersion=3&amp;uri=maven://uri=maven:io.spring:timestamp-task:3.0.0&#x27;;</span><br><span class="hljs-string">        wget -qO- &#x27;$&#123;DATAFLOW_URI:-http://dataflow-server:9393&#125;/apps/timestamp-batch3&#x27; --no-check-certificate --post-data=&#x27;bootVersion=3&amp;uri=maven://uri=maven:io.spring:timestamp-batch:3.0.0&#x27;;</span><br><span class="hljs-string">        echo &#x27;Maven Task apps imported&#x27;&quot;</span><br><span class="hljs-string"></span><br>  <span class="hljs-attr">skipper-server:</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">springcloud/spring-cloud-skipper-server:$&#123;SKIPPER_VERSION:-2.11.2-SNAPSHOT&#125;$&#123;BP_JVM_VERSION:-&#125;</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">skipper-server</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;7577:7577&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">$&#123;APPS_PORT_RANGE:-20000-20195:20000-20195&#125;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;5005:5005&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">LANG=en_US.utf8</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">LC_ALL=en_US.utf8</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">JDK_JAVA_OPTIONS=-Dfile.encoding=UTF-8</span> <span class="hljs-string">-Dsun.jnu.encoding=UTF-8</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SERVER_PORT=7577</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_CLOUD_SKIPPER_SERVER_PLATFORM_LOCAL_ACCOUNTS_DEFAULT_PORTRANGE_LOW=20000</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_CLOUD_SKIPPER_SERVER_PLATFORM_LOCAL_ACCOUNTS_DEFAULT_PORTRANGE_HIGH=20190</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_CLOUD_SKIPPER_SERVER_DEPLOYER=ERROR</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">JAVA_OPTS=&quot;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005&quot;</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">$&#123;HOST_MOUNT_PATH:-.&#125;:$&#123;DOCKER_MOUNT_PATH:-/home/cnb/scdf&#125;</span><br><br></code></pre></td></tr></table></figure>

<p>直接 <code>docker-compose up -d</code>(这里开 5005 端口是为了远程调试)<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718673503636-db6d5e4a-d03b-45ae-b581-33ad64423621.png#averageHue=%23131c25&clientId=ueb531519-2954-4&from=paste&height=730&id=uf7f709c0&originHeight=1368&originWidth=2560&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=179493&status=done&style=none&taskId=u0cbde22a-a156-404a-bd4f-805143d1a69&title=&width=1365.3333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718673503636-db6d5e4a-d03b-45ae-b581-33ad64423621.png#averageHue=%23131c25&clientId=ueb531519-2954-4&from=paste&height=730&id=uf7f709c0&originHeight=1368&originWidth=2560&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=179493&status=done&style=none&taskId=u0cbde22a-a156-404a-bd4f-805143d1a69&title=&width=1365.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br>然后访问 7577 端口和9393 端口<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718693182543-4df0b13b-9bd3-44ac-b4ce-1d95cf8cb5fc.png#averageHue=%2317191c&clientId=ueb531519-2954-4&from=paste&height=450&id=ue3fe2ab9&originHeight=843&originWidth=2559&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=106234&status=done&style=none&taskId=uc08351a0-ee5e-4c1d-85e3-c6d7b293645&title=&width=1364.8'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718693182543-4df0b13b-9bd3-44ac-b4ce-1d95cf8cb5fc.png#averageHue=%2317191c&clientId=ueb531519-2954-4&from=paste&height=450&id=ue3fe2ab9&originHeight=843&originWidth=2559&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=106234&status=done&style=none&taskId=uc08351a0-ee5e-4c1d-85e3-c6d7b293645&title=&width=1364.8" referrerpolicy="no-referrer" alt="image.png"><br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718693204372-2dd47c2d-69d3-45fa-ae45-b58ee2103869.png#averageHue=%23203039&clientId=ueb531519-2954-4&from=paste&height=622&id=u854ea09d&originHeight=1166&originWidth=2554&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=159093&status=done&style=none&taskId=u7c6231b2-83fd-4e86-a3b5-7d6c71c211d&title=&width=1362.1333333333334'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718693204372-2dd47c2d-69d3-45fa-ae45-b58ee2103869.png#averageHue=%23203039&clientId=ueb531519-2954-4&from=paste&height=622&id=u854ea09d&originHeight=1166&originWidth=2554&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=159093&status=done&style=none&taskId=u7c6231b2-83fd-4e86-a3b5-7d6c71c211d&title=&width=1362.1333333333334" referrerpolicy="no-referrer" alt="image.png"><br>环境就搭建的差不多了，这里我们开始分析源码</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="漏洞版本源码解析"><a href="#漏洞版本源码解析" class="headerlink" title="漏洞版本源码解析"></a>漏洞版本源码解析</h2><p><a target="_blank" rel="noopener" href="https://github.com/spring-cloud/spring-cloud-dataflow/commit/2ac9bfa5c2f7cdcc86938ce036283a37008add31">https://github.com/spring-cloud/spring-cloud-dataflow/commit/2ac9bfa5c2f7cdcc86938ce036283a37008a</a><br>具体的漏洞点是在 PackageService 的 upload 方法，我们先看更新之前的 upload 方法的内容,前段部分内容<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718773826411-ea5d5b43-719e-4563-90c7-2068d789932c.png#averageHue=%23333839&clientId=u5796c58d-5547-4&from=paste&height=76&id=u6deb8fc0&originHeight=142&originWidth=1430&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=47901&status=done&style=none&taskId=ua3f2a4f1-6f0d-4a18-adee-521b5c7a3ec&title=&width=762.6666666666666'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718773826411-ea5d5b43-719e-4563-90c7-2068d789932c.png#averageHue=%23333839&clientId=u5796c58d-5547-4&from=paste&height=76&id=u6deb8fc0&originHeight=142&originWidth=1430&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=47901&status=done&style=none&taskId=ua3f2a4f1-6f0d-4a18-adee-521b5c7a3ec&title=&width=762.6666666666666" referrerpolicy="no-referrer" alt="image.png"><br>首先第一个方法是validateUploadRequest 方法来处理我们的请求，这里跟进validateUploadRequest<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718771729633-1e082ed2-40b2-4200-9211-89e3cee94906.png#averageHue=%23292b2d&clientId=u5796c58d-5547-4&from=paste&height=443&id=u30827ad9&originHeight=830&originWidth=1888&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=401640&status=done&style=none&taskId=u992206a3-5d5e-4c81-aa32-009367497db&title=&width=1006.9333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718771729633-1e082ed2-40b2-4200-9211-89e3cee94906.png#averageHue=%23292b2d&clientId=u5796c58d-5547-4&from=paste&height=443&id=u30827ad9&originHeight=830&originWidth=1888&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=401640&status=done&style=none&taskId=u992206a3-5d5e-4c81-aa32-009367497db&title=&width=1006.9333333333333" referrerpolicy="no-referrer" alt="image.png"><br>大致逻辑如下：</p>
<ul>
<li>name，reponame，version，以及 extension 不能为空</li>
<li>后缀必须为 zip 后缀</li>
<li>并且 package 的 bytes 不能为空</li>
</ul>
<p>其实就是对应了UploadRequest 中的参数<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718772350642-e5573059-c8a3-474f-aa4c-3ec5e24dc5d6.png#averageHue=%23262728&clientId=u5796c58d-5547-4&from=paste&height=325&id=u3bc790cc&originHeight=609&originWidth=808&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=84211&status=done&style=none&taskId=u52987cc9-d9d1-46eb-aaf6-27a0fad1523&title=&width=430.93333333333334'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718772350642-e5573059-c8a3-474f-aa4c-3ec5e24dc5d6.png#averageHue=%23262728&clientId=u5796c58d-5547-4&from=paste&height=325&id=u3bc790cc&originHeight=609&originWidth=808&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=84211&status=done&style=none&taskId=u52987cc9-d9d1-46eb-aaf6-27a0fad1523&title=&width=430.93333333333334" referrerpolicy="no-referrer" alt="image.png"><br>具体传参的话，我们往上寻找一级调用到 packageController 的 upload 路由处理，requestBody 注解对应 UploadRequest，所以我们要用 JSON 形式进行传参<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718773241908-ac22687a-d8ca-4791-b722-ae9cf22c7cc0.png#averageHue=%232c2e31&clientId=u5796c58d-5547-4&from=paste&height=139&id=uccdb44f8&originHeight=261&originWidth=1761&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=131162&status=done&style=none&taskId=ue726fdf6-510f-4c0a-b539-037ae265da7&title=&width=939.2'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718773241908-ac22687a-d8ca-4791-b722-ae9cf22c7cc0.png#averageHue=%232c2e31&clientId=u5796c58d-5547-4&from=paste&height=139&id=uccdb44f8&originHeight=261&originWidth=1761&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=131162&status=done&style=none&taskId=ue726fdf6-510f-4c0a-b539-037ae265da7&title=&width=939.2" referrerpolicy="no-referrer" alt="image.png"><br>稍微注意一点就是 <code>version</code> 变量对应的值应该为我们当前 skiper 服务的版本。<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718774563367-425c3efc-a38a-43a5-a421-66547c82abe2.png#averageHue=%23ebeff4&clientId=u5796c58d-5547-4&from=paste&height=332&id=ua0bde629&originHeight=622&originWidth=1019&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=90696&status=done&style=none&taskId=uc63f8197-8108-43e3-859a-e4a542c4193&title=&width=543.4666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718774563367-425c3efc-a38a-43a5-a421-66547c82abe2.png#averageHue=%23ebeff4&clientId=u5796c58d-5547-4&from=paste&height=332&id=ua0bde629&originHeight=622&originWidth=1019&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=90696&status=done&style=none&taskId=uc63f8197-8108-43e3-859a-e4a542c4193&title=&width=543.4666666666667" referrerpolicy="no-referrer" alt="image.png"><br>假设这里我们所有值都传好了，进入后续逻辑：<br>通过 reponame 来创建<code>localRepositoryToUpload</code>变量，并且初始化好<code>packageDirPath</code>变量<br>但是如果你进行调试的话会找到具体在 localRepositoryToUpload 的创建过程会报错<br>也就是下面这段逻辑<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718779034108-5706cdb9-7bc3-41a5-ac11-1b6ec8700f5e.png#averageHue=%232a3037&clientId=u012f7d3d-872b-4&from=paste&height=222&id=u3d06c3ad&originHeight=417&originWidth=1712&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=185591&status=done&style=none&taskId=u7c8c273a-8879-4428-82ae-ff436a06cd8&title=&width=913.0666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718779034108-5706cdb9-7bc3-41a5-ac11-1b6ec8700f5e.png#averageHue=%232a3037&clientId=u012f7d3d-872b-4&from=paste&height=222&id=u3d06c3ad&originHeight=417&originWidth=1712&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=185591&status=done&style=none&taskId=u7c8c273a-8879-4428-82ae-ff436a06cd8&title=&width=913.0666666666667" referrerpolicy="no-referrer" alt="image.png"><br>具体的话，其实这里的意思就是在本地或者远程通过 reponame 找到对应的 repository 仓库，如果没有的话就不能进行后续的上传的逻辑了。那这里就应该想到，在本地的话其实是存在一个默认的 repository 仓库的，我们回到对应的 api 目录，可以看到有 repositories<br>名称为：local，具体内容如下<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718779119412-507cc681-7198-413a-86bf-865aa69ee466.png#averageHue=%23191c21&clientId=u012f7d3d-872b-4&from=paste&height=583&id=uaf7940de&originHeight=1094&originWidth=1229&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=84223&status=done&style=none&taskId=u0a94d7cc-d601-4507-bb0a-070a9cabf12&title=&width=655.4666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718779119412-507cc681-7198-413a-86bf-865aa69ee466.png#averageHue=%23191c21&clientId=u012f7d3d-872b-4&from=paste&height=583&id=uaf7940de&originHeight=1094&originWidth=1229&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=84223&status=done&style=none&taskId=u0a94d7cc-d601-4507-bb0a-070a9cabf12&title=&width=655.4666666666667" referrerpolicy="no-referrer" alt="image.png"><br>所以我们 reponame 给到 local，就能够绕过这里的异常了<br>后续进入大段 try catch 块内容<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718773960097-1e7726fc-d1d3-4025-80d4-3edf40b299b6.png#averageHue=%232a2c2e&clientId=u5796c58d-5547-4&from=paste&height=511&id=u5ae18454&originHeight=959&originWidth=1680&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=413372&status=done&style=none&taskId=u6429b1c2-083d-47a7-8b82-dc26e0419bb&title=&width=896'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718773960097-1e7726fc-d1d3-4025-80d4-3edf40b299b6.png#averageHue=%232a2c2e&clientId=u5796c58d-5547-4&from=paste&height=511&id=u5ae18454&originHeight=959&originWidth=1680&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=413372&status=done&style=none&taskId=u6429b1c2-083d-47a7-8b82-dc26e0419bb&title=&width=896" referrerpolicy="no-referrer" alt="image.png"><br>这里的逻辑主要部分如下：</p>
<blockquote>
<p>创建一段临时目录–packageDirPath，这一段目录的内容是随机生成的，具体怎么随机的呢就不深究了。<br>开始创建 packageDir ，就是在当前临时临时目录下拼接 name 参数，创建一段 name 目录<br>然后创建 packageFile，值是在packageDir 的基础上拼接<code>name参数``/``-``version 参数``zip 后缀</code>这几部分组成临时压缩文件对象<br>最后通过 File.write 将该文件对象对应的文件内容写入，目录就是 packageFile 对应的目录<br>然后在调用 java 原生的 zip 解压对象的方法，将其解压到packageDir 目录下</p>
</blockquote>
<p>我们这里根据下面这段 JSON 的传参来具体看一下过程<br><code>&#123;&quot;name&quot;:&quot;test&quot;,&quot;repoName&quot;:&quot;local&quot;,&quot;version&quot;:&quot;1.11.2&quot;,&quot;extension&quot;:&quot;zip&quot;,&quot;packageFileAsBytes&quot;:[80]&#125;</code><br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718779432606-e79e377e-f0c9-42ac-b2b2-a6585a4c46ac.png#averageHue=%232b3036&clientId=u012f7d3d-872b-4&from=paste&height=278&id=u00035ff3&originHeight=521&originWidth=2320&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=369022&status=done&style=none&taskId=u117002aa-9a03-499a-809b-4ad7bb06d85&title=&width=1237.3333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718779432606-e79e377e-f0c9-42ac-b2b2-a6585a4c46ac.png#averageHue=%232b3036&clientId=u012f7d3d-872b-4&from=paste&height=278&id=u00035ff3&originHeight=521&originWidth=2320&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=369022&status=done&style=none&taskId=u117002aa-9a03-499a-809b-4ad7bb06d85&title=&width=1237.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br>很明显，我们能够通过控制 name 参数进行目录穿越<br>构造如下 payload：<br><code>&#123;&quot;name&quot;:&quot;../../etc&quot;,&quot;repoName&quot;:&quot;local&quot;,&quot;version&quot;:&quot;1.11.2&quot;,&quot;extension&quot;:&quot;zip&quot;,&quot;packageFileAsBytes&quot;:[80]&#125;</code><br>也是同样调试到当前 ZipUtil 的 uppack 方法，不后续跟进（因为会识别不了 Bytes 的内容为 zip 文件，无法解压而报错）<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718779761245-4da9cd10-80e4-4219-91e1-b5140dd52e33.png#averageHue=%232b3036&clientId=u012f7d3d-872b-4&from=paste&height=273&id=u6ab5c3d7&originHeight=511&originWidth=2316&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=363628&status=done&style=none&taskId=u48e5f106-b832-4d20-a428-a25996b27be&title=&width=1235.2'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718779761245-4da9cd10-80e4-4219-91e1-b5140dd52e33.png#averageHue=%232b3036&clientId=u012f7d3d-872b-4&from=paste&height=273&id=u6ab5c3d7&originHeight=511&originWidth=2316&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=363628&status=done&style=none&taskId=u48e5f106-b832-4d20-a428-a25996b27be&title=&width=1235.2" referrerpolicy="no-referrer" alt="image.png"><br>根据我们上面的逻辑分析，我们 payload 这里产生的效果说白了就两句话：</p>
<ol>
<li>根目录创建一个临时 zip 文件</li>
<li>然后将该文件解压到 &#x2F;etc 目录下</li>
</ol>
<p>可能师傅们对这个目录不太理解<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718779888081-a830e6bd-574c-4116-920e-07a459477732.png#averageHue=%233863b3&clientId=u012f7d3d-872b-4&from=paste&height=22&id=u1cb0a824&originHeight=41&originWidth=1102&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=12644&status=done&style=none&taskId=u43f83f00-a3be-44db-a06a-d9f520a00bf&title=&width=587.7333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718779888081-a830e6bd-574c-4116-920e-07a459477732.png#averageHue=%233863b3&clientId=u012f7d3d-872b-4&from=paste&height=22&id=u1cb0a824&originHeight=41&originWidth=1102&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=12644&status=done&style=none&taskId=u43f83f00-a3be-44db-a06a-d9f520a00bf&title=&width=587.7333333333333" referrerpolicy="no-referrer" alt="image.png"><br>这里其实根据相对目录，是在根目录创建了一个 etc-1.11.2.zip 文件<br>我们进容器看看当前根目录产生的效果<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718776519715-4ad09afa-8dc0-4b96-a6e3-08960c1d7618.png#averageHue=%232e373f&clientId=u6b283289-0d4f-4&from=paste&height=646&id=uf6d672eb&originHeight=1212&originWidth=2108&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=2338842&status=done&style=none&taskId=uaa104fea-2be6-4421-bd46-ce64ee16acb&title=&width=1124.2666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718776519715-4ad09afa-8dc0-4b96-a6e3-08960c1d7618.png#averageHue=%232e373f&clientId=u6b283289-0d4f-4&from=paste&height=646&id=uf6d672eb&originHeight=1212&originWidth=2108&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=2338842&status=done&style=none&taskId=uaa104fea-2be6-4421-bd46-ce64ee16acb&title=&width=1124.2666666666667" referrerpolicy="no-referrer" alt="image.png"><br>所以接下来就是将这个etc-1.11.2.zip 文件解压了，调用<code>ZipUtil.unpack(packageFile.toFile(), packageDir);</code>进行解压操作<br>upack 的第一个参数是目标文件，第二个参数是解压到的具体目录<br>所以这里就是将该etc-1.11.2.zip 文件解压到&#x2F;etc 目录，但是现在肯定是不能成功的，因为我们传入的 10 进制字节根本就不是合规的 zip 文件。</p>
<h2 id="payload-构造"><a href="#payload-构造" class="headerlink" title="payload 构造"></a>payload 构造</h2><p>（我本来的想法就是覆盖 crontab 进行提权，谁想到容器里面没有 crontab 文件。。。）<br>接下来就是构造 payload 问题，我们在自己本地创建一个 crontab 文件，然后写入一段测试内容<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718780182852-02d746eb-8333-4c82-983c-c10046c33368.png#averageHue=%2324292e&clientId=u012f7d3d-872b-4&from=paste&height=730&id=uca9949df&originHeight=1368&originWidth=2560&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=132798&status=done&style=none&taskId=u13ebba14-09d4-4f98-8b35-d21eda47bdb&title=&width=1365.3333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718780182852-02d746eb-8333-4c82-983c-c10046c33368.png#averageHue=%2324292e&clientId=u012f7d3d-872b-4&from=paste&height=730&id=uca9949df&originHeight=1368&originWidth=2560&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=132798&status=done&style=none&taskId=u13ebba14-09d4-4f98-8b35-d21eda47bdb&title=&width=1365.3333333333333" referrerpolicy="no-referrer" alt="image.png"><br>然后将其压缩为 zip 文件，用 010 editor 查看他的 16 进制字节<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718780240544-5adb5b8b-ac0c-4097-a0db-a72b01c75c74.png#averageHue=%2339382e&clientId=u012f7d3d-872b-4&from=paste&height=161&id=u31ca95cc&originHeight=301&originWidth=1044&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=32765&status=done&style=none&taskId=u4126012d-54b3-4e51-b157-423dc8f08c2&title=&width=556.8'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718780240544-5adb5b8b-ac0c-4097-a0db-a72b01c75c74.png#averageHue=%2339382e&clientId=u012f7d3d-872b-4&from=paste&height=161&id=u31ca95cc&originHeight=301&originWidth=1044&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=32765&status=done&style=none&taskId=u4126012d-54b3-4e51-b157-423dc8f08c2&title=&width=556.8" referrerpolicy="no-referrer" alt="image.png"><br>ctrl shift c 将 16 进制复制一下，丢入 cypherchef 进行进制转化，就是先将他转为原数据，然后再将源数据转为 10 进制即可<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718780278605-2c234261-9124-42c7-8e7e-e45496f8a42a.png#averageHue=%23dddcdc&clientId=u012f7d3d-872b-4&from=paste&height=512&id=u6516ac5d&originHeight=960&originWidth=2558&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=177959&status=done&style=none&taskId=u721830c6-6f37-42b0-a561-57816b81466&title=&width=1364.2666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718780278605-2c234261-9124-42c7-8e7e-e45496f8a42a.png#averageHue=%23dddcdc&clientId=u012f7d3d-872b-4&from=paste&height=512&id=u6516ac5d&originHeight=960&originWidth=2558&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=177959&status=done&style=none&taskId=u721830c6-6f37-42b0-a561-57816b81466&title=&width=1364.2666666666667" referrerpolicy="no-referrer" alt="image.png"><br>将这一串数据传入 bytes 数组作为最终的 payload 的直接部分<br><code>&#123;&quot;name&quot;:&quot;../../etc&quot;,&quot;repoName&quot;:&quot;local&quot;,&quot;version&quot;:&quot;1.11.2&quot;,&quot;extension&quot;:&quot;zip&quot;,&quot;packageFileAsBytes&quot;:[80,75,3,4,20,0,0,0,0,0,85,112,211,88,210,22,157,65,2,0,0,0,2,0,0,0,7,0,0,0,99,114,111,110,116,97,98,108,115,80,75,1,2,20,0,20,0,0,0,0,0,85,112,211,88,210,22,157,65,2,0,0,0,2,0,0,0,7,0,0,0,0,0,0,0,1,0,32,0,0,0,0,0,0,0,99,114,111,110,116,97,98,80,75,5,6,0,0,0,0,1,0,1,0,53,0,0,0,39,0,0,0,0,0]&#125;</code><br>写入成功，但是肯定如果要这么利用肯定是失败，因为它容器里面本身是不存在 crontab 的定时任务的&#x2F;(ㄒoㄒ)&#x2F;~~<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718780412721-71fe8bd3-2820-4f59-a9f0-949a291bad8b.png#averageHue=%23393e44&clientId=u012f7d3d-872b-4&from=paste&height=646&id=u737334a0&originHeight=1212&originWidth=2108&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=2305791&status=done&style=none&taskId=u8f6f92c7-57a0-4ced-88ff-d3a2ec59b91&title=&width=1124.2666666666667'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718780412721-71fe8bd3-2820-4f59-a9f0-949a291bad8b.png#averageHue=%23393e44&clientId=u012f7d3d-872b-4&from=paste&height=646&id=u737334a0&originHeight=1212&originWidth=2108&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=2305791&status=done&style=none&taskId=u8f6f92c7-57a0-4ced-88ff-d3a2ec59b91&title=&width=1124.2666666666667" referrerpolicy="no-referrer" alt="image.png"></p>
<h2 id="源码-diff-解析"><a href="#源码-diff-解析" class="headerlink" title="源码 diff 解析"></a>源码 diff 解析</h2><p>我们看看新版本怎么修的<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718780622315-dcd34b6a-9836-41df-8c6b-3785b159fcbb.png#averageHue=%23141c27&clientId=u012f7d3d-872b-4&from=paste&height=539&id=u878d6a11&originHeight=1011&originWidth=2511&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=326847&status=done&style=none&taskId=u9422f7c1-39f4-4650-8262-6d42405f941&title=&width=1339.2'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718780622315-dcd34b6a-9836-41df-8c6b-3785b159fcbb.png#averageHue=%23141c27&clientId=u012f7d3d-872b-4&from=paste&height=539&id=u878d6a11&originHeight=1011&originWidth=2511&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=326847&status=done&style=none&taskId=u9422f7c1-39f4-4650-8262-6d42405f941&title=&width=1339.2" referrerpolicy="no-referrer" alt="image.png"><br>首先是 validateUploadRequest 解析 uploadRequest 的步骤该到了 trycatch 块中，上半部分只留下了 repository 的寻找和定义。<br>然后是packageFile 的定义之前新增了一段 fullname 的定义，具体新的 fullname 拼接逻辑为：<br><code>name 参数``-``vesion 参数``.``zip 后缀</code><br>但其实后续依然还是<code>packageDir.getPath() + File.separator + fullName</code>作为 packageFile 参数，所以表面上逻辑还是没变的。<br>那具体的漏洞修复在哪呢？<br>来看到具体的<code>validateUploadRequest</code>方法，新增了那段随机生成的&#x2F;tmp&#x2F;xxxx 目录为参数传入了<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718781403192-437fd01f-b336-455e-8ec4-f974ae65e024.png#averageHue=%23151d29&clientId=u012f7d3d-872b-4&from=paste&height=532&id=ud9d98060&originHeight=997&originWidth=2452&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=335347&status=done&style=none&taskId=u6574c509-f09a-4d39-9450-5521685bebb&title=&width=1307.7333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718781403192-437fd01f-b336-455e-8ec4-f974ae65e024.png#averageHue=%23151d29&clientId=u012f7d3d-872b-4&from=paste&height=532&id=ud9d98060&originHeight=997&originWidth=2452&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=335347&status=done&style=none&taskId=u6574c509-f09a-4d39-9450-5521685bebb&title=&width=1307.7333333333333" referrerpolicy="no-referrer" alt="image.png"><br>重点是这一段<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718781527095-77fbb220-e84b-47e6-a52d-779213949f38.png#averageHue=%231b2d45&clientId=u012f7d3d-872b-4&from=paste&height=124&id=u8e7cf0c2&originHeight=233&originWidth=1235&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=50332&status=done&style=none&taskId=u2c49edc0-232c-4b06-8796-dfb414b3cb3&title=&width=658.6666666666666'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718781527095-77fbb220-e84b-47e6-a52d-779213949f38.png#averageHue=%231b2d45&clientId=u012f7d3d-872b-4&from=paste&height=124&id=u8e7cf0c2&originHeight=233&originWidth=1235&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=50332&status=done&style=none&taskId=u2c49edc0-232c-4b06-8796-dfb414b3cb3&title=&width=658.6666666666666" referrerpolicy="no-referrer" alt="image.png"></p>
<blockquote>
<p>构造出&#x2F;tmp&#x2F;xxxx&#x2F;test 目录<br>然后获取&#x2F;temp&#x2F;xxx&#x2F;中的绝对路径和&#x2F;tmp&#x2F;xxx&#x2F;test 的绝对路径（这里是拼接了 name 参数的绝对路径）<br>两者进行比较，如果两者不能够对应，就抛出错误</p>
</blockquote>
<p>其实就是一段很典型的检测相对路径的逻辑，我们看一下<code>getCanonicalPath()</code>方法定义<br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1718781988295-15334488-53da-4341-ae07-db3c2fdff40e.png#averageHue=%23f3f1ef&clientId=u012f7d3d-872b-4&from=paste&height=164&id=u2429b784&originHeight=307&originWidth=1057&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=101432&status=done&style=none&taskId=u1b56fe5b-2282-455c-b11b-3cb3fe5ad80&title=&width=563.7333333333333'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1718781988295-15334488-53da-4341-ae07-db3c2fdff40e.png#averageHue=%23f3f1ef&clientId=u012f7d3d-872b-4&from=paste&height=164&id=u2429b784&originHeight=307&originWidth=1057&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=101432&status=done&style=none&taskId=u1b56fe5b-2282-455c-b11b-3cb3fe5ad80&title=&width=563.7333333333333" referrerpolicy="no-referrer" alt="image.png"><br>所以暂时这条利用方式就利用不上了</p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>java 中存在文件写入的利用，我个人经验还是不足，可能存在更多的利用？</p>
<h1 id="RCE-尝试"><a href="#RCE-尝试" class="headerlink" title="RCE 尝试"></a>RCE 尝试</h1><p>在 drunkbaby 师傅的指导下决定学习一手 spirng 下的任意文件上传该如何利用，不然光看着这个任意文件上传点不能 RCE 都很难受。<br>首先确定 charset.jar 的目录<code>/layers/paketo-buildpacks_bellsoft-liberica/jre/lib</code><br class='item-img' data-src='https://cdn.nlark.com/yuque/0/2024/png/36078896/1719197194751-725486a7-48de-484e-bfb1-eb97a0fa43d6.png#averageHue=%2341454a&clientId=u6e22ab9e-de8f-4&from=paste&height=195&id=uc29b8eca&originHeight=366&originWidth=2079&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=847217&status=done&style=none&taskId=u84c5a538-786a-4333-a1bc-fa8020f2687&title=&width=1108.8'><img src="https://cdn.nlark.com/yuque/0/2024/png/36078896/1719197194751-725486a7-48de-484e-bfb1-eb97a0fa43d6.png#averageHue=%2341454a&clientId=u6e22ab9e-de8f-4&from=paste&height=195&id=uc29b8eca&originHeight=366&originWidth=2079&originalType=binary&ratio=1.875&rotation=0&showTitle=false&size=847217&status=done&style=none&taskId=u84c5a538-786a-4333-a1bc-fa8020f2687&title=&width=1108.8" referrerpolicy="no-referrer" alt="image.png"><br>然后构造 jar 包，这里我们环境选的是 JDK8 的镜像，但是现在问题一旦我写入 jre 目录时都会报错 409，之前任何目录可以，但是一到 Jre 目录就不行，这个问题也是迟迟没有解决，希望知道的师傅们看到了这篇文章能够帮忙解决一下我这个问题吗？感谢师傅们！</p>
<p>‍</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/post/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.html">← 下一篇 JDBC-Mysql反序列化</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/post/Memshell%E5%86%8D%E7%A0%94%E7%A9%B6.html">Memshell再研究之Tomcat 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/logo/D5B030D454D35C3F06BCF706E7F7948A.png" alt="Logo"></a><h1 id="Dr"><a href="/">stoocea</a></h1><div id="description"><p>time thicking away</p></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4"><span class="toc-number">2.</span> <span class="toc-text">影响范围</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">3.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%89%88%E6%9C%AC%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">4.1.</span> <span class="toc-text">漏洞版本源码解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#payload-%E6%9E%84%E9%80%A0"><span class="toc-number">4.2.</span> <span class="toc-text">payload 构造</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81-diff-%E8%A7%A3%E6%9E%90"><span class="toc-number">4.3.</span> <span class="toc-text">源码 diff 解析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-number">5.</span> <span class="toc-text">后记</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RCE-%E5%B0%9D%E8%AF%95"><span class="toc-number">6.</span> <span class="toc-text">RCE 尝试</span></a></li></ol></div></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> 主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas></body></html>